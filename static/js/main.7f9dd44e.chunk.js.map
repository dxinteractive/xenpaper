{"version":3,"sources":["../../xenpaper-ui/src/AppWrapper.tsx","../../xenpaper-ui/src/component/IconToggle.tsx","../../xenpaper-ui/src/component/Text.tsx","../../xenpaper-ui/src/component/Codearea.tsx","../../xenpaper-ui/src/component/ErrorMessage.tsx","../../xenpaper-ui/src/component/LoaderPane.tsx","../../xenpaper-ui/src/component/Char.tsx","../../xenpaper-ui/src/hooks/useAnimationFrame.ts","../../xenpaper-ui/src/layout/Layout.ts","../../xenpaper-ui/src/assets/xenpaper-logo-512x512.png","../../xenpaper-ui/src/Sidebars.tsx","../../mosc/src/mosc.ts","../../xenpaper-ui/src/PitchRuler.tsx","../../xenpaper-ui/src/data/grammar.ts","../../xenpaper-ui/src/data/grammar-to-chars.ts","../../xenpaper-ui/src/data/process-grammar.ts","../../xenpaper-ui/src/hooks/useHash.ts","../../xenpaper-ui/src/hooks/useWindowLoaded.ts","../../sound-engine-tonejs/src/sound-engine-tonejs.ts","../../xenpaper-ui/src/Xenpaper.tsx","reportWebVitals.ts","index.tsx"],"names":["GlobalStyle","createGlobalStyle","theme","colors","background","normal","light","text","placeholder","focus","highlights","delimiter","pitch","chord","setterGroup","setter","scaleGroup","scale","comment","commentStart","unknown","error","errorMessage","fonts","mono","copy","widths","sm","AppWrapper","props","children","rel","href","clipIn","keyframes","clipOut","colorIn","colorOut","Boundary","styled","button","hoverBackground","large","Icon","div","show","IconToggle","React","memo","state","paths","onClick","loaded","Object","keys","map","pathState","viewBox","d","index","Text","span","textStyle","typography","space","colorSystem","Codearea","value","onChange","charElements","freeze","content","color","style","fontStyle","Outer","fontSize","disabled","Inner","Textarea","autoCapitalize","autoComplete","autoCorrect","spellCheck","Highlight","aria-hidden","textarea","pre","fadeIn","ErrorMessage","LoaderPane","height","css","Char","ch","charData","soundEngine","useState","active","setActive","cb","deps","frame","useRef","last","performance","now","init","animate","time","current","delta","requestAnimationFrame","useEffect","cancelAnimationFrame","useAnimationFrame","playing","position","playTime","start","end","undefined","CharSpan","className","styledProps","compose","layout","flexbox","grid","border","Box","Flex","Flink","a","Footer","px","py","as","target","SidebarInfo","onSetTune","setSidebar","pad","H","B","pt","Ex","tune","C","display","SidebarShare","url","urlEmbed","iframeCode","copiedLink","setCopiedLink","copiedIframe","setCopiedIframe","ShareInput","flexShrink","ml","onCopy","TryButton","EmbedIframe","src","frameBorder","iframe","input","attrs","readOnly","Sidebar","title","desc","TextPanel","width","flexDirection","minHeight","top","right","pr","cross","none","LogoArea","Hsize","lineHeight","alignItems","mr","alt","logo","Logo","p","flexGrow","h2","Eg","E","centsToRatio","cents","octave","octaveDivisionToRatio","steps","stepsInOctave","octaveSize","Math","pow","ratioToOctaveDivision","ratio","log","sortByTime","items","slice","sort","b","tempoTimeToMs","bpm1","bpm2","duration","u","v","timeToMs","tempoChanges","push","bpm","bpmEnd","ms","tempoItems","filter","item","type","forEach","tempo","all","lastChange","length","nextTempo","lerp","tempoChange","i","findTempoRangeForTime","SoundEngine","scoreMs","events","Set","note","loop","params","this","callback","add","delete","useStrictMode","ReactKonva","Stage","Layer","Group","Rect","Line","hzToPan","hz","log2","panToHz","pan","pxToPan","viewPan","viewZoom","hzInRange","lowHz","highHz","PitchRuler","rulerState","onClear","useCallback","set","draft","notes","clear","render","form","Label","useCheckbox","Button","PitchRulerCanvas","useDimensions","dimensionsRef","useValue","getY","panToPx","dragStartState","dragging","setDragging","handleMouseDown","evt","preventDefault","startPan","startZoom","startDrag","clientY","handleMouseMove","dragState","nowDrag","onMouseUp","window","addEventListener","removeEventListener","handleWheel","deltaY","handleTouchStart","handleTouchMove","visibleRange","rootHz","plots","notesActive","noteSetWidth","backgroundColor","cursor","ref","onMouseDown","onMouseMove","onWheel","onTouchStart","onTouchMove","collect","Array","from","values","x","plot","NoteSet","visibleNotes","hsl","label","matched","match","floor","Number","getColorFromLabel","y","stroke","strokeWidth","points","fill","align","ROOT_GRID_POSITIONS","RootGrid","lines","abs","dash","CENT_GRID_POSITIONS","CentsGrid","node","fn","Node","meta","pos","sumLen","nodes","reduce","len","Semicolon","Colon","BarLine","Whitespace","OctaveModifier","chars","split","PitchCents","PitchOctaveDivision","numerator","denominator","slash","octaveDenom","PitchOctaveDivision2","PitchRatio","PitchDegree","degree","PitchHz","Pitch","All","Optional","Any","args","PitchGroup","Star","elements","Hold","replace","Tail","Rest","Note","tail","RatioChordPitch","RatioChordPitchGroup","Chord","pitches","RatioChord","EdoScale","divisions","ScaleOctaveMarker","PitchGroupScalePrefix","prefix","PitchGroupScale","isArray","pitchGroupScalePrefix","scaleOctaveMarker","RatioChordScale","Scale","SetScale","SetRoot","SetBpmValue","SetBpm","SetBmsValue","bms","SetBms","SetSubdivisionValue","subdivision","SetSubdivision","SetOscValue","osc","SetOsc","SetEnvValue","s","r","SetEnv","SetRulerRange","low","high","SetRulerPlot","SetRuler","Setter","SetterGroup","setters","Comment","Sequence","ParamEmbed","Param","ParamGroup","XenpaperGrammar","parts","paramGroup","find","part","sequence","parser","Parser","colorMap","Map","extract","data","parent","withinTime","get","key","grammarToChars","limit","name","min","max","Error","pitchToRatio","context","octaveMulti","pitchDegreeToRatio","edoToRatios","edoSize","ratios","pitchDegreeWrap","wrappedDegree","pitchToHz","tailToTime","timeEnd","ratioToCentsLabel","ratioToCents","ratioWrap","toFixed","pitchToLabel","centsLabel","scaleLabels","edoToLabels","labels","ENV_VALUES","times","chordToMosc","timeProps","arr","pitchTypes","firstRatioPitch","ratioPitchTypes","concat","rulerStateCaptureRootHz","initial","processGrammar","grammar","grammarSequence","INITIAL_ENV","moscItems","initialRulerState","noteToMosc","rest","setterToMosc","newPlot","msEnd","setterToRulerState","setScale","filteredPitches","degreePitches","pop","thisTimeToMs","score","lengthTime","hashify","newHash","encodeURIComponent","reverseString","str","reverse","join","useHash","initialHash","hash","decodeURIComponent","unhashify","location","substr","localStorage","getItem","setHash","onHashChange","_setHash","newHashEncoded","history","replaceState","setItem","windowLoadPromise","Promise","resolve","handleLoad","flatMap","mapper","out","OSC_PARTIAL_SUFFIXES","OSC_TYPES_EXPANDED","base","OSC_TYPES","suffix","SoundEngineTonejs","_started","_endMs","_loopEndMs","_activeNoteEvents","synth","Tone","oscillator","volume","envelope","attack","sustain","decay","release","chain","seconds","onEnd","releaseAll","noteMs","_triggerEvent","on","stop","startMs","endMs","setLoopActive","setLoopStart","setLoopEnd","loopStart","loopEnd","cancel","schedule","triggerAttackRelease","paramMs","includes","setAutoFreeze","enableMapSet","parse","unparsed","parsed","e","console","message","XenpaperGrammarParser","param","lengthMs","scoreToMs","setScore","errorAt","lineNumber","colNumber","lineCount","colCount","getMsAtLine","line","counted","tuneSplit","chr","PLAY_PATHS","paused","Xenpaper","setLoaded","document","ready","useWindowLoaded","XenpaperApp","tuneForm","useDendriform","embed","startsWith","useDerive","newValue","hashified","branch","useChange","parsedForm","selectedLine","looping","lowPan","highPan","useRulerState","onNote","id","handleSetPlayback","play","gotoMs","pause","handleTogglePlayback","handleToggleLoop","event","ctrlKey","metaKey","keyCode","shiftKey","redo","undo","sidebarState","toggleSidebarInfo","toggleSidebarShare","toggleSidebarRuler","codepaneContainerProps","playPause","undoRedo","useHistory","canUndo","canRedo","SideButton","sidebarToggles","sidebar","code","CodePanel","htmlTitle","SetHtmlTitle","openOnXenpaper","EditOnXenpaperButton","EmbedLayout","NormalLayout","Toolbar","mt","mb","Hr","my","pl","overflow","inputProps","useInput","tuneChars","charDataArray","hasPlayStartButtons","some","playStartLine","createPlayStart","PlayStart","stopPropagation","Helmet","property","multiline","reportWebVitals","onPerfEntry","Function","then","getCLS","getFID","getFCP","getLCP","getTTFB","ReactDOM","StrictMode","getElementById"],"mappings":"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","file":"static/js/main.7f9dd44e.chunk.js","sourcesContent":["import React from 'react';\n\nimport {ThemeProvider, createGlobalStyle} from 'styled-components';\nimport type {HighlightColor} from './data/grammar-to-chars';\n\nconst GlobalStyle = createGlobalStyle`\n    html, body, div, span, applet, object, iframe,\n    h1, h2, h3, h4, h5, h6, p, blockquote, pre,\n    a, abbr, acronym, address, big, cite, code,\n    del, dfn, em, img, ins, kbd, q, s, samp,\n    small, strike, strong, sub, sup, tt, var,\n    b, u, i, center,\n    dl, dt, dd, ol, ul, li,\n    fieldset, form, label, legend,\n    table, caption, tbody, tfoot, thead, tr, th, td,\n    article, aside, canvas, details, embed,\n    figure, figcaption, footer, header, hgroup,\n    menu, nav, output, ruby, section, summary,\n    time, mark, audio, video {\n        margin: 0;\n        padding: 0;\n        border: 0;\n        font-size: 100%;\n        font: inherit;\n        vertical-align: baseline;\n    }\n    article, aside, details, figcaption, figure,\n    footer, header, hgroup, menu, nav, section {\n        display: block;\n    }\n    body {\n        line-height: 1;\n    }\n    ol, ul {\n        list-style: none;\n    }\n    blockquote, q {\n        quotes: none;\n    }\n    blockquote:before, blockquote:after,\n    q:before, q:after {\n        content: '';\n        content: none;\n    }\n    table {\n        border-collapse: collapse;\n        border-spacing: 0;\n    }\n    * {\n        box-sizing: border-box;\n    }\n\n    html {\n        font-family: 'DM Mono', sans-serif;\n        height: 100%;\n        line-height: 1.5em;\n        position: relative;\n        -webkit-font-smoothing: antialiased;\n        -moz-osx-font-smoothing: grayscale;\n        background-color: #0e151b;\n        color: #ffffff;\n        font-size: 16px;\n    }\n\n    body {\n        font-weight: 400;\n        height: 100%;\n        line-height: 1.5em;\n        overflow-x: hidden;\n        text-rendering: optimizelegibility;\n\n        &[aria-hidden='true'] {\n            overflow: hidden;\n        }\n    }\n\n    #root {\n        height: 100%;\n    }\n`;\n\nexport type Colors = {\n    background: {\n        normal: string;\n        light: string;\n    };\n    text: {\n        placeholder: string;\n    };\n    focus: string;\n    highlights: {\n        [k in HighlightColor]: string;\n    }\n};\n\nconst colors: Colors = {\n    background: {\n        normal: '#0e151b',\n        light: '#18232d'\n    },\n    text: {\n        placeholder: '#198c8c'\n    },\n    focus: '#115d5d',\n    highlights: {\n        delimiter: '#198c8c',\n        pitch: '#22cece',\n        chord: '#22cece',\n        setterGroup: '#821361',\n        setter: '#d61ba4',\n        scaleGroup: '#94472f',\n        scale: '#ff541e',\n        comment: '#ffffff',\n        commentStart: '#198c8c',\n        unknown: '#a490b3',\n        error: '#cc0000',\n        errorMessage: '#cc0000'\n    }\n};\n\nconst fonts = {\n    mono: `'DM Mono', sans-serif`,\n    copy: `'Nunito', sans-serif`\n};\n\nconst widths = {\n    sm: '640px'\n};\n\nconst theme = {\n    colors,\n    fonts,\n    widths\n};\n\ntype Props = {\n    children: React.ReactNode\n};\n\nexport function AppWrapper(props: Props): React.ReactElement {\n    const {children} = props;\n    return <>\n        <link rel=\"preconnect\" href=\"https://fonts.gstatic.com\" />\n        <link href=\"https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,400;0,500;1,400&display=swap\" rel=\"stylesheet\" />\n        <link href=\"https://fonts.googleapis.com/css2?family=Nunito:wght@300;400&display=swap\" rel=\"stylesheet\" />\n        <ThemeProvider theme={theme}>\n            <GlobalStyle />\n            {children}\n        </ThemeProvider>\n    </>;\n}\n","import React from 'react';\nimport styled, {keyframes} from 'styled-components';\n\nconst clipIn = keyframes`\n  0% {\n    clip-path: polygon(0% 0%, 0% 0%, 100% 100%, 100% 100%, 100% 100%, 0% 0%);\n  }\n\n  20% {\n    clip-path: polygon(0% 0%, 0% 0%, 100% 100%, 100% 100%, 100% 100%, 0% 0%);\n  }\n\n  100% {\n    clip-path: polygon(0% 0%, 100% 0%, 100% 0%, 100% 100%, 0% 100%, 0% 100%);\n  }\n`;\n\nconst clipOut = keyframes`\n  0% {\n    clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 0% 100%, 0% 0%, 100% 100%, 100% 100%, 100% 100%, 0% 0%);\n  }\n\n  100% {\n    clip-path: polygon(100% 0%, 100% 0%, 100% 100%, 0% 100%, 0% 100%, 0% 100%, 100% 100%, 100% 0%, 100% 0%);\n  }\n`;\n\nconst colorIn = keyframes`\n  0% {\n    fill: #115d5d;\n  }\n\n  20% {\n    fill: #115d5d;\n  }\n\n  100% {\n    fill: #fff;\n  }\n`;\n\nconst colorOut = keyframes`\n  0% {\n    fill: #fff;\n  }\n\n  100% {\n    fill: #115d5d;\n  }\n`;\n\ntype ButtonProps = {\n    onClick: () => any;\n    hoverBackground?: boolean;\n    large: boolean;\n};\n\nconst Boundary = styled.button<ButtonProps>`\n    border: none;\n    display: block;\n    height: 3rem;\n    width: 3rem;\n    padding: 1rem .5rem;\n    cursor: pointer;\n    background-color: rgba(0,0,0,0);\n    position: relative;\n    outline: none;\n\n    transition: border-color .2s ease-out;\n    border-left: 3px solid transparent;\n\n    &:focus, &:active {\n        border-left: 3px solid ${props => props.theme.colors.focus};\n    }\n\n    ${props => props.hoverBackground ? `&:hover {\n        background-color: ${props.theme.colors.background.light};\n    }` : ``}\n\n    ${props => props.large && `@media all and (min-width: ${props.theme.widths.sm}) {\n        height: 4rem;\n        width: 5rem;\n        padding: 1rem;\n    }`}\n`;\n\ntype IconProps = {\n    show: boolean;\n    large: boolean;\n};\n\nconst Icon = styled.div<IconProps>`\n    position: absolute;\n    top: 0;\n    left: 0;\n    height: 3rem;\n    width: 2rem;\n    padding: 1rem .5rem;\n    animation: ${props => props.show ? clipIn : clipOut} .3s ease-out forwards;\n    margin-left: .5rem;\n\n    path {\n        fill: #fff;\n        animation: ${props => props.show ? colorIn : colorOut} .3s ease-out forwards;\n    }\n\n    opacity: .9;\n    &:hover {\n        opacity: 1;\n    }\n\n    ${props => props.large && `@media all and (min-width: ${props.theme.widths.sm}) {\n        height: 4rem;\n        width: 4rem;\n        padding: 1rem;\n    }`}\n`;\n\ntype Props = {\n    state: string;\n    paths: {[key: string]: string[]};\n    onClick?: (state: string) => any;\n    loaded?: boolean;\n    hoverBackground?: boolean;\n    large?: boolean;\n};\n\n// eslint-disable-next-line react/display-name\nexport const IconToggle: React.FunctionComponent<Props> = React.memo((props: Props): React.ReactElement => {\n    const {state, paths, onClick, loaded = true, hoverBackground = false, large = false} = props;\n\n    return <Boundary onClick={() => onClick && onClick(state)} hoverBackground={hoverBackground} large={large}>\n        {Object.keys(paths).map((pathState: string) => {\n            return <Icon key={pathState} show={loaded && state === pathState} large={large}>\n                <svg viewBox=\"0 0 12 12\">\n                    {paths[pathState].map((d, index) => <path key={index} d={d} />)}\n                </svg>\n            </Icon>;\n        })}\n    </Boundary>;\n});\n\n","import styled from 'styled-components';\nimport {space, textStyle, typography, color as colorSystem} from 'styled-system';\n\nexport const Text = styled.span`\n    ${textStyle}\n    ${typography}\n    ${space}\n    ${colorSystem}\n`;\n","import React from 'react';\nimport styled from 'styled-components';\nimport {Text} from '../component/Text';\nimport {textStyle, typography} from 'styled-system';\n\ntype Props = {\n    value: string;\n    onChange: (e: React.ChangeEvent<HTMLTextAreaElement>) => void;\n    charElements: React.ReactNode;\n    freeze: boolean;\n};\n\nexport const Codearea = (props: Props): React.ReactElement => {\n    const {value, onChange, charElements, freeze} = props;\n\n    const content = value === ''\n        ? <Text color=\"text.placeholder\" style={{fontStyle: \"italic\"}}>\n            Type your tune here\n            <br /><br />\n        </Text>\n        : <>{charElements}<br /><br /></>;\n\n    return <Outer fontSize={[\"1.1rem\", \"1.4rem\"]} disabled={freeze}>\n        <Inner>\n            <Textarea\n                value={value}\n                onChange={onChange}\n                autoCapitalize=\"off\"\n                autoComplete=\"off\"\n                autoCorrect=\"off\"\n                spellCheck=\"false\"\n                disabled={freeze}\n            />\n            <Highlight aria-hidden=\"true\" freeze={freeze}>{content}</Highlight>\n        </Inner>\n    </Outer>;\n};\n\ntype OuterProps = {\n    fontSize: unknown;\n    disabled: boolean;\n};\n\nconst Outer = styled.div<OuterProps>`\n    height: 100%;\n    overflow: auto;\n    ${textStyle}\n    ${typography}\n    line-height: 1.4em;\n    position: relative;\n\n    &:before {\n        content: \"\";\n        display: block;\n        width: 3px;\n        height: 4rem;\n        background-color: transparent;\n        transition: background-color .2s ease-out;\n        position: absolute;\n        top: 12px;\n    }\n\n    &:focus-within {\n        &:before {\n            background-color: ${props => props.theme.colors.focus};\n        }\n    }\n\n    ${props => props.disabled ? `\n        cursor: default;\n        user-select: none;\n        pointer-events: none;\n    ` : ''}\n`;\n\nconst Inner = styled.div`\n    position: relative;\n    text-align: left;\n    box-sizing: border-box;\n    padding: 0px;\n    overflow: hidden;\n    font-variant-ligatures: common-ligatures;\n    min-height: 100%;\n`;\n\nconst Textarea = styled.textarea`\n    margin: 0;\n    border: 0;\n    background: none;\n    box-sizing: inherit;\n    display: inherit;\n    font-family: inherit;\n    font-size: inherit;\n    font-style: inherit;\n    font-variant-ligatures: inherit;\n    font-weight: inherit;\n    letter-spacing: inherit;\n    line-height: inherit;\n    tab-size: inherit;\n    text-indent: inherit;\n    text-rendering: inherit;\n    text-transform: inherit;\n    white-space: pre-wrap;\n    word-break: keep-all;\n    overflow-wrap: break-word;\n    position: absolute;\n    top: 0;\n    left: 0;\n    height: 100%;\n    width: 100%;\n    resize: none;\n    color: inherit;\n    overflow: hidden;\n    -webkit-text-fill-color: transparent;\n    -webkit-font-smoothing: antialiased;\n    padding: 1rem 1rem 1rem 2rem;\n    outline: 0;\n\n    &::selection {\n        background: #22cece;\n    }\n\n    &:disabled {\n        user-select: none;\n        opacity: 0;\n    }\n`;\n\ntype HighlightProps = {\n    freeze: boolean;\n};\n\nconst Highlight = styled.pre<HighlightProps>`\n    margin: 0px;\n    border: 0px;\n    background: none;\n    box-sizing: inherit;\n    display: inherit;\n    font-family: inherit;\n    font-size: inherit;\n    font-style: inherit;\n    font-variant-ligatures: inherit;\n    font-weight: inherit;\n    letter-spacing: inherit;\n    line-height: inherit;\n    tab-size: inherit;\n    text-indent: inherit;\n    text-rendering: inherit;\n    text-transform: inherit;\n    white-space: pre-wrap;\n    word-break: keep-all;\n    overflow-wrap: break-word;\n    position: relative;\n    pointer-events: ${props => props.freeze ? 'auto' : 'none'};\n    padding: 1rem 1rem 1rem 2rem;\n    user-select: none;\n`;\n","import styled, {keyframes} from 'styled-components';\n\nconst fadeIn = keyframes`\n  0% {\n    opacity: 0;\n    top: 1rem;\n  }\n\n  85% {\n    opacity: 0;\n    top: 1rem;\n  }\n\n  100% {\n    opacity: 1;\n    top: 0rem;\n  }\n`;\n\nexport const ErrorMessage = styled.div`\n    position: relative;\n    top: 0;\n    padding-left: 1rem;\n    animation: ${fadeIn} .7s ease-out forwards;\n`;\n","import type React from 'react';\nimport styled, {css, keyframes} from 'styled-components';\n\nconst fadeIn = keyframes`\n  from {\n    opacity: 0;\n  }\n\n  to {\n    opacity: 1;\n  }\n`;\n\ninterface Props {\n    readonly loaded: boolean;\n    readonly height: string;\n    readonly children: React.ReactNode;\n}\n\nexport const LoaderPane = styled.div<Props>`\n    height: ${props => props.height};\n    opacity: 0;\n    ${props => props.loaded ? css`animation: ${fadeIn} .1s ease-out forwards;` : ``}\n`;\n","import React, {useState} from 'react';\nimport styled from 'styled-components';\nimport type {HighlightColor, CharData} from '../data/grammar-to-chars';\nimport {useAnimationFrame} from '../hooks/useAnimationFrame';\nimport type {SoundEngine} from '@xenpaper/mosc';\n\ntype CharProps = {\n    ch: string;\n    charData?: CharData;\n    soundEngine: SoundEngine;\n};\n\nexport const Char = React.memo(function Char(props: CharProps): React.ReactElement {\n    const {ch, charData, soundEngine} = props;\n\n    const [active, setActive] = useState<boolean>(false);\n\n    useAnimationFrame(() => {\n        const time = soundEngine.playing() ? soundEngine.position() : -1;\n        const [start, end] = charData?.playTime ?? [];\n\n        const active = time !== -1\n            && start !== undefined\n            && end !== undefined\n            && start <= time\n            && end > time;\n\n        setActive(active);\n    }, [ch, charData]);\n\n    return <CharSpan className={active ? 'active' : ''} color={charData?.color}>{ch}</CharSpan>;\n});\n\ntype CharSpanProps = {\n    readonly color?: HighlightColor;\n    readonly children: React.ReactNode;\n};\n\nconst CharSpan = styled.span<CharSpanProps>`\n    color: ${props => props.theme.colors.highlights[props.color || 'unknown']};\n    transition: color 0.2s ${props => props.color === 'error' ? '0.5s' : '0s'} ease-out;\n\n    &.active {\n        transition: color 0s 0s linear;\n        color: #fff;\n    }\n`;\n","import {useEffect, useRef} from \"react\";\n\ntype Callback = (time: number, delta: number) => any;\n\nexport const useAnimationFrame = (cb: Callback, deps: any[]): void => {\n    const frame = useRef<number>(0);\n    const last = useRef<number>(performance.now());\n    const init = useRef<number>(performance.now());\n\n    const animate = () => {\n        const now = performance.now();\n        const time = (now - init.current) / 1000;\n        const delta = (now - last.current) / 1000;\n        cb(time, delta);\n        last.current = now;\n        frame.current = requestAnimationFrame(animate);\n    };\n\n    useEffect(() => {\n        frame.current = requestAnimationFrame(animate);\n        return () => cancelAnimationFrame(frame.current);\n    }, deps);\n};\n","import styled from 'styled-components';\n\nimport {\n    space,\n    color,\n    layout,\n    flexbox,\n    grid,\n    background,\n    border,\n    position,\n    compose\n} from 'styled-system';\n\nconst styledProps = compose(\n    space,\n    color,\n    layout,\n    flexbox,\n    grid,\n    background,\n    border,\n    position\n);\n\nexport const Box = styled.div<any>`\n    ${styledProps}\n`;\n\nexport const Flex = styled.div<any>`\n    display: flex;\n    ${styledProps}\n`;\n","export default __webpack_public_path__ + \"static/media/xenpaper-logo-512x512.19f23cff.png\";","import React, {useState} from 'react';\nimport {IconToggle} from './component/IconToggle';\nimport {Text} from './component/Text';\nimport {Box, Flex} from './layout/Layout';\nimport styled from 'styled-components';\nimport {textStyle, typography} from 'styled-system';\n// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n// @ts-ignore\nimport logo from './assets/xenpaper-logo-512x512.png';\n\nimport type {SidebarState} from './Xenpaper';\nimport {CopyToClipboard} from 'react-copy-to-clipboard';\n\nconst Flink = styled.a`\n    color: ${props => props.theme.colors.highlights.unknown};\n    text-decoration: none;\n    font-style: normal;\n\n    &:hover, &:focus {\n        color: #fff;\n        text-decoration: underline;\n    }\n\n    &:active {\n        color: #fff;\n    }\n`;\n\nexport const Footer = styled(props => {\n    return <Box px={3} py={2} {...props}>\n        <Text as=\"div\" color=\"text.placeholder\">\n            <Flink href=\"#\">Xenpaper</Flink> <Flink target=\"_blank\" href=\"https://github.com/dxinteractive/xenpaper/releases\">(v1.6.0)</Flink> is made by <Flink target=\"_blank\" href=\"https://damienclarke.me\">Damien Clarke</Flink> using <Flink target=\"_blank\" href=\"https://www.typescriptlang.org/\">typescript</Flink>, <Flink target=\"_blank\" href=\"https://reactjs.org/\">react</Flink>, <Flink target=\"_blank\" href=\"https://tonejs.github.io/\">tonejs</Flink>, <Flink target=\"_blank\" href=\"https://github.com/dmaevsky/rd-parse\">rd-parse</Flink>, <Flink target=\"_blank\" href=\"https://styled-components.com/\">styled-components</Flink> and <Flink target=\"_blank\" href=\"https://dendriform.xyz\">dendriform</Flink>.\n        </Text>\n    </Box>;\n})`\n    font-size: .9rem;\n    font-family: ${props => props.theme.fonts.copy};\n`;\n\ntype SidebarInfoProps = {\n    onSetTune: (tune: string) => void;\n    setSidebar: (open: SidebarState) => void;\n};\n\nexport const SidebarInfo = (props: SidebarInfoProps): React.ReactElement => {\n    const {onSetTune, setSidebar} = props;\n    return <Sidebar setSidebar={setSidebar} pad>\n        <H>How it works</H>\n        <B>Create tunes by typing in the text area. Press play to hear what you{\"'\"}ve written.{/*, or press <C>Ctrl / Cmd + Enter</C>.*/}</B>\n        <Box pt={4}><H>Notes</H></Box>\n        <B>Typing a number will create a note. Notes can be separated by spaces or commas.\n            <Ex tune=\"0 4 7 12\" color=\"pitch\" onSetTune={onSetTune} />\n        </B>\n        <B>Notes can be held for longer with hyphens <C>---</C>, and rests can be added with dots <C>...</C>.\n            <Ex tune=\"0.2.3...3-2-0--.\" color=\"pitch\" onSetTune={onSetTune} />\n        </B>\n        <B>Spaces, new lines and bars <C>|</C> can be placed anywhere between notes. Bars can also be placed during a note.\n            <Ex tune=\"0 8 7-|0 8 7-|-5 4--\" color=\"pitch\" onSetTune={onSetTune} />\n        </B>\n        <B>Notes can be written in many ways.\n            <br />- as scale degrees starting from zero <C>0,2,4</C>,\n            <br />- as ratios <C>3/2,5/4,1/1</C>,\n            <br />- as cents <C>702c</C>,\n            <br />- as divisions of an octave <C>11{'\\\\'}19</C>,\n            <br />- as divisions of an octave with a specific size (e.g. 3) <C>5{'\\\\'}13o3</C>\n            <br />- as cycles per second <C>432Hz</C>\n            <Ex tune={\"0 7 1/1 3/2 0c 702c\\n0\\\\19 11\\\\19 220Hz 330Hz\"} color=\"pitch\" onSetTune={onSetTune} />\n        </B>\n        <B>Notes can be shifted up or down octaves. <C>{\"'\"}</C> shifts the following note up 1 octave, <C>\"</C> shifts the following note up 2 octaves, and <C>`</C> shifts the following note down an octave.\n            <Ex tune={\"0-3-'0-'3-\\\"0-'\\\"0-`0-``0-\"} color=\"pitch\" onSetTune={onSetTune} />\n        </B>\n        <B>Chords can be played by using <C>[</C> and <C>]</C> around a comma-separated pitches.\n            <Ex tune=\"[3,7]-[5,8]-[0,3,7]--.[1/1,6/5,3/2]--.\" color=\"pitch\" onSetTune={onSetTune} />\n        </B>\n        <B>Chords can also be played using colon-notated ratios <C>4:5:6</C>\n            <Ex tune=\"10:12:15---\" color=\"pitch\" onSetTune={onSetTune} />\n        </B>\n        <Box pt={4}><H>Comments</H></Box>\n        <B>Comments can be added using <C>#</C> at the start of a line\n            <Ex tune={\"# a 7th chord\\n[0,4,7,10]--..\\n\\n# a harmonic 7th chord\\n4:5:6:7--..\"} color=\"pitch\" onSetTune={onSetTune} />\n        </B>\n        <Box pt={4}><H>Scales</H></Box>\n        <B>The scale can be changed at any time. A scale is denoted by <C>{'{'}</C> and <C>{'}'}</C>. These dictate what pitches any subsequent scale degrees correspond to. The default is 12 equal divisons of the octave <C>12edo</C>.\n            <Ex tune=\"[0,4,7]--- {31edo}[0,10,18]---\" color=\"pitch\" onSetTune={onSetTune} />\n        </B>\n        <B>Equal division octave size can be changed by replacing the {'\"o\"'} with a number or fraction <C>13ed3</C>.\n            <Ex tune=\"{13ed3}0 1 2 3 4\" color=\"pitch\" onSetTune={onSetTune} />\n        </B>\n        <B>Scales can be comprised of individual pitches.\n            <Ex tune={\"{1/1 9/8 5/4 4/3 3/2 5/3 15/8}\\n0 1 2 3 4 5 6 7-\"} color=\"pitch\" onSetTune={onSetTune} />\n        </B>\n        <B>Scales comprised of individual pitches can also set their octave size using <C>{\"'\"}</C> after the last pitch. Defaults to <C>2/1</C>\n            <Ex tune={\"{1/1 5/4 4/3 3/2'}\\n0 1 2 3 4 5 6 7 8-\"} color=\"pitch\" onSetTune={onSetTune} />\n        </B>\n        <B>Scales can use colon-notated ratios\n            <Ex tune={\"{12:14:16:18:21}\\n0 1 2 3 4 5 6 7-\"} color=\"pitch\" onSetTune={onSetTune} />\n        </B>\n        <B>Scales can also reference the scale degrees at the moment they are encountered. This can be useful for creating a subset of a scale.\n            <Ex tune={\"{19edo}{0 3 6 8 11 14 17}\\n0 1 2 3 4 5 6 7-\"} color=\"pitch\" onSetTune={onSetTune} />\n        </B>\n        <B>Modes can be set using <C>{'{m'}</C> and <C>{'}'}</C>.\n            <Ex tune={\"{12edo}{m2 1 2 2 1 2 2}\\n0 1 2 3 4 5 6 7-\"} color=\"pitch\" onSetTune={onSetTune} />\n        </B>\n        <B>All pitch values other than cycles-per-second are relative to a root note. This can be changed with <C>{'{r...}'}</C>. It can be given any pitch value to use as the new root. It defaults to <C>{'{r440Hz}'}</C>\n            <Ex tune={\"0 2 4-{r432Hz}0 2 4-\"} color=\"pitch\" onSetTune={onSetTune} />\n        </B>\n        <B>As each change to the root pitch is relative to the current root, multiple roots can be chained after each other\n            <Ex tune={\"4 0-{r2}4 0-{r2}4 0-\"} color=\"pitch\" onSetTune={onSetTune} />\n        </B>\n        <B>This can also be used to switch octaves for a time.\n            <Ex tune={\"4 0-{r'0}4 0-{r`0}4 0-\"} color=\"pitch\" onSetTune={onSetTune} />\n        </B>\n        <Box pt={4}><H>Setters</H></Box>\n        <B>Setters are a type of statement that are used to set various parameters as a tune progresses, such as <C>(bpm:100)</C> or <C>(osc:sine)</C>. A setter is denoted by <C>(</C> and <C>)</C>, and can be placed anywhere between notes or on new lines. Multiple setters can be combined into a single statement using a semicolon <C>(bpm:100; osc:sine)</C></B>\n\n        <Box pt={4}><H>Timing</H></Box>\n        <B>Tempo can be changed using the tempo setter <C>(bpm:...)</C>. Defaults to <C>(bpm:120)</C>\n            <Ex tune=\"(bpm:200)7 5 4 2 0...\" color=\"pitch\" onSetTune={onSetTune} />\n        </B>\n        <B>Tempo can also be set using milliseconds per beat <C>(bms:...)</C>.\n            <Ex tune=\"(bms:1000)3 2 0\" color=\"pitch\" onSetTune={onSetTune} />\n        </B>\n        <B>Divisions of the beat can be set using the division setter <C>(div:...)</C>. These can also be shortened to <C>(...)</C>, like <C>(4)</C> or <C>(1/4)</C>. Defaults to 2 divisions per beat (eighth notes) <C>(div:2)</C>\n            <Ex tune=\"0 2 3 7(3)0 2 3 7(4)0 2 3 7(1/2)0 2 3 7\" color=\"pitch\" onSetTune={onSetTune} />\n        </B>\n        <Box pt={4}><H>Sound</H></Box>\n        <B>The oscillator can be changed using the oscillator setter <C>(osc:...)</C>. Defaults to <C>(osc:triangle)</C>\n            <Ex tune={\"(osc:sine)0 4 7.\\n(osc:sawtooth)0 4 7.\\n(osc:square)0 4 7.\"} color=\"pitch\" onSetTune={onSetTune} />\n        </B>\n        <B>Valid values are <C>sine</C>, <C>sawtooth</C>, <C>square</C> and <C>triangle</C>. Any of these can be optionally prefixed with <C>fm</C>, <C>am</C>or <C>fat</C>. Any of these can be suffixed with an integer from <C>1</C> to <C>32</C> to indicate the number of partials to use.\n            <Ex tune={\"(osc:fmsine)0 4 7.\\n(osc:fatsquare)0 4 7.\\n(osc:sawtooth5)0 4 7.\"} color=\"pitch\" onSetTune={onSetTune} />\n        </B>\n        <B>The envelope can be changed using the envelope setter <C>(env:...)</C>. This accepts 4 digits corresponding to attack, decay, sustain and release, where <C>0</C> is fast / small, and <C>9</C> is slow / big. Defaults to <C>(env:2856)</C>\n            <Ex tune={\"(env:0158)0-.....\\n(env:6860)0---...\"} color=\"pitch\" onSetTune={onSetTune} />\n        </B>\n        <B>All oscillator and envelope options are made possible by <Flink target=\"_blank\" href=\"https://tonejs.github.io/\">tonejs</Flink>.</B>\n        <Box pt={4}><H>Ruler</H></Box>\n        <B>The Ruler button displays a pitch ruler. Played notes will appear on it. Click and drag to pan, use the mouse wheel to zoom. Touch devices are not yet supported.</B>\n        <B>The current scale can be plotted by calling <C>(plot)</C>. Calling it multiple times will render multiple scales. To see this demo, you must click Ruler after you click Demo.\n            <Ex tune={\"(plot){19edo}(plot)\"} color=\"pitch\" onSetTune={onSetTune} />\n        </B>\n        <Box pt={4}><H>Bugs and future features</H></Box>\n        <B>Find anything broken, or have some ideas you want to share? Visit the <Flink target=\"_blank\" href=\"https://github.com/dxinteractive/xenpaper/issues\">issue tracker on github</Flink> to file bugs or discuss future features.</B>\n        <Box display={['block', 'block', 'none']} pt={4}>\n            <Footer />\n        </Box>\n    </Sidebar>;\n};\n\ntype SidebarShareProps = {\n    setSidebar: (open: SidebarState) => void;\n    url: string;\n    urlEmbed: string;\n};\n\nexport const SidebarShare = (props: SidebarShareProps): React.ReactElement => {\n    const {setSidebar, url, urlEmbed} = props;\n\n    const iframeCode = `<iframe width=\"560\" height=\"315\" src=\"${urlEmbed}\" title=\"Xenpaper\" frameborder=\"0\"></iframe>`;\n\n    const [copiedLink, setCopiedLink] = useState<boolean>(false);\n    const [copiedIframe, setCopiedIframe] = useState<boolean>(false);\n\n    return <Sidebar setSidebar={setSidebar} pad>\n        <Box>\n            <H>Share link</H>\n            <Flex>\n                <ShareInput value={url} />\n                <Box flexShrink=\"0\" ml={3}>\n                    <CopyToClipboard text={url} onCopy={() => setCopiedLink(true)}>\n                        <TryButton>{copiedLink ? 'Copied' : 'Copy'}</TryButton>\n                    </CopyToClipboard>\n                </Box>\n            </Flex>\n        </Box>\n        <Box pt={4}>\n            <H>Embed</H>\n            <Flex>\n                <ShareInput value={iframeCode} />\n                <Box flexShrink=\"0\" ml={3}>\n                    <CopyToClipboard text={url} onCopy={() => setCopiedIframe(true)}>\n                        <TryButton>{copiedIframe ? 'Copied' : 'Copy'}</TryButton>\n                    </CopyToClipboard>\n                </Box>\n            </Flex>\n            <Box pt={3}>\n                <EmbedIframe key={urlEmbed} src={urlEmbed} frameBorder=\"0\" />\n            </Box>\n        </Box>\n    </Sidebar>;\n};\n\nconst EmbedIframe = styled.iframe`\n    width: 100%;\n`;\n\nconst ShareInput = styled.input.attrs(() => ({readOnly: true}))`\n    width: 100%;\n    background-color: ${props => props.theme.colors.background.normal};\n    font-family: ${props => props.theme.fonts.mono};\n    color: #ffffff;\n    padding: .25rem;\n    border: ${props => props.theme.colors.highlights[props.color || 'unknown']} 1px solid;\n`;\n\ntype SidebarProps = {\n    setSidebar: (open: SidebarState) => void;\n    children: React.ReactNode;\n    title?: string;\n    desc?: string;\n    pad?: boolean;\n};\n\nexport const Sidebar = (props: SidebarProps): React.ReactElement => {\n    const {setSidebar, children, title, desc, pad} = props;\n    return <TextPanel width={['100rem', '20rem', '30rem', '40%']} flexDirection=\"column\" flexShrink=\"0\" minHeight=\"0\">\n        <Box position={[\"absolute\", \"fixed\"]} top={0} right={0} pt={3} pr={3}>\n            <IconToggle\n                state=\"cross\"\n                paths={{\n                    cross: ['M 1 0 L 12 11 L 11 12 L 0 1 Z', 'M 1 12 L 12 1 L 11 0 L 0 11 Z'],\n                    none: []\n                }}\n                onClick={() => setSidebar('none')}\n                loaded\n            />\n        </Box>\n        <LogoArea>\n            {title &&\n                <Hsize>{title}</Hsize>\n            }\n            {desc &&\n                <Text as=\"div\" color=\"text.placeholder\" style={{fontStyle: \"italic\", lineHeight: '1.3rem'}}>{desc}</Text>\n            }\n            {!title &&\n                <Flex alignItems=\"center\">\n                    <Box mr={4} width=\"5rem\" pt={2}>\n                        <img alt=\"Xenpaper logo\" src={logo} width=\"100%\" />\n                    </Box>\n                    <Box>\n                        <Logo>xenpaper</Logo>\n                        <Text as=\"div\" color=\"text.placeholder\" style={{fontStyle: \"italic\", lineHeight: '1.3rem'}}>Text-based microtonal sequencer.</Text>\n                        <Text as=\"div\" color=\"text.placeholder\" style={{fontStyle: \"italic\", lineHeight: '1.3rem'}}>Write down musical ideas and share the link around.</Text>\n                    </Box>\n                </Flex>\n            }\n        </LogoArea>\n        <Box p={pad ? 4 : 0} flexGrow=\"1\">\n            {children}\n        </Box>\n    </TextPanel>;\n};\n\nconst TextPanel = styled(Flex)`\n    background-color: ${props => props.theme.colors.background.light};\n    font-family: ${props => props.theme.fonts.copy};\n    position: relative;\n    animation: .3s ease-out onShow;\n    position: relative;\n    overflow: auto;\n\n    opacity: 1;\n    top: 0;\n\n    @keyframes onShow {\n        0% {\n            opacity: 0;\n            top: .25rem;\n        }\n        100% {\n            opacity: 1;\n            top: 0;\n        }\n    }\n`;\n\nconst LogoArea = styled(Box)`\n    background-color: ${props => props.theme.colors.background.normal};\n    padding: 2rem 2rem 1.5rem;\n`;\n\nconst Logo = styled(Box)`\n    font-size: 2.5rem;\n    line-height: 2rem;\n    margin-bottom: .5rem;\n`;\n\nconst B = styled.div`\n    margin-bottom: 2rem;\n`;\n\nconst H = styled.h2`\n    font-size: 1.5rem;\n    margin-bottom: 1rem;\n`;\n\nconst Hsize = styled.h2`\n    font-size: 1.5rem;\n    margin-bottom: .25rem;\n`;\n\nconst C = styled.span`\n    font-family: ${props => props.theme.fonts.mono};\n    background-color: ${props => props.theme.colors.background.normal};\n    padding: .1rem;\n`;\n\ntype ExProps = {\n    tune: string;\n    onSetTune: (tune: string) => void;\n    color: string;\n};\n\nconst Ex = styled((props: ExProps): React.ReactElement => {\n\n    // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n    // @ts-ignore\n    return <Flex className={props.className}>\n        <Eg>e.g. </Eg>\n        <E fontSize={[\"1.1rem\", \"1.4rem\"]} color={props.color}>{props.tune}</E>\n        <Box flexShrink=\"0\">\n            <TryButton onClick={() => props.onSetTune(props.tune)}>Demo</TryButton>\n        </Box>\n    </Flex>;\n})`\n    font-family: ${props => props.theme.fonts.mono};\n    padding: .5rem;\n    margin-top: 1rem;\n    background-color: ${props => props.theme.colors.background.normal};\n    line-height: 2em;\n`;\n\nconst TryButton = styled.button`\n    border: none;\n    display: block;\n    padding: .5rem;\n    cursor: pointer;\n    background-color: ${props => props.theme.colors.highlights.scale};\n    color: ${props => props.theme.colors.background.normal};\n    position: relative;\n    outline: none;\n    opacity: 0.7;\n\n    transition: opacity .2s ease-out;\n\n    &:hover, &:focus, &:active {\n        opacity: 1;\n    }\n`;\n\nconst Eg = styled.div`\n    font-style: italic;\n    color: ${props => props.theme.colors.text.placeholder};\n    padding-left: .6rem;\n    padding-right: 1rem;\n    flex-shrink: 0;\n`;\n\ntype EProps = {\n    fontSize: unknown;\n};\n\nconst E = styled.pre<EProps>`\n    flex-grow: 1;\n    ${textStyle}\n    ${typography}\n    line-height: 1.4em;\n    font-style: normal;\n    color: ${props => props.theme.colors.highlights[props.color || 'unknown']};\n    word-wrap: break-word;\n    white-space: pre-wrap;\n    flex-shrink: 1;\n    width: 0;\n    padding-right: .5rem;\n`;\n","//\n// types\n//\n\nexport type MoscNote = {\n    type: 'NOTE_TIME';\n    time: number;\n    timeEnd: number;\n    hz: number;\n    label: string;\n};\n\nexport type MoscNoteMs = {\n    type: 'NOTE_MS';\n    ms: number;\n    msEnd: number;\n    hz: number;\n    label: string;\n};\n\nexport type MoscParam = {\n    type: 'PARAM_TIME';\n    time: number;\n    value: any;\n};\n\nexport type MoscParamMs = {\n    type: 'PARAM_MS';\n    ms: number;\n    value: any;\n};\n\nexport type MoscTempo = {\n    type: 'TEMPO';\n    time: number;\n    bpm: number;\n    lerp: boolean;\n};\n\nexport type MoscEnd = {\n    type: 'END_TIME';\n    time: number;\n};\n\nexport type MoscEndMs = {\n    type: 'END_MS';\n    ms: number;\n};\n\nexport type MoscItem = MoscNote|MoscTempo|MoscParam|MoscEnd;\n\nexport type MoscScore = {\n    sequence: MoscItem[];\n    lengthTime: number;\n};\n\nexport type MoscItemMs = MoscNoteMs|MoscParamMs|MoscEndMs;\n\nexport type MoscScoreMs = {\n    sequence: MoscItemMs[];\n    lengthMs: number;\n};\n\n//\n// utils\n//\n\nexport const centsToRatio = (cents: number, octave: number = 0): number => {\n    return octaveDivisionToRatio(cents, 1200, 2, octave);\n};\n\nexport const octaveDivisionToRatio = (steps: number, stepsInOctave: number, octaveSize: number, octave: number = 0): number => {\n    return Math.pow(octaveSize, (steps + (octave * stepsInOctave)) / stepsInOctave);\n};\n\nexport const ratioToCents = (ratio: number, octave: number = 0): number => {\n    return ratioToOctaveDivision(ratio, 1200, 2, octave);\n};\n\nexport const ratioToOctaveDivision = (ratio: number, stepsInOctave: number, octaveSize: number, octave: number = 0): number => {\n    return (Math.log(ratio) / Math.log(octaveSize) * stepsInOctave) - (octave * stepsInOctave);\n};\n\nexport const sortByTime = <T extends {time: number}>(items: T[]): T[] => {\n    return items.slice().sort((a, b) => {\n        if(a.time < b.time) return -1;\n        if(a.time > b.time) return 1;\n        return 0;\n    });\n};\n\nexport const sortByMs = (items: Array<MoscNoteMs>): Array<MoscNoteMs> => {\n    return items.slice().sort((a, b) => {\n        if(a.ms < b.ms) return -1;\n        if(a.ms > b.ms) return 1;\n        return 0;\n    });\n};\n\n//\n// time-based to ms-based conversion\n//\n\nconst tempoTimeToMs = (bpm1: number, bpm2: number, duration: number): number => {\n    let u = bpm1 / 60;\n    let v = bpm2 / 60;\n    let s = duration;\n    if(u === v) return s / v * 1000;\n    return 2 * s * (v - u) / (v * v - u * u) * 1000;\n};\n\ntype TempoChange = {\n    bpm: number;\n    bpmEnd: number;\n    time: number;\n    ms: number;\n};\n\nconst findTempoRangeForTime = (tempoChanges: TempoChange[], time: number): TempoChange => {\n    for(let i = tempoChanges.length - 1; i >= 0; i--) {\n        if(time >= tempoChanges[i].time) {\n            return tempoChanges[i];\n        }\n    }\n    return tempoChanges[0];\n};\n\nexport const timeToMs = (items: MoscItem[]): ((time: number) => number) => {\n\n    const tempoChanges: TempoChange[] = [];\n    tempoChanges.push({\n        bpm: 60,\n        bpmEnd: 60,\n        time: 0,\n        ms: 0\n    });\n\n    const tempoItems: MoscTempo[] = items.filter((item: MoscItem): item is MoscTempo => item.type === 'TEMPO');\n\n    sortByTime(tempoItems).forEach((tempo: MoscTempo, index: number, all: MoscTempo[]) => {\n        const lastChange = tempoChanges[tempoChanges.length - 1] as TempoChange;\n        const nextTempo: MoscTempo|undefined = all[index + 1];\n\n        const ms = tempoTimeToMs(lastChange.bpm, lastChange.bpmEnd, tempo.time - lastChange.time) + lastChange.ms;\n        const bpmEnd = (nextTempo && nextTempo.lerp) ? nextTempo.bpm : tempo.bpm;\n\n        tempoChanges.push({\n            bpm: tempo.bpm,\n            bpmEnd,\n            time: tempo.time,\n            ms\n        });\n    });\n\n    return (time: number): number => {\n        const tempoChange: TempoChange = findTempoRangeForTime(tempoChanges, time);\n        return tempoTimeToMs(tempoChange.bpm, tempoChange.bpmEnd, time - tempoChange.time) + tempoChange.ms;\n    };\n};\n\nexport const scoreToMs = (score: MoscScore): MoscScoreMs => {\n    const thisTimeToMs = timeToMs(score.sequence);\n\n    const sequence: MoscItemMs[] = sortByTime(score.sequence)\n        .map((item: MoscItem): MoscItemMs|undefined => {\n            if(item.type === 'NOTE_TIME') {\n                const note = item as MoscNote;\n                return {\n                    type: 'NOTE_MS',\n                    hz: note.hz,\n                    label: note.label,\n                    ms: thisTimeToMs(note.time),\n                    msEnd: thisTimeToMs(note.timeEnd)\n                };\n            }\n            if(item.type === 'PARAM_TIME') {\n                const param = item as MoscParam;\n                return {\n                    type: 'PARAM_MS',\n                    value: param.value,\n                    ms: thisTimeToMs(param.time)\n                };\n            }\n            if(item.type === 'END_TIME') {\n                const end = item as MoscEnd;\n                return {\n                    type: 'END_MS',\n                    ms: thisTimeToMs(end.time)\n                };\n            }\n            return undefined;\n        })\n        .filter((item): item is MoscItemMs => !!item);\n\n    return {\n        sequence,\n        lengthMs: thisTimeToMs(score.lengthTime)\n    };\n};\n\n//\n// soud engine base class\n//\n\ntype SoundEngineEndEventCallback = () => void;\ntype SoundEngineNoteEventCallback = (noteMs: MoscNoteMs, on: boolean) => void;\ntype SoundEngineEventCallbackCancel = () => void;\n\nexport class SoundEngine {\n\n    scoreMs?: MoscScoreMs;\n\n    playing(): boolean {\n        return false;\n    }\n\n    looping(): boolean {\n        return false;\n    }\n\n    position(): number {\n        return 0;\n    }\n\n    endPosition(): number {\n        return 0;\n    }\n\n    async play(): Promise<void> {}\n\n    async pause(): Promise<void> {}\n\n    async gotoMs(ms: number): Promise<void> {}\n\n    setLoop(loop: boolean, startMs: number = 0, endMs: number = 0): void {}\n    setLoopActive(loop: boolean): void {}\n    setLoopStart(ms: number = 0): void {}\n    setLoopEnd(ms: number = 0): void {}\n\n    async setScore(scoreMs: MoscScoreMs): Promise<void> {}\n\n    // events\n\n    events = {\n        end: new Set<SoundEngineEndEventCallback>(),\n        note: new Set<SoundEngineNoteEventCallback>()\n    };\n\n    _triggerEvent(type: string, ...params: any) {\n        // @ts-ignore\n        this.events[type].forEach(cb => cb(...params));\n    }\n\n    onEnd(callback: SoundEngineEndEventCallback): SoundEngineEventCallbackCancel {\n        this.events.end.add(callback);\n        return () => {\n            this.events.end.delete(callback);\n        };\n    }\n\n    onNote(callback: SoundEngineNoteEventCallback): SoundEngineEventCallbackCancel {\n        this.events.note.add(callback);\n        return () => {\n            this.events.note.delete(callback);\n        };\n    }\n}\n","import React, {useCallback, useEffect, useRef, useState} from 'react';\nimport useDimensions from 'react-use-dimensions';\nimport * as ReactKonva from 'react-konva';\nimport {useStrictMode} from 'react-konva';\nimport {useDendriform, useCheckbox} from 'dendriform';\nimport type {Dendriform} from 'dendriform';\nimport type {MoscNoteMs} from '@xenpaper/mosc';\nimport {Box, Flex} from './layout/Layout';\nimport styled from 'styled-components';\nimport hsl from 'hsl-to-hex';\n\nimport {centsToRatio} from '@xenpaper/mosc';\n\nuseStrictMode(true);\nconst {Stage, Layer, Rect, Group, Text, Line} = ReactKonva as any;\n\nexport type RulerState = {\n    notes: Map<string,MoscNoteMs>;\n    notesActive: Map<string,MoscNoteMs>;\n    collect: boolean;\n    viewPan: number;\n    viewZoom: number;\n    rootHz?: number;\n    octaveSize?: number;\n    plots?: MoscNoteMs[][];\n};\n\nconst LOW_HZ_LIMIT = 20;\nconst ZOOM_SPEED = 1.1;\n\nconst hzToPan = (hz: number): number => Math.log2(hz / LOW_HZ_LIMIT);\n\nconst panToHz = (pan: number): number => Math.pow(2, pan) * LOW_HZ_LIMIT;\n\nconst panToPx = (pan: number, viewPan: number, viewZoom: number, height: number): number => {\n    return height * 0.5 - ((pan - viewPan) * height / viewZoom);\n};\n\nconst pxToPan = (px: number, viewPan: number, viewZoom: number, height: number): number => {\n    return viewPan - ((px - (height * 0.5)) / height * viewZoom);\n};\n\nconst hzInRange = (hz: number, [lowHz, highHz]: [number,number]) => {\n    return hz >= lowHz && hz <= highHz;\n};\n\nexport type InitialRulerState = {\n    lowHz?: number;\n    highHz?: number;\n    rootHz?: number;\n    octaveSize?: number;\n    plots?: MoscNoteMs[][];\n};\n\nexport function useRulerState({lowHz, highHz, ...rest}: InitialRulerState = {}) {\n    return useDendriform<RulerState>(() => {\n\n        let viewPan = hzToPan(220 * 1.5);\n        let viewZoom = 1.5;\n\n        if(lowHz && highHz) {\n            const lowPan = hzToPan(lowHz);\n            const highPan = hzToPan(highHz);\n            viewPan = (lowPan + highPan) * 0.5;\n            viewZoom = highPan - lowPan;\n        }\n\n        return {\n            notes: new Map(),\n            notesActive: new Map(),\n            collect: true,\n            viewPan,\n            viewZoom,\n            ...rest\n        };\n    });\n};\n\ntype Props = {\n    rulerState: Dendriform<RulerState,any>;\n};\n\nexport function PitchRuler(props: Props): React.ReactElement|null {\n    const {rulerState} = props;\n\n    const onClear = useCallback(() => {\n        rulerState.set(draft => {\n            draft.notes.clear();\n        });\n    }, []);\n\n    return <Flex flexDirection=\"column\" style={{height: '100%'}}>\n        <Flex p={2}>\n            <Box mr={3}>\n                {rulerState.render('collect', form => (\n                    <Label>\n                        <input type=\"checkbox\" {...useCheckbox(form)} />\n                        {' '}collect\n                    </Label>\n                ))}\n            </Box>\n            <Box>\n                <Button onClick={onClear}>clear</Button>\n            </Box>\n        </Flex>\n        <PitchRulerCanvas {...props} />\n    </Flex>;\n}\n\ntype DragStartState = {\n    startPan: number;\n    startZoom: number;\n    startDrag: number;\n};\n\nfunction PitchRulerCanvas(props: Props): React.ReactElement|null {\n    const [dimensionsRef, {width = 0, height = 0}] = useDimensions();\n\n    const rulerState = props.rulerState.useValue();\n\n    const {viewPan, viewZoom} = rulerState;\n\n    const getY = useCallback((hz: number): number => {\n       return panToPx(hzToPan(hz), viewPan, viewZoom, height);\n    }, [viewPan, viewZoom, height]);\n\n    const dragStartState = useRef<DragStartState|null>(null);\n    const [dragging, setDragging] = useState<boolean>(false);\n\n    const handleMouseDown = useCallback(({evt}) => {\n        evt.preventDefault();\n        dragStartState.current = {\n            startPan: viewPan,\n            startZoom: viewZoom,\n            startDrag: pxToPan(evt.clientY, viewPan, viewZoom, height)\n        };\n        setDragging(true);\n    }, [viewPan, viewZoom, height]);\n\n    const handleMouseMove = useCallback(({evt}) => {\n        evt.preventDefault();\n        const dragState = dragStartState.current;\n        if(dragState) {\n            const nowDrag = pxToPan(evt.clientY, dragState.startPan, dragState.startZoom, height);\n\n            props.rulerState.set(draft => {\n                draft.viewPan = dragState.startPan - nowDrag + dragState.startDrag;\n            });\n        }\n    }, [height]);\n\n    useEffect(() => {\n        const onMouseUp = () => {\n            dragStartState.current = null;\n            setDragging(false);\n        };\n\n        window.addEventListener('mouseup', onMouseUp);\n        return () => window.removeEventListener('mouseup', onMouseUp);\n    }, []);\n\n    const handleWheel = useCallback(({evt}) => {\n        evt.preventDefault();\n        props.rulerState.set(draft => {\n            draft.viewZoom *= evt.deltaY > 0 ? ZOOM_SPEED : evt.deltaY < 0 ? 1/ZOOM_SPEED : 1\n        });\n    }, []);\n\n    const handleTouchStart = useCallback(({evt}) => {\n        evt.preventDefault();\n        // console.log('handleTouchStart', {evt});\n    }, []);\n\n    const handleTouchMove = useCallback(({evt}) => {\n        evt.preventDefault();\n        // console.log('handleTouchMove', {evt});\n    }, []);\n\n    const handleTouchEnd = useCallback(({evt}) => {\n        evt.preventDefault();\n        // console.log('handleTouchEnd', {evt});\n    }, []);\n\n    // TODO zoom toward cursor position\n\n    const visibleRange: [number,number] = [\n        panToHz(pxToPan(height, viewPan, viewZoom, height)),\n        panToHz(pxToPan(0, viewPan, viewZoom, height))\n    ];\n\n    const {rootHz, octaveSize, plots = [], notes, notesActive} = rulerState;\n    const total = plots.length + 1;\n    const noteSetWidth = (width - 60) / total;\n\n    const style = {\n        height: '100%',\n        width: '100%',\n        backgroundColor: '#080b0e',\n        cursor: dragging ? 'grabbing' : 'grab'\n    };\n\n    return <div ref={dimensionsRef} style={style}>\n        <Stage\n            width={width}\n            height={height}\n            onMouseDown={handleMouseDown}\n            onMouseMove={handleMouseMove}\n            onWheel={handleWheel}\n            onTouchStart={handleTouchStart}\n            onTouchMove={handleTouchMove}\n        >\n            <Layer>\n                {rootHz && octaveSize &&\n                    <CentsGrid\n                        rootHz={rootHz}\n                        octaveSize={octaveSize}\n                        getY={getY}\n                        width={width}\n                        visibleRange={visibleRange}\n                    />\n                }\n                {rootHz && octaveSize &&\n                    <RootGrid\n                        rootHz={rootHz}\n                        octaveSize={octaveSize}\n                        getY={getY}\n                        width={width}\n                        visibleRange={visibleRange}\n                    />\n                }\n                {rulerState.collect &&\n                    <NoteSet\n                        notes={Array.from(notes.values())}\n                        getY={getY}\n                        width={noteSetWidth}\n                        x={0}\n                        visibleRange={visibleRange}\n                    />\n                }\n                {(plots || []).map((plot, index) => {\n                    return <NoteSet\n                        key={index}\n                        notes={plot}\n                        getY={getY}\n                        width={noteSetWidth}\n                        x={noteSetWidth * (index + 1)}\n                        visibleRange={visibleRange}\n                    />\n                })}\n                <NoteSet\n                    notes={Array.from(notesActive.values())}\n                    getY={getY}\n                    color=\"#FFFFFF\"\n                    width={noteSetWidth}\n                    x={0}\n                    visibleRange={visibleRange}\n                />\n            </Layer>\n        </Stage>\n    </div>;\n}\n\n\n// this is so completely stupid\n// and doesnt even work with non 2x octave sizes\n// but i'm done with this\nconst getColorFromLabel = (label: string): number => {\n    const matched = label.match(/([\\d.]+)c/);\n    if(!matched) return 0;\n    const hue = Math.floor(Number(matched[1]) / 1200 * 360 + 180);\n    return hue;\n};\n\ntype NoteSetProps = {\n    notes: MoscNoteMs[];\n    getY: (hz: number) => number;\n    color?: string;\n    width: number;\n    x: number;\n    visibleRange: [number,number];\n};\n\nconst NoteSet = React.memo(function NoteSet(props: NoteSetProps): React.ReactElement {\n    const {width, notes, getY, x, visibleRange} = props;\n\n    const visibleNotes = notes.filter(note => hzInRange(note.hz, visibleRange));\n\n    return <>\n        {visibleNotes.map((note, index) => {\n            const color = props.color ?? hsl(getColorFromLabel(note.label), 100, 66);\n            return <Group key={index} x={x} y={getY(note.hz)}>\n                <Line\n                    stroke={color}\n                    strokeWidth={1}\n                    points={[0, 0, width, 0]}\n                />\n                <Text\n                    text={note.label}\n                    fill={color}\n                    align=\"center\"\n                    width={width}\n                    y={-13}\n                />\n            </Group>;\n        })}\n    </>;\n});\n\nconst Label = styled.label`\n    user-select: none;\n`;\n\nconst Button = styled.button`\n    border: none;\n    display: block;\n    padding: .25rem .5rem;\n    cursor: pointer;\n    background-color: ${props => props.theme.colors.highlights.unknown};\n    color: ${props => props.theme.colors.background.normal};\n    position: relative;\n    outline: none;\n    opacity: 0.7;\n\n    transition: opacity .2s ease-out;\n\n    &:hover, &:focus, &:active {\n        opacity: 1;\n    }\n`;\n\ntype RootGridProps = {\n    octaveSize: number;\n    rootHz: number;\n    width: number;\n    getY: (hz: number) => number;\n    visibleRange: [number,number];\n};\n\nconst ROOT_GRID_POSITIONS = [7,6,5,4,3,2,1,0,-1,-2,-3];\n\nconst RootGrid = React.memo(function RootGrid(props: RootGridProps): React.ReactElement {\n    const {getY, rootHz, octaveSize, width, visibleRange} = props;\n\n    const lines = ROOT_GRID_POSITIONS\n        .map(i => [i, rootHz * Math.pow(octaveSize,i)])\n        .filter(([,hz]) => hzInRange(hz, visibleRange));\n\n    return <>\n        {lines.map(([i, hz]) => {\n            const y = getY(hz);\n            return <Group key={i} y={y}>\n                <Line\n                    stroke={hsl(208, 32, (8 - Math.abs(i)) * 12)}\n                    strokeWidth={1}\n                    points={[0, 0, width - 60, 0]}\n                    dash={[4,4]}\n                />\n                <Text\n                    text={`${hz}Hz`}\n                    fill={hsl(208, 32, (8 - Math.abs(i)) * 24)}\n                    align=\"left\"\n                    width={55}\n                    x={width - 55}\n                    y={-5}\n                />\n            </Group>;\n        })}\n    </>;\n});\n\nconst CENT_GRID_POSITIONS = [1,0,-1];\n\ntype CentsGridProps = {\n    octaveSize: number;\n    rootHz: number;\n    width: number;\n    getY: (hz: number) => number;\n    visibleRange: [number,number];\n};\n\nconst CentsGrid = React.memo(function CentsGrid(props: CentsGridProps): React.ReactElement {\n    const {getY, rootHz, octaveSize, width, visibleRange} = props;\n\n    const lines: [number,number,number][] = [];\n\n    CENT_GRID_POSITIONS.forEach(octave => {\n        for(let i = 100; i < octaveSize * 600; i+=100) {\n            const hz = rootHz * centsToRatio(i, octave);\n            if(hzInRange(hz, visibleRange)) {\n                lines.push([i, hz, octave]);\n            }\n        }\n    });\n\n    return <>\n        {lines.map(([cents, hz, octave]) => {\n            const y = getY(hz);\n            return <Group key={hz} y={y}>\n                <Line\n                    stroke={hsl(208, 32, (2 - Math.abs(octave)) * 12)}\n                    strokeWidth={1}\n                    points={[0, 0, width - 60, 0]}\n                />\n                <Text\n                    text={`${cents}c`}\n                    fill={hsl(208, 32, (2 - Math.abs(octave)) * 24)}\n                    align=\"left\"\n                    width={55}\n                    x={width - 55}\n                    y={-5}\n                />\n            </Group>;\n        })}\n    </>;\n});\n","import Parser, {All, Any, Optional, Star, Node} from 'rd-parse';\n\nexport type NodeType = {\n    type: string;\n    delimiter: boolean;\n    pos: number;\n    len: number;\n    time?: [number, number];\n};\n\nexport type Meta = {\n    pos: number;\n};\n\nexport type NodeCreator = (args: any) => {[key: string]: any};\n\nfunction node/*<T extends NodeType>*/(type: string, match: RegExp|string, fn: NodeCreator) {\n    return Node(match, (value: unknown, meta: Meta) => {\n        return {\n            type,\n            delimiter: false,\n            ...fn(value),\n            pos: meta.pos\n        };\n    });\n}\n\nconst sumLen = (nodes: NodeType[]): number => nodes.reduce((len: number, node: NodeType) => len + node.len, 0);\n\n//\n// delimiters and whitespace\n//\n\nconst delimiter = ([text]: [string]) => ({\n    delimiter: true,\n    len: text.length\n});\n\nexport type DelimiterType = NodeType & {\n    delimiter: true;\n};\n\nexport const Semicolon = node/*<DelimiterType>*/(\n    'Semicolon',\n    /(^[;]\\s*)/,\n    delimiter\n);\n\nexport const Colon = node/*<DelimiterType>*/(\n    'Colon',\n    /(^[:]\\s*)/,\n    delimiter\n);\n\nexport const BarLine = node/*<DelimiterType>*/(\n    'BarLine',\n    '|',\n    () => ({\n        len: 1,\n        delimiter: true\n    })\n);\n\nexport const Whitespace = node/*<DelimiterType>*/(\n    'Whitespace',\n    /(^[,\\s]+)/,\n    ([whitespace]) => ({\n        len: whitespace.length,\n        delimiter: true\n    })\n);\n\n//\n// pitches\n//\n\ntype OctaveModifierType = NodeType & {\n    octave: number;\n};\n\nexport const OctaveModifier = node/*<OctaveModifierType>*/(\n    'OctaveModifier',\n    /^(['\"]+|`+)/,\n    ([chars]) => ({\n        octave: (chars.split(\"'\").length - 1) + ((chars.split('\"').length - 1) * 2) - (chars.split('`').length - 1),\n        len: chars.length\n    })\n);\n\nexport type PitchCentsType = NodeType & {\n    cents: number;\n};\n\nexport const PitchCents = node/*<PitchCentsType>*/(\n    'PitchCents',\n    /^(\\d+|\\d+\\.(\\d+)?)c/,\n    ([cents]) => ({\n        cents: Number(cents),\n        len: cents.length + 1\n    })\n);\n\nexport type PitchOctaveDivisionType = NodeType & {\n    numerator: number;\n    denominator: number;\n    octaveSize: number;\n};\n\nexport const PitchOctaveDivision = node/*<PitchOctaveDivisionType>*/(\n    'PitchOctaveDivision',\n    /^([\\d]+)[\\\\/]([\\d]+)o(\\d)?(\\/(\\d))?/,\n    ([numerator, denominator, octaveSize = '', slash = '', octaveDenom = '']) => ({\n        numerator: Number(numerator),\n        denominator: Number(denominator),\n        octaveSize: Number(octaveSize || 2) / Number(octaveDenom || 1),\n        len: numerator.length + denominator.length + octaveSize.length + 2 + slash.length\n    })\n);\n\nexport const PitchOctaveDivision2 = node/*<PitchOctaveDivisionType>*/(\n    'PitchOctaveDivision',\n    /^([\\d]+)[\\\\]([\\d]+)/,\n    ([numerator, denominator]) => ({\n        numerator: Number(numerator),\n        denominator: Number(denominator),\n        octaveSize: 2,\n        len: numerator.length + denominator.length + 1\n    })\n);\n\nexport type PitchRatioType = NodeType & {\n    numerator: number;\n    denominator: number;\n};\n\nexport const PitchRatio = node/*<PitchRatioType>*/(\n    'PitchRatio',\n    /^([\\d]+)\\/([\\d]+)/,\n    ([numerator, denominator]) => ({\n        numerator: Number(numerator),\n        denominator: Number(denominator),\n        len: numerator.length + denominator.length + 1\n    })\n);\n\nexport type PitchDegreeType = NodeType & {\n    degree: number;\n};\n\nexport const PitchDegree = node/*<PitchDegreeType>*/(\n    'PitchDegree',\n    /^([\\d]+)/,\n    ([degree]) => ({\n        degree: Number(degree),\n        len: degree.length\n    })\n);\n\nexport type PitchHzType = NodeType & {\n    hz: number;\n};\n\nexport const PitchHz = node/*<PitchHzType>*/(\n    'PitchHz',\n    /^(\\d+|\\d+\\.(\\d+)?)hz/i,\n    ([hz]: [string]) => ({\n        hz: Number(hz),\n        len: hz.length + 2\n    })\n);\n\nexport type PitchType = NodeType & {\n    value: PitchCentsType|PitchOctaveDivisionType|PitchRatioType|PitchDegreeType|PitchHzType;\n    octave?: OctaveModifierType;\n};\n\nexport const Pitch = node/*<PitchType>*/(\n    'Pitch',\n    All(Optional(OctaveModifier), Any(PitchCents, PitchHz, PitchOctaveDivision, PitchOctaveDivision2, PitchRatio, PitchDegree)),\n    (args) => {\n        if(args.length === 1) {\n            const [value] = args;\n            return {\n                value,\n                len: value.len\n            };\n        }\n        const [octave, value] = args;\n        return {\n            value,\n            octave,\n            len: octave.len + value.len\n        };\n    }\n);\n\nexport type PitchGroupType = Array<PitchType|DelimiterType>;\n\nexport const PitchGroup = Node(\n    All(Pitch, Star(All(Whitespace, Pitch))),\n    (elements: unknown) => elements\n);\n\n//\n// note\n//\n\nexport type HoldType = NodeType & {\n    length: number;\n};\n\nexport const Hold = node/*<HoldType>*/(\n    'Hold',\n    /^(([|]?-)+)/,\n    ([value]) => ({\n        length: value.replace(/[|]+/g, '').length,\n        len: value.length\n    })\n);\n\nexport type TailType = HoldType;\n\nexport const Tail = Any(Hold);\n\nexport type RestType = NodeType & {\n    length: number;\n};\n\nexport const Rest = node/*<RestType>*/(\n    'Rest',\n    All(/^(\\.)/),\n    ([value]: [unknown[]]) => ({\n        length: value.length,\n        len: value.length\n    })\n);\n\nexport type NoteType = NodeType & {\n    pitch: PitchType;\n    tail?: TailType;\n};\n\nexport const Note = node/*<NoteType>*/(\n    'Note',\n    All(Pitch, Optional(Tail)),\n    ([pitch, tail]: [PitchType, TailType?]) => ({\n        pitch,\n        tail,\n        len: pitch.len + (tail ? tail.len : 0)\n    })\n);\n\n//\n// chords\n//\n\nexport type RatioChordPitchType = NodeType & {\n    pitch: number;\n};\n\nexport const RatioChordPitch = node/*<RatioChordPitchType>*/(\n    'RatioChordPitch',\n    /^([\\d]+)/,\n    ([pitch]: [string]) => ({\n        pitch: Number(pitch),\n        len: pitch.length\n    })\n);\n\nexport type RatioChordPitchGroupType = Array<RatioChordPitchType|DelimiterType>;\n\nexport const RatioChordPitchGroup = Node(\n    All(RatioChordPitch, Colon, RatioChordPitch, Star(All(Colon, RatioChordPitch))),\n    (elements: RatioChordPitchGroupType) => elements\n);\n\nexport type ChordType = NodeType & {\n    pitches: Array<RatioChordPitchType|PitchType|DelimiterType>;\n    tail?: TailType;\n};\n\nexport const Chord = node/*<ChordType>*/(\n    'Chord',\n    All('[', Any(RatioChordPitchGroup, PitchGroup), ']', Optional(Tail)),\n    ([pitches, tail]) => ({\n        pitches,\n        tail,\n        len: sumLen(pitches) + (tail ? tail.len : 0) + 2\n    })\n);\n\nexport type RatioChordType = NodeType & {\n    pitches: Array<RatioChordPitchType>;\n    tail?: TailType;\n};\n\nexport const RatioChord = node/*<RatioChordType>*/(\n    'RatioChord',\n    All(RatioChordPitchGroup, Optional(Tail)),\n    ([pitches, tail]) => ({\n        pitches,\n        tail,\n        len: sumLen(pitches) + (tail ? tail.len : 0)\n    })\n);\n\n//\n// scales\n//\n\nexport type EdoScaleType = NodeType & {\n    divisions: number;\n    octaveSize: number;\n};\n\nexport const EdoScale = node/*<EdoScaleType>*/(\n    'EdoScale',\n    /^(\\d+)ed([o\\d])(\\/(\\d))?/i,\n    ([divisions, octaveSize, slash = '', denominator = '']: [string, string, string, string]) => ({\n        divisions: Number(divisions),\n        // TODO this math should not be in the grammar\n        octaveSize: octaveSize === 'o' ? 2 : Number(octaveSize) / Number(denominator || 1),\n        len: divisions.length + octaveSize.length + 2 + slash.length\n    })\n);\n\nexport type ScaleOctaveMarkerType = NodeType;\n\nexport const ScaleOctaveMarker = node/*<ScaleOctaveMarkerType>*/(\n    'ScaleOctaveMarker',\n    \"'\",\n    () => ({\n        len: 1\n    })\n);\n\nexport type PitchGroupScalePrefixType = NodeType & {\n    prefix: string;\n};\n\nexport const PitchGroupScalePrefix = node/*<EdoScaleType>*/(\n    'PitchGroupScalePrefix',\n    /(^[m])(\\s*)/,\n    ([prefix, space]: [string, string?]) => ({\n        prefix,\n        len: prefix.length + (space ? space.length : 0)\n    })\n);\n\nexport type PitchGroupScaleType = NodeType & {\n    pitchGroupScalePrefix?: PitchGroupScalePrefixType;\n    pitches: PitchGroupType;\n    scaleOctaveMarker?: ScaleOctaveMarkerType;\n};\n\nexport const PitchGroupScale = node/*<PitchGroupScaleType>*/(\n    'PitchGroupScale',\n    All(Optional(PitchGroupScalePrefix), PitchGroup, Optional(ScaleOctaveMarker)),\n    (elements: any[]) => {\n\n        const [pitchGroupScalePrefix, pitches, scaleOctaveMarker] = Array.isArray(elements[0])\n            ? [undefined, ...elements]\n            : elements;\n\n        return {\n            pitchGroupScalePrefix,\n            pitches,\n            scaleOctaveMarker,\n            len: (pitchGroupScalePrefix ? pitchGroupScalePrefix.len : 0) + sumLen(pitches) + (scaleOctaveMarker ? scaleOctaveMarker.len : 0)\n        };\n    }\n);\n\nexport type RatioChordScaleType = NodeType & {\n    pitches: Array<RatioChordPitchType|DelimiterType>;\n    scaleOctaveMarker?: ScaleOctaveMarkerType;\n};\n\nexport const RatioChordScale = node/*<RatioChordScaleType>*/(\n    'RatioChordScale',\n    All(RatioChordPitchGroup, Optional(ScaleOctaveMarker)),\n    ([pitches, scaleOctaveMarker]: [RatioChordPitchGroupType, ScaleOctaveMarkerType?]) => ({\n        pitches,\n        scaleOctaveMarker,\n        len: sumLen(pitches) + (scaleOctaveMarker ? scaleOctaveMarker.len : 0)\n    })\n);\n\n//\n// scale setters\n//\n\nexport const Scale = Any(EdoScale, RatioChordScale, PitchGroupScale);\n\nexport type SetScaleType = NodeType & {\n    scale: EdoScaleType|RatioChordScaleType|PitchGroupScaleType;\n};\n\nexport const SetScale = node/*<SetScaleType>*/(\n    'SetScale',\n    All('{', Scale, '}'),\n    ([scale]) => ({\n        scale,\n        len: scale.len + 2\n    })\n);\n\nexport type SetRootType = NodeType & {\n    pitch: PitchType\n};\n\nexport const SetRoot = node/*<SetRootType>*/(\n    'SetRoot',\n    All('{r', Pitch, '}'),\n    ([pitch]) => ({\n        pitch,\n        len: pitch.len + 3\n    })\n);\n\n//\n// setters\n//\n\n// bpm\n\nexport type SetBpmValue = NodeType & {\n    bpm: number;\n};\n\nexport const SetBpmValue = node/*<SetBpmValueType>*/(\n    'SetBpmValue',\n    /^(\\d+(\\.\\d+)?)/,\n    ([bpm]: [string]) => ({\n        bpm: Number(bpm),\n        len: bpm.length\n    })\n);\n\nexport type SetBpmType = NodeType & {\n    bpm: number;\n};\n\nexport type SetBpmValueType = NodeType & {\n    bpm: number;\n};\n\nexport const SetBpm = node/*<SetBpmType>*/(\n    'SetBpm',\n    All(/^(bpm:\\s*)/, SetBpmValue),\n    ([prefix, value]: [string, SetBpmValueType]) => ({\n        bpm: value.bpm,\n        len: prefix.length + value.len\n    })\n);\n\n// bms (beat milliseconds)\n\nexport type SetBmsValue = NodeType & {\n    bms: number;\n};\n\nexport const SetBmsValue = node/*<SetBmsValueType>*/(\n    'SetBmsValue',\n    /^(\\d+(\\.\\d+)?)/,\n    ([bms]: [string]) => ({\n        bms: Number(bms),\n        len: bms.length\n    })\n);\n\nexport type SetBmsType = NodeType & {\n    bms: number;\n};\n\nexport type SetBmsValueType = NodeType & {\n    bms: number;\n};\n\nexport const SetBms = node/*<SetBmsType>*/(\n    'SetBms',\n    All(/^(bms:\\s*)/, SetBmsValue),\n    ([prefix, value]: [string, SetBmsValueType]) => ({\n        bms: value.bms,\n        len: prefix.length + value.len\n    })\n);\n\n\n// subdivision\n\nexport type SetSubdivisionValueType = NodeType & {\n    subdivision: number;\n    denominator: number;\n};\n\n// TODO - could be a generic number matcher\nexport const SetSubdivisionValue = node/*<SetSubdivisionValueType>*/(\n    'SetSubdivisionValue',\n    /^([\\d]+)(\\/(\\d))?/,\n    ([subdivision, slash = '', denominator = '']: [string, string, string]) => ({\n        subdivision: Number(subdivision),\n        denominator: denominator ? Number(denominator) : undefined,\n        len: subdivision.length + slash.length\n    })\n);\n\nexport type SetSubdivisionType = NodeType & {\n    subdivision: number;\n    denominator: number;\n};\n\nexport const SetSubdivision = node/*<SetSubdivisionType>*/(\n    'SetSubdivision',\n    All(/^((div:)?\\s*)/, SetSubdivisionValue),\n    ([prefix,, value]: [string, string, SetSubdivisionValueType]) => ({\n        subdivision: value.subdivision,\n        denominator: value.denominator,\n        len: prefix.length + value.len\n    })\n);\n\n// osc\n\nexport type SetOscValueType = NodeType & {\n    osc: string;\n};\n\nexport const SetOscValue = node/*<SetOscValueType>*/(\n    'SetOscValue',\n    /^([a-z0-9]*)/,\n    ([osc]: [string]) => ({\n        osc,\n        len: osc.length\n    })\n);\n\nexport type SetOscType = NodeType & {\n    osc: string;\n};\n\nexport const SetOsc = node/*<SetOscType>*/(\n    'SetOsc',\n    All(/^(osc:\\s*)/, SetOscValue),\n    ([prefix, value]: [string, SetOscValueType]) => ({\n        osc: value.osc,\n        len: prefix.length + value.len\n    })\n);\n\n// env\n\nexport type SetEnvValueType = NodeType & {\n    a: number;\n    d: number;\n    s: number;\n    r: number;\n};\n\nexport const SetEnvValue = node/*<SetEnvValueType>*/(\n    'SetEnvValue',\n    /^(([0-9])([0-9])([0-9])([0-9]))/,\n    ([all, a, d, s, r]: [string, string, string, string, string]) => ({\n        a: Number(a),\n        d: Number(d),\n        s: Number(s),\n        r: Number(r),\n        len: all.length\n    })\n);\n\nexport type SetEnvType = NodeType & {\n    a: number;\n    d: number;\n    s: number;\n    r: number;\n};\n\nexport const SetEnv = node/*<SetEnvType>*/(\n    'SetEnv',\n    All(/^(env:\\s*)/, SetEnvValue),\n    ([prefix, value]: [string, SetEnvValueType]) => ({\n        a: value.a,\n        d: value.d,\n        s: value.s,\n        r: value.r,\n        len: prefix.length + value.len\n    })\n);\n\n// ruler\n\nexport type SetRulerRangeType = NodeType & {\n    low: PitchType;\n    high: PitchType;\n};\n\nexport const SetRulerRange = node/*<SetRulerRangeType>*/(\n    'SetRulerRange',\n    All(/^(rl:)/, Pitch, ',', Pitch),\n    ([prefix, low, high]: [string, PitchType, PitchType]) => ({\n        low,\n        high,\n        len: prefix.length + 1 + low.len + high.len\n    })\n);\n\nexport type SetRulerPlotType = NodeType;\n\nexport const SetRulerPlot = node/*<SetRulerPlotType>*/(\n    'SetRulerPlot',\n    'plot',\n    () => ({\n        len: 4\n    })\n);\n\nexport type SetRulerType = SetRulerRangeType|SetRulerPlotType;\n\nexport const SetRuler = Any(SetRulerRange, SetRulerPlot);\n\n// setters\n\nexport type SetterType = SetBpmType|SetBmsType|SetSubdivisionType|SetOscType|SetEnvType|SetRulerType;\n\nexport const Setter = Any(SetBpm, SetBms, SetSubdivision, SetOsc, SetEnv, SetRuler);\n\nexport type SetterGroupType = NodeType & {\n    setters: SetterType[];\n};\n\nexport const SetterGroup = node/*<SetterGroupType>*/(\n    'SetterGroup',\n    All('(', Setter, Star(All(Semicolon, Setter)), ')'),\n    (setters: SetterType[]) => ({\n        setters,\n        len: sumLen(setters) + 2\n    })\n);\n\n//\n// comments\n//\n\nexport type CommentType = NodeType & {\n    comment: string;\n};\n\nexport const Comment = node/*<CommentType>*/(\n    'Comment',\n    /^#([^\\n]*)/,\n    ([comment]) => ({\n        comment,\n        len: comment.length + 1\n    })\n);\n\n//\n// sequence\n//\n\nexport type SequenceItemsType = RatioChordType|NoteType|ChordType|RestType|SetterGroupType|SetScaleType|SetRootType|CommentType;\n\nexport type SequenceType = NodeType & {\n    items: SequenceItemsType[];\n};\n\nexport const Sequence = node/*<SequenceType>*/(\n    'Sequence',\n    Star(Any(Comment, RatioChord, Note, Chord, Rest, SetterGroup, SetScale, SetRoot, BarLine, Whitespace)),\n    (items: SequenceItemsType[]) => ({\n        items,\n        len: sumLen(items)\n    })\n);\n\n//\n// params\n//\n\nexport type ParamEmbedType = NodeType;\n\nexport const ParamEmbed = node/*<ParamEmbedType>*/(\n    'ParamEmbed',\n    'embed',\n    () => ({\n        len: 5\n    })\n);\n\nexport type ParamType = ParamEmbedType;\n\nexport const Param = Any(ParamEmbed);\n\nexport type ParamGroupType = NodeType & {\n    params: ParamType[];\n};\n\nexport const ParamGroup = node/*<ParamGroupType>*/(\n    'ParamGroup',\n    All(Param, Star(All(Semicolon, Param)), ':'),\n    (params: ParamType[]) => ({\n        params,\n        len: sumLen(params) + 1\n    })\n);\nexport type XenpaperAST = NodeType & {\n    sequence?: SequenceType;\n    paramGroup?: ParamGroupType;\n};\n\nexport const XenpaperGrammar = node/*<XenpaperAST>*/(\n    'XenpaperGrammar',\n    All(Optional(ParamGroup), Optional(Sequence)),\n    (parts: Array<SequenceType>) => {\n        const paramGroup = parts.find(part => part.type === 'ParamGroup');\n        const sequence = parts.find(part => part.type === 'Sequence');\n        return {\n            sequence,\n            paramGroup,\n            len: sequence ? sequence.len : 0\n        };\n    }\n);\n\nconst parser = Parser(XenpaperGrammar);\n\nexport const XenpaperGrammarParser = (input: string): XenpaperAST => {\n    try {\n        return parser(input);\n    } catch(e) {\n        // eslint-disable-next-line no-console\n        console.error('e', e);\n        throw new Error(e.message.replace(/Remainder:.*/s, ''));\n    }\n};\n","import type {XenpaperAST} from './grammar';\n\nexport type HighlightColor = 'delimiter'\n    |'pitch'\n    |'chord'\n    |'scaleGroup'\n    |'scale'\n    |'setterGroup'\n    |'setter'\n    |'comment'\n    |'commentStart'\n    |'unknown'\n    |'error'\n    |'errorMessage';\n\nexport type CharData = {\n    color: HighlightColor;\n    playTime?: [number, number];\n};\n\nconst colorMap = new Map<string,HighlightColor>([\n    ['Semicolon','delimiter'],\n    ['Colon','delimiter'],\n    // ['PitchCents','pitch'],\n    // ['PitchOctaveDivision','pitch'],\n    // ['PitchRatio','pitch'],\n    // ['PitchDegree','pitch'],\n    // ['PitchHz','pitch'],\n    // ['OctaveModifier','pitch'],\n    ['Pitch','pitch'],\n    ['RatioChordPitch','pitch'],\n    ['Chord','chord'],\n    ['Chord.Whitespace','pitch'],\n    // ['RatioChord'],\n    ['Hold','pitch'],\n    ['Rest','delimiter'],\n    ['BarLine','delimiter'],\n    ['Whitespace','delimiter'],\n    ['EdoScale','scale'],\n    ['PitchGroupScale','scale'],\n    ['PitchGroupScale.Pitch','scale'],\n    ['PitchGroupScale.Whitespace','scale'],\n    ['RatioChordScale','scale'],\n    ['RatioChordScale.RatioChordPitch','scale'],\n    ['RatioChordScale.Colon','scale'],\n    ['ScaleOctaveMarker','scale'],\n    ['SetScale','scaleGroup'],\n    ['SetRoot','scaleGroup'],\n    ['SetRoot.Pitch','scale'],\n    ['SetBpm','setter'],\n    ['SetBms','setter'],\n    ['SetSubdivision','setter'],\n    ['SetOsc','setter'],\n    ['SetEnv','setter'],\n    ['SetRulerPlot','setter'],\n    ['SetRulerRange','setter'],\n    ['SetRulerRange.Pitch','setter'],\n    ['SetterGroup','setterGroup'],\n    ['SetterGroup.Semicolon','setterGroup'],\n    ['Comment','comment']\n]);\n\n// need to pass playhead time in\nconst extract = (chars: CharData[], data: any, parent: string, withinTime?: number): void => {\n    if(Array.isArray(data)) {\n        data.forEach(value => extract(chars, value, parent, withinTime));\n        return;\n    }\n    if(data instanceof Object) {\n        const color = colorMap.get(`${parent}.${data.type}`) || colorMap.get(data.type);\n        const time = withinTime ?? data.time;\n\n        if(typeof data.pos === 'number' && typeof data.len === 'number' && color) {\n            for(let i = 0; i < data.len; i++) {\n                chars[data.pos + i] = {\n                    color: (color === 'comment' && i === 0) ? 'commentStart' : color,\n                    playTime: time\n                };\n            }\n        }\n        Object.keys(data).forEach(key => {\n            extract(chars, data[key], data.type, time);\n        });\n        return;\n    }\n};\n\nexport const grammarToChars = ({sequence}: XenpaperAST): CharData[] => {\n    if(!sequence) return [];\n    const {items} = sequence;\n    const chars: CharData[] = [];\n    extract(chars, items, '');\n    return chars;\n};\n","import type {\n    XenpaperAST,\n    SetScaleType,\n    NoteType,\n    ChordType,\n    RatioChordType,\n    TailType,\n    PitchType,\n    PitchRatioType,\n    PitchCentsType,\n    PitchHzType,\n    PitchOctaveDivisionType,\n    PitchDegreeType,\n    PitchGroupScaleType,\n    EdoScaleType,\n    RatioChordScaleType,\n    RatioChordPitchType,\n    HoldType,\n    RestType,\n    SetterGroupType,\n    SetterType,\n    SetSubdivisionType,\n    SetBpmType,\n    SetBmsType,\n    SetRootType,\n    SetOscType,\n    SetEnvType,\n    SetRulerRangeType,\n    DelimiterType\n} from './grammar';\n\nimport type {\n    MoscScore,\n    MoscItem,\n    MoscNote,\n    MoscNoteMs,\n    MoscTempo,\n    MoscParam,\n    MoscEnd\n} from '@xenpaper/mosc';\n\nimport {\n    centsToRatio,\n    octaveDivisionToRatio,\n    timeToMs,\n    ratioToCents\n} from '@xenpaper/mosc';\n\n//\n// utils\n//\n\nconst limit = (name: string, value: number, min: number, max: number): void => {\n    if(value < min || value > max) {\n        throw new Error(`${name} must be between ${min} and ${max}, got ${value}`);\n    }\n};\n\n//\n// pitch math\n//\n\nexport const pitchToRatio = (pitch: PitchType, context: Context): number => {\n    const {scale, octaveSize} = context;\n    limit('Octave size', octaveSize, -20, 20);\n\n    const {type} = pitch.value;\n    const octaveMulti = Math.pow(octaveSize, pitch?.octave?.octave || 0);\n\n    if(type === 'PitchRatio') {\n        const {numerator, denominator} = pitch.value as PitchRatioType;\n        const ratio = numerator / denominator;\n        limit('Pitch ratio', ratio, 0, 100);\n        return ratio * octaveMulti;\n    }\n\n    if(type === 'PitchCents') {\n        const {cents} = pitch.value as PitchCentsType;\n        limit('Cents', cents, -12000, 12000);\n        return centsToRatio(cents) * octaveMulti;\n    }\n\n    if(type === 'PitchOctaveDivision') {\n        const {numerator, denominator, octaveSize} = pitch.value as PitchOctaveDivisionType;\n        return octaveDivisionToRatio(numerator, denominator, octaveSize) * octaveMulti;\n    }\n\n    if(type === 'PitchDegree') {\n        const {degree} = pitch.value as PitchDegreeType;\n        return pitchDegreeToRatio(degree, scale, octaveSize) * octaveMulti;\n    }\n\n    throw new Error(`Unknown pitch type \"${type}\"`);\n};\n\nconst edoToRatios = (edoSize: number, octaveSize: number): number[] => {\n    const ratios: number[] = [];\n    for(let i = 0; i < edoSize; i++) {\n        ratios.push(octaveDivisionToRatio(i, edoSize, octaveSize));\n    }\n    return ratios;\n};\n\nconst pitchDegreeWrap = (degree: number, scale: number[]): [number, number] => {\n    limit('Scale degree', degree, -1000, 1000);\n\n    const steps = scale.length;\n    let octave = 0;\n\n    while(degree >= steps && octave > -20) {\n        degree -= steps;\n        octave++;\n    }\n    while(degree < 0 && octave < 20) {\n        degree += steps;\n        octave--;\n    }\n\n    return [degree, octave];\n};\n\nconst pitchDegreeToRatio = (degree: number, scale: number[], octaveSize: number): number => {\n    limit('Octave size', octaveSize, -20, 20);\n\n    if(scale.length === 0) {\n        return 1;\n    }\n\n    const [wrappedDegree, octave] = pitchDegreeWrap(degree, scale);\n    return scale[wrappedDegree] * Math.pow(octaveSize, octave);\n};\n\nconst pitchToHz = (pitch: PitchType, context: Context): number => {\n    if(pitch.value.type === 'PitchHz') {\n        const octaveMulti = Math.pow(context.octaveSize, pitch?.octave?.octave || 0);\n        const hz = (pitch.value as PitchHzType).hz * octaveMulti;\n        limit('Hz', hz, 0, 20000);\n        return hz;\n    }\n    return pitchToRatio(pitch, context) * context.rootHz;\n};\n\nconst tailToTime = (tail: TailType|undefined, context: Context): {time: number, timeEnd: number} => {\n    const time = context.time;\n\n    const duration = tail && tail.type === 'Hold'\n        ? (tail as HoldType).length + 1\n        : 1;\n\n    context.time += duration * context.subdivision;\n    const timeEnd = context.time;\n\n    return {\n        time,\n        timeEnd\n    };\n};\n\n//\n// labels\n//\n\nconst ratioWrap = (ratio: number, octaveSize: number): number => {\n    while(ratio < 1) {\n        ratio *= octaveSize;\n    }\n    while(ratio > octaveSize) {\n        ratio /= octaveSize;\n    }\n    return ratio;\n};\n\nconst ratioToCentsLabel = (ratio: number, octaveSize: number): string => {\n    return `${ratioToCents(ratioWrap(ratio, octaveSize)).toFixed(1)}c`;\n};\n\nexport const pitchToLabel = (pitch: PitchType, context: Context): string => {\n    const {type} = pitch.value;\n\n    if(type === 'PitchHz') {\n        const {hz} = pitch.value as PitchHzType;\n        return `${hz}Hz`;\n    }\n\n    if(type === 'PitchCents') {\n        const {cents} = pitch.value as PitchCentsType;\n        return `${cents}c`;\n    }\n\n    const centsLabel = ratioToCentsLabel(pitchToRatio(pitch, context), context.octaveSize);\n\n    if(type === 'PitchRatio') {\n        const {numerator, denominator} = pitch.value as PitchRatioType;\n        return `${numerator}/${denominator}  ${centsLabel}`;\n    }\n\n    if(type === 'PitchOctaveDivision') {\n        const {numerator, denominator} = pitch.value as PitchOctaveDivisionType;\n        return `${numerator}\\\\${denominator}  ${centsLabel}`;\n    }\n\n    if(type === 'PitchDegree') {\n        const {degree} = pitch.value as PitchDegreeType;\n        const [wrappedDegree] = pitchDegreeWrap(degree, context.scale);\n        return context.scaleLabels[wrappedDegree];\n    }\n\n    throw new Error(`Unknown pitch type \"${type}\"`);\n};\n\nconst edoToLabels = (edoSize: number, ratios: number[], octaveSize: number): string[] => {\n    const labels: string[] = [];\n    for(let i = 0; i < edoSize; i++) {\n        const centsLabel = ratioToCentsLabel(ratios[i], octaveSize);\n        labels.push(`${i}\\\\${edoSize}  ${centsLabel}`);\n    }\n    return labels;\n};\n\n//\n// converters\n//\n\nconst ENV_VALUES = [0,0.003,0.006,0.01,0.033,0.1,0.33,1,3.3,10];\n\ntype Context = {\n    rootHz: number;\n    time: number;\n    subdivision: number;\n    scale: number[];\n    scaleLabels: string[];\n    octaveSize: number;\n};\n\nconst times: [number,number][] = [];\n\nconst noteToMosc = (note: NoteType, context: Context): MoscNote[] => {\n    const timeProps = tailToTime(note.tail, context);\n\n    // mutate ast node to add time\n    const arr: [number,number] = [timeProps.time, timeProps.timeEnd];\n    times.push(arr);\n    note.time = arr;\n\n    const hz = pitchToHz(note.pitch, context);\n    const label = pitchToLabel(note.pitch, context);\n\n    return [{\n        type: 'NOTE_TIME',\n        hz,\n        label,\n        ...timeProps\n    }];\n};\n\nconst chordToMosc = (chord: ChordType|RatioChordType, context: Context): MoscNote[] => {\n    const {tail, pitches} = chord;\n    const timeProps = tailToTime(tail, context);\n\n    // mutate ast node to add time\n    const arr: [number,number] = [timeProps.time, timeProps.timeEnd];\n    times.push(arr);\n    chord.time = arr;\n\n    const pitchTypes: MoscNote[] = pitches\n        .filter((pitch): pitch is PitchType => pitch.type === 'Pitch')\n        .map((pitch: any) => {\n\n            const hz = pitchToHz(pitch as PitchType, context);\n            const label = pitchToLabel(pitch as PitchType, context);\n\n            return {\n                type: 'NOTE_TIME',\n                hz,\n                label,\n                ...timeProps\n            };\n        });\n\n    const firstRatioPitch = pitches.find((pitch: PitchType|RatioChordPitchType|DelimiterType) => {\n        return pitch.type === 'RatioChordPitch';\n    }) as RatioChordPitchType|undefined;\n\n    const ratioPitchTypes: MoscNote[] = pitches\n        .filter((pitch): pitch is RatioChordPitchType => pitch.type === 'RatioChordPitch')\n        .map((pitch: any) => {\n            const numerator = (pitch as RatioChordPitchType).pitch;\n            const denominator = (firstRatioPitch as RatioChordPitchType).pitch;\n            return {\n                type: 'NOTE_TIME',\n                hz: numerator / denominator * context.rootHz,\n                label: `${numerator}/${denominator}  ${ratioToCentsLabel(numerator / denominator, context.octaveSize)}`,\n                ...timeProps\n            };\n        });\n\n    return pitchTypes.concat(ratioPitchTypes);\n};\n\nconst setScale = (setScale: SetScaleType, context: Context): void => {\n    const {scale} = setScale;\n    const {type} = scale;\n    if(type === 'PitchGroupScale') {\n        const {pitches, scaleOctaveMarker, pitchGroupScalePrefix} = scale as PitchGroupScaleType;\n\n        let filteredPitches: PitchType[] = pitches.filter((pitch): pitch is PitchType => !pitch.delimiter) as PitchType[];\n\n        if(pitchGroupScalePrefix && pitchGroupScalePrefix.prefix === 'm') {\n            const degreePitches: PitchDegreeType[] = [\n                {\n                    type: 'PitchDegree',\n                    degree: 0,\n                    delimiter: false,\n                    pos: pitchGroupScalePrefix.pos,\n                    len: 0\n                }\n            ];\n\n            let degree = 0;\n            filteredPitches.forEach(pitch => {\n                if(pitch.value.type !== 'PitchDegree') {\n                    throw new Error('Mode scales {m} should only contain pitch degrees (0, 1, etc), not ratios, hz or any other kind of pitch');\n                }\n                degree += (pitch.value as PitchDegreeType).degree;\n\n                degreePitches.push({\n                    ...pitch.value,\n                    degree\n                });\n            });\n\n            degreePitches.pop(); // ignore last degree which is assumed to complete the octave\n            filteredPitches = degreePitches.map(value => ({value})) as PitchType[];\n        }\n\n        context.scale = filteredPitches.map(pitch => pitchToRatio(pitch, context));\n        context.scaleLabels = filteredPitches.map(pitch => pitchToLabel(pitch, context));\n\n        if(scaleOctaveMarker) {\n            context.octaveSize = context.scale.pop() || 2;\n            context.scaleLabels.pop();\n        }\n\n        return;\n    }\n\n    if(type === 'EdoScale') {\n        const {divisions, octaveSize} = scale as EdoScaleType;\n        context.scale = edoToRatios(divisions, octaveSize);\n        context.scaleLabels = edoToLabels(divisions, context.scale, octaveSize);\n        context.octaveSize = octaveSize;\n        return;\n    }\n\n    if(type === 'RatioChordScale') {\n        const {pitches, scaleOctaveMarker} = scale as RatioChordScaleType;\n\n        const ratios: number[] = pitches\n            .filter((pitch): pitch is RatioChordPitchType => !pitch.delimiter)\n            .map(pitch => pitch.pitch);\n\n        context.scale = ratios.map(ratio => ratio / ratios[0]);\n        context.scaleLabels = ratios.map(ratio => {\n            const centsLabel = ratioToCentsLabel(ratio/ratios[0], 2);\n            return `${ratio}/${ratios[0]}  ${centsLabel}`;\n        });\n\n        if(scaleOctaveMarker) {\n            context.octaveSize = context.scale.pop() || 2;\n            context.scaleLabels.pop();\n        }\n\n        return;\n    }\n\n    throw new Error(`Unknown scale type \"${type}\"`);\n};\n\nconst setterToMosc = (setter: SetterType, context: Context): MoscItem[] => {\n    const {type, delimiter} = setter;\n\n    if(delimiter) return [];\n\n    if(type === 'SetBpm') {\n        const {bpm} = setter as SetBpmType;\n        return [{\n            type: 'TEMPO',\n            time: context.time,\n            bpm,\n            lerp: false\n        }];\n    }\n\n    if(type === 'SetBms') {\n        const {bms} = setter as SetBmsType;\n        return [{\n            type: 'TEMPO',\n            time: context.time,\n            bpm: 60000 / bms,\n            lerp: false\n        }];\n    }\n\n    if(type === 'SetSubdivision') {\n        const {subdivision, denominator} = setter as SetSubdivisionType;\n        context.subdivision = (denominator ?? 1) / subdivision;\n        return [];\n    }\n\n    if(type === 'SetOsc') {\n        const {osc} = setter as SetOscType;\n        return [{\n            type: 'PARAM_TIME',\n            time: context.time,\n            value: {\n                type: 'osc',\n                osc\n            }\n        }];\n    }\n\n    if(type === 'SetEnv') {\n        const {a,d,s,r} = setter as SetEnvType;\n        return [{\n            type: 'PARAM_TIME',\n            time: context.time,\n            value: {\n                type: 'env',\n                a: ENV_VALUES[a] || 0,\n                d: ENV_VALUES[d] || 0,\n                s: s / 9,\n                r: ENV_VALUES[r] || 0\n            }\n        }];\n    }\n\n    return [];\n};\n\nconst rulerStateCaptureRootHz = (initial: InitialRulerState, context: Context): InitialRulerState => {\n    if(initial.rootHz) {\n        return initial;\n    }\n    return {\n        ...initial,\n        rootHz: context.rootHz,\n        octaveSize: context.octaveSize\n    };\n};\n\nexport type InitialRulerState = {\n    lowHz?: number;\n    highHz?: number;\n    rootHz?: number;\n    octaveSize?: number;\n    plots: MoscNoteMs[][];\n};\n\nconst setterToRulerState = (initial: InitialRulerState, setter: SetterType, context: Context): InitialRulerState => {\n    const {type, delimiter} = setter;\n\n    if(delimiter) return initial;\n\n    if(type === 'SetRulerPlot') {\n\n        const newPlot = context.scale.map((ratio, i): MoscNoteMs => ({\n            type: 'NOTE_MS',\n            ms: context.time,\n            msEnd: context.time,\n            hz: ratio * context.rootHz,\n            label: context.scaleLabels[i]\n        }));\n\n        return {\n            ...initial,\n            plots: [...initial.plots, newPlot]\n        };\n    }\n\n    if(type === 'SetRulerRange') {\n        if(initial.lowHz) {\n            return initial;\n        }\n\n        const {low, high} = setter as SetRulerRangeType;\n        return {\n            ...initial,\n            lowHz: pitchToHz(low, context),\n            highHz: pitchToHz(high, context)\n        };\n    }\n\n    return initial;\n};\n\nexport type Processed = {\n    score?: MoscScore;\n    initialRulerState?: InitialRulerState;\n};\n\nexport const processGrammar = (grammar: XenpaperAST): Processed => {\n\n    // console.log('grammar', JSON.stringify(grammar));\n\n    const grammarSequence = grammar.sequence;\n    if(!grammarSequence) {\n        return {};\n    }\n\n    const INITIAL_TEMPO: MoscTempo = {\n        type: 'TEMPO',\n        time: 0,\n        bpm: 120,\n        lerp: false\n    };\n\n    const INITIAL_OSC: MoscParam = {\n        type: 'PARAM_TIME',\n        time: 0,\n        value: {\n            type: 'osc',\n            osc: 'triangle'\n        }\n    };\n\n    const INITIAL_ENV: MoscParam = {\n        type: 'PARAM_TIME',\n        time: 0,\n        value: {\n            type: 'env',\n            a: ENV_VALUES[2],\n            d: ENV_VALUES[8],\n            s: 0.5,\n            r: ENV_VALUES[6]\n        }\n    };\n\n    const scale = edoToRatios(12, 2);\n\n    const context: Context = {\n        rootHz: 220,\n        time: 0,\n        subdivision: 0.5,\n        scale,\n        scaleLabels: edoToLabels(12, scale, 2),\n        octaveSize: 2\n    };\n\n    const moscItems: MoscItem[] = [];\n    let initialRulerState: InitialRulerState = {\n        plots: []\n    };\n\n    grammarSequence.items.forEach((item): void => {\n        const {type} = item;\n        if(type === 'Comment' || type === 'BarLine' || type === 'Whitespace') {\n            // do nothing\n            return;\n        }\n\n        if(type === 'SetScale') {\n            setScale(item as SetScaleType, context);\n            return;\n        }\n\n        if(type === 'SetRoot') {\n            const {pitch} = item as SetRootType;\n            context.rootHz = pitchToHz(pitch, context);\n            return;\n        }\n\n        if(type === 'Note') {\n            moscItems.push(...noteToMosc(item as NoteType, context));\n            initialRulerState = rulerStateCaptureRootHz(initialRulerState, context);\n            return;\n        }\n\n        if(type === 'Rest') {\n            const {time} = context;\n            const rest = item as RestType;\n            context.time += rest.length * context.subdivision;\n            // mutate ast node to add time\n            const arr: [number,number] = [time, context.time];\n            times.push(arr);\n            rest.time = arr;\n            return;\n        }\n\n        if(type === 'Chord') {\n            moscItems.push(...chordToMosc(item as ChordType, context));\n            return;\n        }\n\n        if(type === 'RatioChord') {\n            moscItems.push(...chordToMosc(item as RatioChordType, context));\n            initialRulerState = rulerStateCaptureRootHz(initialRulerState, context);\n            return;\n        }\n\n        if(type === 'SetterGroup') {\n            (item as SetterGroupType).setters.forEach(setter => {\n                moscItems.push(...setterToMosc(setter, context));\n                initialRulerState = setterToRulerState(initialRulerState, setter, context);\n            });\n            return;\n        }\n\n        throw new Error(`Unknown sequence item \"${type}\"`);\n    });\n\n    initialRulerState = rulerStateCaptureRootHz(initialRulerState, context);\n\n    const sequence = [\n        INITIAL_TEMPO,\n        INITIAL_OSC,\n        INITIAL_ENV,\n        ...moscItems,\n        {\n            type: 'END_TIME',\n            time: context.time\n        } as MoscEnd\n    ];\n\n    // translate times from steps to ms\n    const thisTimeToMs = timeToMs(sequence);\n\n    // omg are we really mutating many time items throughout the AST tree via mutations? golly!\n    times.forEach(time => {\n        time[0] = thisTimeToMs(time[0]);\n        time[1] = thisTimeToMs(time[1]);\n    });\n\n    const score = {\n        sequence,\n        lengthTime: context.time\n    };\n\n    return {\n        score,\n        initialRulerState\n    };\n};\n","import {useState, useCallback, useEffect} from 'react';\n\nexport const hashify = (newHash: string): string => {\n    return encodeURIComponent(newHash)\n        .replace(/_/g, '%_')\n        .replace(/%20/g, '_');\n};\n\nconst reverseString = (str: string): string => {\n    return str\n        .split('')\n        .reverse()\n        .join('');\n};\n\nexport const unhashify = (hash: string): string => {\n    return decodeURIComponent(\n        // browser support for negaitve lookbehinds is patchy\n        // and we want to replace all _ that arent preceded by % with %20\n        // so reverse the string, replace with a negative lookahead (well supported) and reverse again\n        reverseString(\n            reverseString(hash).replace(/_(?!%)/g, reverseString('%20'))\n        ).replace(/%_/g, '_')\n    );\n};\n\ntype UseHashResult = readonly [string, (newHash: string) => void];\n\nexport const useHash = (): UseHashResult => {\n    const [hash, setHash] = useState(() => {\n        let initialHash = unhashify(window.location.hash.substr(1));\n        if(!initialHash && window.localStorage) {\n            initialHash = window.localStorage.getItem('lasttune') ?? '';\n        }\n        return initialHash;\n    });\n\n    const onHashChange = useCallback(() => {\n        setHash(window.location.hash);\n    }, []);\n\n    useEffect(() => {\n        window.addEventListener('hashchange', onHashChange);\n        return () => {\n            window.removeEventListener('hashchange', onHashChange);\n        };\n    }, [onHashChange]);\n\n    const _setHash = useCallback((newHash: string) => {\n        const newHashEncoded = hashify(newHash);\n        if (newHashEncoded !== hash) {\n            // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n            // @ts-ignore\n            window.history.replaceState(undefined, undefined, '#' + newHashEncoded);\n            window.localStorage?.setItem('lasttune', newHash);\n        }\n    }, [hash]);\n\n    return [hash, _setHash] as const;\n};\n","import {useState, useEffect} from 'react';\n\nconst windowLoadPromise = new Promise(resolve => {\n    const handleLoad = () => {\n        window.removeEventListener('load', handleLoad);\n        resolve(null);\n    };\n    window.addEventListener('load', handleLoad);\n});\n\nexport const useWindowLoaded = (): boolean => {\n\n    const [loaded, setLoaded] = useState(false);\n\n    useEffect(() => {\n        (async () => {\n            await windowLoadPromise;\n            await (document as any).fonts.ready;\n            setLoaded(true);\n        })();\n    }, []);\n\n    return loaded;\n};\n","import type {MoscScoreMs, MoscNoteMs, MoscItemMs, MoscParamMs, MoscEndMs} from '@xenpaper/mosc';\nimport {SoundEngine, scoreToMs} from '@xenpaper/mosc';\nimport * as Tone from 'tone';\n\n//\n// utils\n//\n\nfunction flatMap<I,O>(arr: I[], mapper: (item: I) => O[]): O[] {\n    const out: O[] = [];\n    arr.forEach(item => out.push(...mapper(item)));\n    return out;\n}\n\n//\n// consts\n//\n\nconst OSC_VOLUME = -18;\n\nexport const OSC_BASE_TYPES = [\n    'sine',\n    'sawtooth',\n    'square',\n    'triangle'\n];\n\nexport let OSC_PARTIAL_SUFFIXES: string[] = [];\nfor(let i = 1; i < 33; i++) {\n    OSC_PARTIAL_SUFFIXES.push(`${i}`);\n}\n\nexport const OSC_TYPES_EXPANDED = flatMap(OSC_BASE_TYPES, base => [\n    base,\n    `fm${base}`,\n    `am${base}`,\n    `fat${base}`\n]);\n\nexport const OSC_TYPES = flatMap(OSC_TYPES_EXPANDED, type => [\n    type,\n    ...OSC_PARTIAL_SUFFIXES.map(suffix => `${type}${suffix}`)\n]);\n\nexport class SoundEngineTonejs extends SoundEngine {\n\n    _started = false;\n    _endMs = 0;\n    _loopEndMs = 0;\n    _activeNoteEvents = new Set<MoscItemMs>();\n\n    synth = new Tone.PolySynth(Tone.Synth, {\n        oscillator: {\n            type: 'sine',\n            volume: OSC_VOLUME\n        },\n        envelope: {\n            attack: 0.01,\n            sustain: 0.5,\n            decay: 0.25,\n            release: 0.5\n        }\n    }).chain(Tone.Destination);\n\n    playing(): boolean {\n        return Tone.Transport.state === 'started';\n    }\n\n    looping(): boolean {\n        return Tone.Transport.loop;\n    }\n\n    position(): number {\n        return Tone.Transport.seconds * 1000;\n    }\n\n    endPosition(): number {\n        return this._endMs;\n    }\n\n    async start(): Promise<void> {\n        if(!this._started) {\n            await Tone.start();\n            this._started = true;\n\n            const onEnd = () => {\n                this.synth.releaseAll();\n                this._activeNoteEvents.forEach(noteMs => {\n                    this._triggerEvent('note', noteMs, false);\n                });\n                this._activeNoteEvents.clear();\n            };\n\n            Tone.Transport.on('stop', onEnd);\n            Tone.Transport.on('loop', onEnd);\n        }\n    }\n\n    async play(): Promise<void> {\n        await this.start();\n        Tone.Transport.start();\n    }\n\n    async pause(): Promise<void> {\n        await this.start();\n        Tone.Transport.stop();\n    }\n\n    async gotoMs(ms: number): Promise<void> {\n        Tone.Transport.seconds = ms * 0.001;\n    }\n\n    setLoop(loop: boolean, startMs: number = 0, endMs: number = 0): void {\n        this.setLoopActive(loop);\n        this.setLoopStart(startMs);\n        this.setLoopEnd(endMs);\n    }\n\n    setLoopActive(loop: boolean = true): void {\n        Tone.Transport.loop = loop;\n    }\n\n    setLoopStart(ms: number = 0): void {\n        Tone.Transport.loopStart = ms * 0.001;\n    }\n\n    setLoopEnd(ms: number = 0): void {\n        this._loopEndMs = ms;\n        Tone.Transport.loopEnd = (ms === 0 ? this._endMs : ms) * 0.001;\n    }\n\n    async setScore(scoreMs: MoscScoreMs): Promise<void> {\n        this.scoreMs = scoreMs;\n\n        // clear all previous notes from tone transport\n        Tone.Transport.cancel();\n\n        // add all new notes to tone transport\n        this.scoreMs.sequence.forEach((item: MoscItemMs): void => {\n            if(item.type === 'NOTE_MS') {\n                const noteMs = item as MoscNoteMs;\n                Tone.Transport.schedule((time: number) => {\n                    this.synth.triggerAttackRelease(\n                        noteMs.hz,\n                        (noteMs.msEnd * 0.001) - (noteMs.ms * 0.001),\n                        time\n                    );\n                    this._activeNoteEvents.add(noteMs);\n                    this._triggerEvent('note', noteMs, true);\n                }, noteMs.ms * 0.001 + 0.1); // schedule in the future slightly to avoid double note playing at end\n\n                Tone.Transport.schedule((time: number) => {\n                    this._activeNoteEvents.delete(noteMs);\n                    this._triggerEvent('note', noteMs, false);\n                }, noteMs.msEnd * 0.001 + 0.1);\n\n                return;\n            }\n\n            if(item.type === 'PARAM_MS') {\n                const paramMs = item as MoscParamMs;\n                Tone.Transport.schedule(() => {\n                    // this is inaccurate\n                    // as tonejs calls these callbacks several ms ahead of schedule\n                    // and relies on scheduled events to pass the provided time\n                    // to schedule correctly, but param changes cannot accept\n                    // the time argument\n                    if(paramMs.value.type === 'osc' && OSC_TYPES.includes(paramMs.value.osc)) {\n                        this.synth.set({\n                            oscillator: {\n                                type: paramMs.value.osc,\n                                volume: OSC_VOLUME\n                            }\n                        });\n                    }\n                    if(paramMs.value.type === 'env') {\n                        this.synth.set({\n                            envelope: {\n                                attack: paramMs.value.a,\n                                decay: paramMs.value.d,\n                                sustain: paramMs.value.s,\n                                release: paramMs.value.r\n                            }\n                        });\n                    }\n\n                }, paramMs.ms * 0.001);\n\n                return;\n            }\n\n            if(item.type === 'END_MS') {\n                this._endMs = (item as MoscEndMs).ms;\n                if(this._loopEndMs === 0) {\n                    this.setLoopEnd(0);\n                }\n\n                Tone.Transport.schedule(async () => {\n                    if(Tone.Transport.loop) return;\n\n                    Tone.Transport.stop();\n                    this._triggerEvent('end', undefined);\n                }, this._endMs * 0.001);\n\n                return;\n            }\n\n            // @ts-ignore\n            throw new Error(`Unexpected item type ${item.type} encountered`);\n        });\n    }\n}\n","import React, {useState, useCallback, useEffect} from 'react';\nimport {AppWrapper} from './AppWrapper';\nimport {IconToggle} from './component/IconToggle';\nimport {Codearea} from './component/Codearea';\nimport {ErrorMessage} from './component/ErrorMessage';\nimport {LoaderPane} from './component/LoaderPane';\nimport {Char} from './component/Char';\nimport {Box, Flex} from './layout/Layout';\nimport {Sidebar, SidebarInfo, SidebarShare, Footer} from './Sidebars';\nimport styled from 'styled-components';\n\nimport {PitchRuler, useRulerState} from './PitchRuler';\nimport type {RulerState} from './PitchRuler';\n\nimport {XenpaperGrammarParser} from './data/grammar';\nimport type {XenpaperAST, SetterGroupType} from './data/grammar';\n\nimport {grammarToChars} from './data/grammar-to-chars';\nimport {processGrammar} from './data/process-grammar';\nimport type {InitialRulerState} from './data/process-grammar';\nimport type {MoscScore} from '@xenpaper/mosc';\nimport type {HighlightColor, CharData} from './data/grammar-to-chars';\n\nimport {useHash, hashify} from './hooks/useHash';\nimport {useWindowLoaded} from './hooks/useWindowLoaded';\n\nimport {useDendriform, useInput} from 'dendriform';\nimport type {Dendriform} from 'dendriform';\nimport {setAutoFreeze, enableMapSet} from 'immer';\nsetAutoFreeze(false); // sadly I am relying on mutations within the xenpaper AST because who cares\nenableMapSet();\n\nimport {scoreToMs} from '@xenpaper/mosc';\nimport type {SoundEngine} from '@xenpaper/mosc';\nimport {SoundEngineTonejs} from '@xenpaper/sound-engine-tonejs';\n\nimport {Helmet} from 'react-helmet';\n\n//\n// sound engine instance\n//\n\nconst soundEngine: SoundEngine = new SoundEngineTonejs();\n\n//\n// xenpaper ast parsing\n//\n\ntype Parsed = {\n    parsed?: XenpaperAST;\n    chars?: CharData[];\n    score?: MoscScore;\n    initialRulerState?: InitialRulerState;\n    error: string;\n};\n\nconst parse = (unparsed: string): Parsed => {\n    try {\n        const parsed = XenpaperGrammarParser(unparsed);\n        const {score, initialRulerState} = processGrammar(parsed);\n        const chars = grammarToChars(parsed);\n\n        if(score) {\n            const scoreMs = scoreToMs(score);\n            soundEngine.setScore(scoreMs);\n        }\n\n        return {\n            parsed,\n            chars,\n            score,\n            initialRulerState,\n            error: ''\n        };\n\n    } catch(e) {\n        const matched = e.message.match(/Unexpected token at (\\d+):(\\d+)/);\n\n        const lineNumber: number = matched ? Number(matched[1]) - 1 : -1;\n        const colNumber: number = matched ? Number(matched[2]) - 1 : -1;\n\n        const chars: CharData[] = [];\n        let lineCount = 0;\n        let colCount = 0;\n        let error;\n        let errorAt;\n\n        for(let i = 0; i < unparsed.length + 40; i++) {\n            if(lineCount === lineNumber && colCount === colNumber) {\n                errorAt = i;\n            }\n            if (unparsed[i] === '\\n') {\n                lineCount++;\n                colCount = 0;\n\n            } else {\n                colCount++;\n            }\n        }\n\n        if(typeof errorAt === 'number') {\n            error = unparsed[errorAt] !== undefined\n                ? e.message.replace('Unexpected token ', `Unexpected token \"${unparsed[errorAt]}\" `)\n                : e.message;\n\n            chars[errorAt] = {\n                color: 'error'\n            };\n        }\n\n        return {\n            parsed: undefined,\n            chars,\n            score: undefined,\n            initialRulerState: undefined,\n            error\n        };\n    }\n};\n\nconst getMsAtLine = (tune: string, chars: CharData[]|undefined, line: number): number => {\n    if(line === 0) {\n        return 0;\n    }\n    let ms = 0;\n    let counted = 0;\n    const tuneSplit = tune.split('');\n    for(let i = 0; i < tuneSplit.length; i++) {\n        const chr = tuneSplit[i];\n        const ch = chars?.[i];\n        const [,end] = ch?.playTime ?? [];\n        if(end !== undefined) {\n            ms = end;\n        }\n        if(chr === '\\n') {\n            counted++;\n            if(counted === line) {\n                return ms;\n            }\n        }\n    }\n    return 0;\n};\n\n//\n// icons\n//\n\nconst PLAY_PATHS = {\n    paused: ['M 0 0 L 12 6 L 0 12 Z'],\n    playing: ['M 0 0 L 4 0 L 4 12 L 0 12 Z', 'M 8 0 L 12 0 L 12 12 L 8 12 Z']\n    // stopped: ['M 0 0 L 12 0 L 12 12 L 0 12 Z'],\n};\n\n//\n// application component with loader\n//\n\nexport function Xenpaper(): React.ReactElement {\n    const loaded = useWindowLoaded();\n\n    return <AppWrapper>\n        <LoaderPane height=\"100vh\" loaded={loaded}>\n            <XenpaperApp loaded={loaded} />\n        </LoaderPane>\n    </AppWrapper>;\n}\n\n//\n// application component\n//\n\nexport type SidebarState = 'info'|'share'|'ruler'|'none';\n\n// type RealtimeState = {\n//     on: boolean;\n//     activeNotes: number[];\n// };\n\nexport type TuneForm = {\n    tune: string;\n    embed: boolean;\n    hash: string;\n    url: string;\n    urlEmbed: string;\n};\n\ntype Props = {\n    loaded: boolean;\n};\n\nexport function XenpaperApp(props: Props): React.ReactElement {\n    const {loaded} = props;\n\n    //\n    // dendriforms with application state\n    //\n\n    const [hash, setHash] = useHash();\n\n    const tuneForm = useDendriform<TuneForm>(() => {\n        let embed = false;\n        let tune = hash;\n        if(tune.startsWith('embed:')) {\n            embed = true;\n            tune = tune.substr(6);\n        }\n        return {\n            tune,\n            embed,\n            hash: '',\n            url: '',\n            urlEmbed: ''\n        };\n    }, {history: 300});\n\n    tuneForm.useDerive(newValue => {\n        let hash = newValue.tune;\n        const hashified = hashify(hash);\n\n        if(newValue.embed) {\n            hash = `embed:${hash}`;\n        }\n\n        const url = `https://xenpaper.com/#${hashified}`;\n        const urlEmbed = `https://xenpaper.com/#embed:${hashified}`;\n\n        tuneForm.branch('hash').set(hash);\n        tuneForm.branch('url').set(url);\n        tuneForm.branch('urlEmbed').set(urlEmbed);\n    });\n\n    tuneForm.branch('hash').useChange(hash => {\n        setHash(hash);\n    });\n\n    const parsedForm = useDendriform<Parsed>(() => parse(tuneForm.value.tune));\n\n    tuneForm.useDerive((value) => {\n        parsedForm.set(parse(value.tune));\n    });\n\n    //\n    // state syncing between sound engine and react\n    //\n\n    const playing = useDendriform<boolean>(false);\n    const selectedLine = useDendriform<number>(0);\n    selectedLine.useChange(line => {\n        soundEngine.setLoopStart(getMsAtLine(tuneForm.value.tune, parsedForm.value.chars, line));\n    });\n\n    useEffect(() => {\n        return soundEngine.onEnd(() => {\n            playing.set(false);\n        });\n    }, []);\n\n    const looping = useDendriform<boolean>(false);\n\n    //\n    // ruler state\n    //\n\n    const rulerState = useRulerState(parsedForm.value.initialRulerState);\n\n    useEffect(() => {\n        return soundEngine.onNote((note, on) => {\n            const id = `${note.ms}-${note.hz}`;\n            rulerState.set(draft => {\n                if(on) {\n                    draft.notesActive.set(id, note);\n                    draft.notes.set(id, note);\n                } else {\n                    draft.notesActive.delete(id);\n                }\n            });\n        });\n    }, []);\n\n    parsedForm.branch('initialRulerState').useChange((initialRulerState) => {\n        rulerState.set(draft => {\n            draft.rootHz = initialRulerState?.rootHz;\n            draft.octaveSize = initialRulerState?.octaveSize;\n            draft.plots = initialRulerState?.plots;\n        });\n    });\n\n    //\n    // sound engine callbacks\n    //\n\n    const handleSetPlayback = useCallback((play: boolean) => {\n        if(parsedForm.value.error) return;\n\n        soundEngine.gotoMs(getMsAtLine(tuneForm.value.tune, parsedForm.value.chars, selectedLine.value));\n\n        playing.set(play);\n\n        if(play) {\n            soundEngine.play();\n            rulerState.set(draft => {\n                draft.notes.clear();\n            });\n        } else {\n            soundEngine.pause();\n        }\n    }, []);\n\n    const handleTogglePlayback = useCallback((state: string) => {\n        handleSetPlayback(state === 'paused');\n    }, []);\n\n    const handleToggleLoop = useCallback(() => {\n        const newValue = !looping.value;\n        looping.set(newValue);\n        soundEngine.setLoopActive(newValue);\n    }, []);\n\n    //\n    // special key combos\n    //\n\n    useEffect(() => {\n        const callback = (event: KeyboardEvent) => {\n            if((event.ctrlKey || event.metaKey) && event.keyCode === 13) {\n                handleSetPlayback(playing.value);\n            }\n            if((event.ctrlKey || event.metaKey) && event.keyCode === 90) {\n                event.preventDefault();\n                if(event.shiftKey) {\n                    tuneForm.redo();\n                } else {\n                    tuneForm.undo();\n                }\n\n            }\n        };\n\n        document.addEventListener('keydown', callback);\n        return () => document.removeEventListener('keydown', callback);\n    }, []);\n\n    //\n    // sidebar state\n    //\n\n    const [sidebarState, setSidebar] = useState<SidebarState>(() => {\n        return parsedForm.value?.initialRulerState?.lowHz ? 'ruler' : 'info';\n    });\n\n    const toggleSidebarInfo = useCallback(() => {\n        setSidebar(s => s !== 'info' ? 'info' : 'none');\n    }, []);\n\n    const toggleSidebarShare = useCallback(() => {\n        setSidebar(s => s !== 'share' ? 'share' : 'none');\n    }, []);\n\n    const toggleSidebarRuler = useCallback(() => {\n        setSidebar(s => s !== 'ruler' ? 'ruler' : 'none');\n    }, []);\n\n    const onSetTune = useCallback(async (tune: string): Promise<void> => {\n        tuneForm.branch('tune').set(tune);\n        await soundEngine.gotoMs(0);\n        handleSetPlayback(true);\n    }, []);\n\n    const codepaneContainerProps = {};\n\n    //\n    // elements\n    //\n\n    const playPause = playing.render(form => {\n        return <IconToggle\n            state={form.useValue() ? 'playing' : 'paused'}\n            paths={PLAY_PATHS}\n            onClick={handleTogglePlayback}\n            loaded={loaded}\n            hoverBackground\n            large={!tuneForm.branch('embed').useValue()}\n        />;\n    }, [loaded]);\n\n    const undoRedo = tuneForm.render(form => {\n        const {canUndo, canRedo} = form.useHistory();\n        return <>\n            <SideButton onClick={form.undo} disabled={!canUndo}>Undo</SideButton>\n            <SideButton onClick={form.redo} disabled={!canRedo}>Redo</SideButton>\n        </>;\n    });\n\n    const loop = looping.render(looping => {\n        return <SideButton onClick={handleToggleLoop} active={looping.useValue()}>Loop</SideButton>;\n    });\n\n    const sidebarToggles = <>\n        <SideButton onClick={toggleSidebarInfo}>Info</SideButton>\n        <SideButton onClick={toggleSidebarShare}>Share</SideButton>\n        <SideButton onClick={toggleSidebarRuler}>Ruler</SideButton>\n    </>;\n\n    const sidebar = <>\n        {sidebarState === 'info' &&\n            <SidebarInfo onSetTune={onSetTune} setSidebar={setSidebar} />\n        }\n        {sidebarState === 'share' && tuneForm.render(form => {\n            const url = form.branch('url').useValue();\n            const urlEmbed = form.branch('urlEmbed').useValue();\n            return <SidebarShare setSidebar={setSidebar} url={url} urlEmbed={urlEmbed} />;\n        })}\n        {sidebarState === 'ruler' &&\n            <Sidebar setSidebar={setSidebar} title=\"Pitch ruler\" desc=\"Click and drag to pan, use mousewheel to zoom.\">\n                <PitchRuler rulerState={rulerState} />\n            </Sidebar>\n        }\n    </>;\n\n    const code = <CodePanel tuneForm={tuneForm} parsedForm={parsedForm} selectedLine={selectedLine} />;\n\n    const htmlTitle = <SetHtmlTitle tuneForm={tuneForm} />;\n\n    const openOnXenpaper = tuneForm.render('url', form => (\n        <EditOnXenpaperButton href={form.useValue()} target=\"_blank\">Edit on Xenpaper</EditOnXenpaperButton>\n    ));\n\n    const embedLayout = tuneForm.branch('embed').useValue();\n\n    if(embedLayout) {\n        return <EmbedLayout\n            playPause={playPause}\n            loop={loop}\n            code={code}\n            openOnXenpaper={openOnXenpaper}\n            htmlTitle={htmlTitle}\n            codepaneContainerProps={codepaneContainerProps}\n        />;\n    }\n\n    return <NormalLayout\n        playPause={playPause}\n        undoRedo={undoRedo}\n        loop={loop}\n        code={code}\n        htmlTitle={htmlTitle}\n        sidebarToggles={sidebarToggles}\n        sidebar={sidebar}\n        codepaneContainerProps={codepaneContainerProps}\n    />;\n}\n\n//\n// layouts\n//\n\ntype NormalLayoutProps = {\n    playPause: React.ReactNode;\n    undoRedo: React.ReactNode;\n    loop: React.ReactNode;\n    code: React.ReactNode;\n    htmlTitle: React.ReactNode;\n    sidebarToggles: React.ReactNode;\n    sidebar: React.ReactNode;\n    codepaneContainerProps: {[prop: string]: unknown};\n};\n\nfunction NormalLayout(props: NormalLayoutProps): React.ReactElement {\n    const {\n        playPause,\n        undoRedo,\n        loop,\n        code,\n        htmlTitle,\n        sidebarToggles,\n        sidebar,\n        codepaneContainerProps\n    } = props;\n\n    return <Flex height=\"100vh\" flexDirection=\"column\">\n        <Flex display={['block','flex']} flexGrow=\"1\" flexShrink=\"1\" minHeight=\"0\" position=\"relative\">\n            {/* toolbar on mobile */}\n            <Toolbar display={['flex','none']} position=\"fixed\" top={0} width=\"100%\">\n                {playPause}\n                {undoRedo}\n                {loop}\n            </Toolbar>\n            {/* toolbar on desktop */}\n            <Toolbar display={['none','block']} mt={4} px={2} pt=\"12px\">\n                <Box mb={3}>\n                    {playPause}\n                </Box>\n                {undoRedo}\n                {loop}\n                <Hr my={2} />\n                {sidebarToggles}\n            </Toolbar>\n            {/* codepane */}\n            <Box flexGrow=\"1\" flexShrink=\"1\" pl={[0,3]} overflow=\"auto\" mt={3} pt={['24px',3]} {...codepaneContainerProps}>\n                {code}\n            </Box>\n            {/* horizontal rule on mobile */}\n            <Hr display={['block', 'none']} mt={4} />\n            {/* more tool buttons on mobile */}\n            <Box display={['flex', 'none']}>\n                {sidebarToggles}\n            </Box>\n            {/* sidebars */}\n            {sidebar}\n        </Flex>\n        <Footer display={['none', 'none', 'block']} />\n        {htmlTitle}\n    </Flex>;\n}\n\ntype EmbedLayoutProps = {\n    playPause: React.ReactNode;\n    loop: React.ReactNode;\n    code: React.ReactNode;\n    openOnXenpaper: React.ReactNode;\n    htmlTitle: React.ReactNode;\n    codepaneContainerProps: {[prop: string]: unknown};\n};\n\nfunction EmbedLayout(props: EmbedLayoutProps): React.ReactElement {\n    const {\n        playPause,\n        loop,\n        code,\n        htmlTitle,\n        openOnXenpaper,\n        codepaneContainerProps\n    } = props;\n\n    return <Flex height=\"100vh\" flexDirection=\"column\">\n        <Flex flexGrow=\"1\" flexShrink=\"1\" minHeight=\"0\" position=\"relative\">\n            <Toolbar display=\"flex\" position=\"fixed\" top={0} width=\"100%\">\n                {playPause}\n                {loop}\n                {openOnXenpaper}\n            </Toolbar>\n            <Box flexGrow=\"1\" flexShrink=\"1\" overflow=\"auto\" mt={3} pt=\"24px\" {...codepaneContainerProps}>\n                {code}\n            </Box>\n        </Flex>\n        {htmlTitle}\n    </Flex>;\n}\n\n//\n// codepanel\n//\n\ntype CodePanelProps = {\n    tuneForm: Dendriform<TuneForm>;\n    parsedForm: Dendriform<Parsed>;\n    selectedLine: Dendriform<number>;\n};\n\nfunction CodePanel(props: CodePanelProps): React.ReactElement {\n    return props.tuneForm.render(form => {\n\n        const embed = form.branch('embed').useValue();\n\n        // get dendriform state values\n        const {chars, error} = props.parsedForm.useValue();\n\n        // use value with a 200ms debounce for perf reasons\n        // this debounce does cause the code value to progress forward\n        // without the calculated syntax highlighting\n        // so colours will be momentarily skew-whiff\n        // but thats better than parsing the xenpaper AST at every keystroke\n        const inputProps = useInput(form.branch('tune'), 200);\n        const tuneChars: string[] = inputProps.value.split('');\n        const charDataArray: (CharData|undefined)[] = tuneChars.map((chr, index) => chars?.[index]);\n\n        const hasPlayStartButtons = tuneChars.some(ch => ch === '\\n');\n        let playStartLine = 0;\n\n        const charElements: React.ReactNode[] = [];\n\n        const createPlayStart = () => {\n            charElements.push(<PlayStart\n                key={`playstart${playStartLine}`}\n                line={playStartLine++}\n                selectedLine={props.selectedLine}/>\n            );\n        };\n\n        if(hasPlayStartButtons) {\n            createPlayStart();\n        }\n        charDataArray.forEach((charData, index) => {\n            const ch = tuneChars[index];\n\n            charElements.push(<Char\n                key={index}\n                ch={ch}\n                charData={charData}\n                soundEngine={soundEngine}\n            />);\n\n            if(ch === '\\n') {\n                createPlayStart();\n            }\n        });\n\n        // stop event propagation here so we can detect clicks outside of this element in isolation\n        const stopPropagation = (e: Event) => e.stopPropagation();\n\n        return <Box onClick={stopPropagation}>\n            <Codearea {...inputProps} charElements={charElements} freeze={embed} />\n            {error && <Box>\n                <ErrorMessage>Error: {error}</ErrorMessage>\n            </Box>}\n        </Box>;\n    });\n}\n\n//\n// html title\n//\n\ntype SetHtmlTitleProps = {\n    tuneForm: Dendriform<TuneForm>;\n};\n\nfunction SetHtmlTitle(props: SetHtmlTitleProps): React.ReactElement {\n    return props.tuneForm.render('tune', form => {\n        const tune = form.useValue();\n        // set title based on code in text area\n        const titleLimit = 20;\n        const title = tune.length === 0\n            ? 'Xenpaper'\n            : tune.length > titleLimit\n                ? `Xenpaper: ${tune.slice(0, titleLimit)}...`\n                : `Xenpaper: ${tune}`;\n\n        return <Helmet>\n            <title>{title}</title>\n            <meta property=\"og:title\" content={title} />\n        </Helmet>;\n    });\n}\n\n//\n//\n// styled components\n//\n\nconst Toolbar = styled(Box)`\n     background-color: ${props => props.theme.colors.background.normal};\n     z-index: 4;\n`;\n\nconst Hr = styled(Box)`\n     border-top: 1px ${props => props.theme.colors.background.light} solid;\n`;\n\ntype SideButtonProps = {\n    active?: boolean;\n    multiline?: boolean;\n};\n\nconst SideButton = styled.button<SideButtonProps>`\n    border: none;\n    display: block;\n    padding: ${props => props.multiline ? '.5rem' : '1rem .5rem'};\n    cursor: ${props => props.disabled ? 'default' : 'pointer'};\n    background-color: ${props => props.active\n        ? props.theme.colors.text.placeholder\n        : props.theme.colors.background.normal};\n    color: ${props => props.disabled\n        ? props.theme.colors.highlights.unknown\n        : props.active\n            ? props.theme.colors.background.normal\n            : props.theme.colors.highlights.comment};\n    position: relative;\n    outline: none;\n    font-family: ${props => props.theme.fonts.mono};\n    font-size: ${props => props.multiline ? '0.8rem' : '0.9rem'};\n    text-align: center;\n    width: auto;\n    text-transform: uppercase;\n    border-left: 3px solid transparent;\n    ${props => props.multiline && `line-height: 1em;`}\n\n    ${props => !props.active ? `&:hover, &:focus, &:active {\n        background-color: ${props.theme.colors.background.light};\n    }` : ``}\n\n    @media all and (min-width: ${props => props.theme.widths.sm}) {\n        padding: .5rem;\n        font-size: ${props => props.multiline ? '0.9rem' : '1.1rem'};\n        width: 5rem;\n    }\n`;\n\ntype EditOnXenpaperButtonProps = {\n    multiline?: boolean;\n};\n\nconst EditOnXenpaperButton = styled.a<EditOnXenpaperButtonProps>`\n    border: none;\n    height: 3rem;\n    line-height: 1rem;\n    display: block;\n    padding: ${props => props.multiline ? '.5rem' : '1rem .5rem'};\n    cursor: pointer;\n    background-color: ${props => props.theme.colors.background.normal};\n    color: ${props => props.theme.colors.highlights.comment};\n    position: relative;\n    outline: none;\n    font-family: ${props => props.theme.fonts.mono};\n    font-size: ${props => props.multiline ? '0.8rem' : '0.9rem'};\n    text-align: center;\n    width: auto;\n    text-transform: uppercase;\n    border-left: 3px solid transparent;\n    ${props => props.multiline && `line-height: 1em;`}\n    text-decoration: none;\n\n    &:hover, &:focus, &:active {\n        background-color: ${props => props.theme.colors.background.light};\n        text-decoration: none;\n    }\n\n    margin-left: auto;\n\n    @media all and (min-width: ${props => props.theme.widths.sm}) {\n        font-size: ${props => props.multiline ? '0.9rem' : '1.1rem'};\n    }\n`;\n\ntype PlayStartProps = {\n    line: number;\n    selectedLine: Dendriform<number>;\n};\n\nconst PlayStart = styled(({line, selectedLine, ...props}: PlayStartProps) => {\n    const onClick = () => selectedLine.set(line);\n    return <span {...props} onClick={onClick}>{'>'}</span>;\n})`\n    position: absolute;\n    left: .8rem;\n    border: none;\n    display: block;\n    cursor: pointer;\n    color: ${props => props.theme.colors.text.placeholder};\n    outline: none;\n    opacity: ${props => props.selectedLine.useValue() === props.line ? '1' : '.2'};\n    pointer-events: auto;\n\n    transition: opacity .2s ease-out;\n\n    &:hover, &:focus, &:active {\n        opacity: 1;\n    }\n`;\n","import { ReportHandler } from 'web-vitals';\n\nconst reportWebVitals = (onPerfEntry?: ReportHandler) => {\n  if (onPerfEntry && onPerfEntry instanceof Function) {\n    import('web-vitals').then(({ getCLS, getFID, getFCP, getLCP, getTTFB }) => {\n      getCLS(onPerfEntry);\n      getFID(onPerfEntry);\n      getFCP(onPerfEntry);\n      getLCP(onPerfEntry);\n      getTTFB(onPerfEntry);\n    });\n  }\n};\n\nexport default reportWebVitals;\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport {Xenpaper} from '@xenpaper/xenpaper-ui';\nimport reportWebVitals from './reportWebVitals';\n\nReactDOM.render(\n  <React.StrictMode>\n    <Xenpaper />\n  </React.StrictMode>,\n  document.getElementById('root')\n);\n\n// If you want to start measuring performance in your app, pass a function\n// to log results (for example: reportWebVitals(console.log))\n// or send to an analytics endpoint. Learn more: https://bit.ly/CRA-vitals\nreportWebVitals();\n"],"sourceRoot":""}