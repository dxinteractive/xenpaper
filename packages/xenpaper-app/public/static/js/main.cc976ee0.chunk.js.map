{"version":3,"sources":["../../xenpaper-ui/src/AppWrapper.tsx","../../xenpaper-ui/src/component/IconToggle.tsx","../../xenpaper-ui/src/component/Text.tsx","../../xenpaper-ui/src/component/Codearea.tsx","../../xenpaper-ui/src/component/ErrorMessage.tsx","../../xenpaper-ui/src/component/LoaderPane.tsx","../../xenpaper-ui/src/component/Char.tsx","../../xenpaper-ui/src/hooks/useAnimationFrame.ts","../../xenpaper-ui/src/layout/Layout.ts","../../xenpaper-ui/src/assets/xenpaper-logo-512x512.png","../../xenpaper-ui/src/Sidebars.tsx","../../mosc/src/mosc.ts","../../xenpaper-ui/src/PitchRuler.tsx","../../xenpaper-ui/src/data/grammar.ts","../../xenpaper-ui/src/data/grammar-to-chars.ts","../../xenpaper-ui/src/data/process-grammar.ts","../../xenpaper-ui/src/hooks/useHash.ts","../../xenpaper-ui/src/hooks/useWindowLoaded.ts","../../sound-engine-tonejs/src/sound-engine-tonejs.ts","../../xenpaper-ui/src/Xenpaper.tsx","reportWebVitals.ts","index.tsx"],"names":["GlobalStyle","createGlobalStyle","theme","colors","background","normal","light","text","placeholder","focus","highlights","delimiter","pitch","chord","setterGroup","setter","scaleGroup","scale","comment","commentStart","unknown","error","errorMessage","fonts","mono","copy","widths","sm","AppWrapper","props","children","rel","href","clipIn","keyframes","clipOut","colorIn","colorOut","Boundary","styled","button","hoverBackground","large","Icon","div","show","IconToggle","React","memo","state","paths","onClick","loaded","Object","keys","map","pathState","viewBox","d","index","Text","span","textStyle","typography","space","colorSystem","Codearea","value","onChange","charElements","freeze","content","color","style","fontStyle","Outer","fontSize","disabled","Inner","Textarea","autoCapitalize","autoComplete","autoCorrect","spellCheck","Highlight","aria-hidden","textarea","pre","fadeIn","ErrorMessage","LoaderPane","height","css","Char","ch","charData","soundEngine","useState","active","setActive","cb","deps","frame","useRef","last","performance","now","init","animate","time","current","delta","requestAnimationFrame","useEffect","cancelAnimationFrame","useAnimationFrame","playing","position","playTime","start","end","undefined","CharSpan","className","styledProps","compose","layout","flexbox","grid","border","Box","Flex","Flink","a","Footer","px","py","as","target","SidebarInfo","onSetTune","setSidebar","pad","H","B","pt","Ex","tune","C","display","SidebarShare","url","urlEmbed","iframeCode","copiedLink","setCopiedLink","copiedIframe","setCopiedIframe","ShareInput","flexShrink","ml","onCopy","TryButton","EmbedIframe","src","frameBorder","iframe","input","attrs","readOnly","Sidebar","title","desc","wide","TextPanel","width","flexDirection","minHeight","top","right","pr","cross","none","LogoArea","Hsize","lineHeight","alignItems","mr","alt","logo","Logo","p","flexGrow","h2","Eg","E","centsToRatio","cents","octave","octaveDivisionToRatio","steps","stepsInOctave","octaveSize","Math","pow","ratioToOctaveDivision","ratio","log","sortByTime","items","slice","sort","b","tempoTimeToMs","bpm1","bpm2","duration","u","v","timeToMs","tempoChanges","push","bpm","bpmEnd","ms","tempoItems","filter","item","type","forEach","tempo","all","lastChange","length","nextTempo","lerp","tempoChange","i","findTempoRangeForTime","SoundEngine","scoreMs","events","Set","note","loop","params","this","callback","add","delete","useStrictMode","ReactKonva","Stage","Layer","Group","Rect","Line","hzToPan","hz","log2","panToHz","pan","panToCents","pxToPan","viewPan","viewZoom","hzInRange","lowHz","highHz","getGradientColorFromNote","matched","label","match","hsl","hue","floor","Number","PitchRuler","rulerState","onClear","useCallback","set","draft","notes","clear","flexWrap","pb","render","form","Label","useCheckbox","Button","useInput","plots","useValue","plot","e","min","max","step","PitchRulerCanvas","useDimensions","dimensionsRef","rootHz","notesActive","colourMode","colourModeThreshold","colourModeSoft","visibleRange","noteSetWidth","getY","panToPx","getColor","compare","Array","from","values","startsWith","replace","proxNotes","threshold","hard","noteCents","distance","abs","round","getColorFromNoteProximity","dragStartState","dragging","setDragging","handleMouseDown","evt","preventDefault","startPan","startZoom","startDrag","clientY","handleMouseMove","dragState","nowDrag","onMouseUp","window","addEventListener","removeEventListener","handleWheel","deltaY","handleTouchStart","handleTouchMove","backgroundColor","cursor","ref","onMouseDown","onMouseMove","onWheel","onTouchStart","onTouchMove","collect","x","NoteSet","visibleNotes","y","stroke","strokeWidth","points","fill","align","ROOT_GRID_POSITIONS","RootGrid","lines","dash","CENT_GRID_POSITIONS","CentsGrid","node","fn","Node","meta","pos","sumLen","nodes","reduce","len","Semicolon","Colon","BarLine","Whitespace","OctaveModifier","chars","split","PitchCents","PitchOctaveDivision","numerator","denominator","slash","octaveDenom","PitchOctaveDivision2","PitchRatio","PitchDegree","degree","PitchHz","Pitch","All","Optional","Any","args","PitchGroup","Star","elements","Hold","Tail","Rest","Note","tail","RatioChordPitch","RatioChordPitchGroup","Chord","pitches","RatioChord","EdoScale","divisions","ScaleOctaveMarker","PitchGroupScalePrefix","prefix","PitchGroupScale","isArray","pitchGroupScalePrefix","scaleOctaveMarker","RatioChordScale","Scale","SetScale","SetRoot","SetBpmValue","SetBpm","SetBmsValue","bms","SetBms","SetSubdivisionValue","subdivision","SetSubdivision","SetOscValue","osc","SetOsc","SetEnvValue","s","r","SetEnv","SetRulerRange","low","high","SetRulerPlot","SetRuler","SetPrimes","primesPitches","Setter","SetterGroup","setters","Comment","Sequence","ParamEmbed","Param","ParamGroup","XenpaperGrammar","parts","paramGroup","find","part","sequence","parser","Parser","colorMap","Map","extract","data","parent","withinTime","get","key","grammarToChars","limit","name","Error","LIST_OF_PRIMES","primeFactorize","n","factors","every","power","realizeRatio","num","denom","context","num_factors","denom_factors","console","warn","primesTuning","pitchToRatio","octaveMulti","pitchDegreeToRatio","edoToRatios","edoSize","ratios","pitchDegreeWrap","wrappedDegree","pitchToHz","tailToTime","timeEnd","ratioToCentsLabel","ratioToCents","ratioWrap","toFixed","pitchToLabel","centsLabel","scaleLabels","edoToLabels","labels","ENV_VALUES","times","chordToMosc","timeProps","arr","pitchTypes","firstRatioPitch","firstDenominator","ratioPitchTypes","addRatioPitchType","colons","lastNumerator","concat","rulerStateCaptureRootHz","initial","processGrammar","grammar","grammarSequence","INITIAL_ENV","moscItems","initialRulerState","noteToMosc","rest","setterToMosc","newPlot","msEnd","setterToRulerState","setPrimes","debug","filteredPitches","setScale","degreePitches","pop","addRatio","thisTimeToMs","score","lengthTime","hashify","newHash","encodeURIComponent","reverseString","str","reverse","join","useHash","initialHash","hash","decodeURIComponent","unhashify","location","substr","localStorage","getItem","setHash","onHashChange","_setHash","newHashEncoded","history","replaceState","setItem","windowLoadPromise","Promise","resolve","handleLoad","flatMap","mapper","out","OSC_PARTIAL_SUFFIXES","OSC_TYPES_EXPANDED","base","OSC_TYPES","suffix","SoundEngineTonejs","_started","_endMs","_loopEndMs","_activeNoteEvents","synth","Tone","oscillator","volume","envelope","attack","sustain","decay","release","chain","seconds","onEnd","releaseAll","noteMs","_triggerEvent","on","stop","startMs","endMs","setLoopActive","setLoopStart","setLoopEnd","loopStart","loopEnd","cancel","schedule","triggerAttackRelease","paramMs","includes","setAutoFreeze","enableMapSet","parse","unparsed","parsed","message","XenpaperGrammarParser","param","lengthMs","scoreToMs","setScore","errorAt","lineNumber","colNumber","lineCount","colCount","getMsAtLine","line","counted","tuneSplit","chr","PLAY_PATHS","paused","Xenpaper","setLoaded","document","ready","useWindowLoaded","XenpaperApp","tuneForm","useDendriform","embed","useDerive","newValue","hashified","branch","useChange","parsedForm","selectedLine","looping","lowPan","highPan","useRulerState","onNote","id","handleSetPlayback","play","gotoMs","pause","handleTogglePlayback","handleToggleLoop","event","ctrlKey","metaKey","keyCode","shiftKey","redo","undo","sidebarState","toggleSidebarInfo","toggleSidebarShare","toggleSidebarRuler","codepaneContainerProps","playPause","undoRedo","useHistory","canUndo","canRedo","SideButton","sidebarToggles","sidebar","code","CodePanel","htmlTitle","SetHtmlTitle","openOnXenpaper","EditOnXenpaperButton","EmbedLayout","NormalLayout","Toolbar","mt","mb","Hr","my","pl","overflow","inputProps","tuneChars","charDataArray","hasPlayStartButtons","some","playStartLine","createPlayStart","PlayStart","stopPropagation","Helmet","property","multiline","reportWebVitals","onPerfEntry","Function","then","getCLS","getFID","getFCP","getLCP","getTTFB","ReactDOM","StrictMode","getElementById"],"mappings":"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AI,GAAI,GAAI,GAAI,GAAI,GAAI,GAAI,GACxF,GAAI,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IACzF,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAC1F,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAC1F,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAC1F,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAC1F,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAC1F,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAC1F,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KACjG,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAClH,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAClH,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAClH,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAClH,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAClH,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAClH,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAClH,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAClH,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAClH,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAClH,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAClH,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAClH,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAClH,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAClH,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAClH,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAClH,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAClH,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAClH,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAClH,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAClH,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAClH,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAClH,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAClH,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAClH,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAClH,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAClH,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAClH,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,KAAM,K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","file":"static/js/main.cc976ee0.chunk.js","sourcesContent":["import React from 'react';\r\n\r\nimport {ThemeProvider, createGlobalStyle} from 'styled-components';\r\nimport type {HighlightColor} from './data/grammar-to-chars';\r\n\r\nconst GlobalStyle = createGlobalStyle`\r\n    html, body, div, span, applet, object, iframe,\r\n    h1, h2, h3, h4, h5, h6, p, blockquote, pre,\r\n    a, abbr, acronym, address, big, cite, code,\r\n    del, dfn, em, img, ins, kbd, q, s, samp,\r\n    small, strike, strong, sub, sup, tt, var,\r\n    b, u, i, center,\r\n    dl, dt, dd, ol, ul, li,\r\n    fieldset, form, label, legend,\r\n    table, caption, tbody, tfoot, thead, tr, th, td,\r\n    article, aside, canvas, details, embed,\r\n    figure, figcaption, footer, header, hgroup,\r\n    menu, nav, output, ruby, section, summary,\r\n    time, mark, audio, video {\r\n        margin: 0;\r\n        padding: 0;\r\n        border: 0;\r\n        font-size: 100%;\r\n        font: inherit;\r\n        vertical-align: baseline;\r\n    }\r\n    article, aside, details, figcaption, figure,\r\n    footer, header, hgroup, menu, nav, section {\r\n        display: block;\r\n    }\r\n    body {\r\n        line-height: 1;\r\n    }\r\n    ol, ul {\r\n        list-style: none;\r\n    }\r\n    blockquote, q {\r\n        quotes: none;\r\n    }\r\n    blockquote:before, blockquote:after,\r\n    q:before, q:after {\r\n        content: '';\r\n        content: none;\r\n    }\r\n    table {\r\n        border-collapse: collapse;\r\n        border-spacing: 0;\r\n    }\r\n    * {\r\n        box-sizing: border-box;\r\n    }\r\n\r\n    html {\r\n        font-family: 'DM Mono', sans-serif;\r\n        height: 100%;\r\n        line-height: 1.5em;\r\n        position: relative;\r\n        -webkit-font-smoothing: antialiased;\r\n        -moz-osx-font-smoothing: grayscale;\r\n        background-color: #0e151b;\r\n        color: #ffffff;\r\n        font-size: 16px;\r\n    }\r\n\r\n    body {\r\n        font-weight: 400;\r\n        height: 100%;\r\n        line-height: 1.5em;\r\n        overflow-x: hidden;\r\n        text-rendering: optimizelegibility;\r\n\r\n        &[aria-hidden='true'] {\r\n            overflow: hidden;\r\n        }\r\n    }\r\n\r\n    #root {\r\n        height: 100%;\r\n    }\r\n`;\r\n\r\nexport type Colors = {\r\n    background: {\r\n        normal: string;\r\n        light: string;\r\n    };\r\n    text: {\r\n        placeholder: string;\r\n    };\r\n    focus: string;\r\n    highlights: {\r\n        [k in HighlightColor]: string;\r\n    }\r\n};\r\n\r\nconst colors: Colors = {\r\n    background: {\r\n        normal: '#0e151b',\r\n        light: '#18232d'\r\n    },\r\n    text: {\r\n        placeholder: '#198c8c'\r\n    },\r\n    focus: '#115d5d',\r\n    highlights: {\r\n        delimiter: '#198c8c',\r\n        pitch: '#22cece',\r\n        chord: '#22cece',\r\n        setterGroup: '#821361',\r\n        setter: '#d61ba4',\r\n        scaleGroup: '#94472f',\r\n        scale: '#ff541e',\r\n        comment: '#ffffff',\r\n        commentStart: '#198c8c',\r\n        unknown: '#a490b3',\r\n        error: '#cc0000',\r\n        errorMessage: '#cc0000'\r\n    }\r\n};\r\n\r\nconst fonts = {\r\n    mono: `'DM Mono', sans-serif`,\r\n    copy: `'Nunito', sans-serif`\r\n};\r\n\r\nconst widths = {\r\n    sm: '640px'\r\n};\r\n\r\nconst theme = {\r\n    colors,\r\n    fonts,\r\n    widths\r\n};\r\n\r\ntype Props = {\r\n    children: React.ReactNode\r\n};\r\n\r\nexport function AppWrapper(props: Props): React.ReactElement {\r\n    const {children} = props;\r\n    return <>\r\n        <link rel=\"preconnect\" href=\"https://fonts.gstatic.com\" />\r\n        <link href=\"https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,400;0,500;1,400&display=swap\" rel=\"stylesheet\" />\r\n        <link href=\"https://fonts.googleapis.com/css2?family=Nunito:wght@300;400&display=swap\" rel=\"stylesheet\" />\r\n        <ThemeProvider theme={theme}>\r\n            <GlobalStyle />\r\n            {children}\r\n        </ThemeProvider>\r\n    </>;\r\n}\r\n","import React from 'react';\r\nimport styled, {keyframes} from 'styled-components';\r\n\r\nconst clipIn = keyframes`\r\n  0% {\r\n    clip-path: polygon(0% 0%, 0% 0%, 100% 100%, 100% 100%, 100% 100%, 0% 0%);\r\n  }\r\n\r\n  20% {\r\n    clip-path: polygon(0% 0%, 0% 0%, 100% 100%, 100% 100%, 100% 100%, 0% 0%);\r\n  }\r\n\r\n  100% {\r\n    clip-path: polygon(0% 0%, 100% 0%, 100% 0%, 100% 100%, 0% 100%, 0% 100%);\r\n  }\r\n`;\r\n\r\nconst clipOut = keyframes`\r\n  0% {\r\n    clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 0% 100%, 0% 0%, 100% 100%, 100% 100%, 100% 100%, 0% 0%);\r\n  }\r\n\r\n  100% {\r\n    clip-path: polygon(100% 0%, 100% 0%, 100% 100%, 0% 100%, 0% 100%, 0% 100%, 100% 100%, 100% 0%, 100% 0%);\r\n  }\r\n`;\r\n\r\nconst colorIn = keyframes`\r\n  0% {\r\n    fill: #115d5d;\r\n  }\r\n\r\n  20% {\r\n    fill: #115d5d;\r\n  }\r\n\r\n  100% {\r\n    fill: #fff;\r\n  }\r\n`;\r\n\r\nconst colorOut = keyframes`\r\n  0% {\r\n    fill: #fff;\r\n  }\r\n\r\n  100% {\r\n    fill: #115d5d;\r\n  }\r\n`;\r\n\r\ntype ButtonProps = {\r\n    onClick: () => any;\r\n    hoverBackground?: boolean;\r\n    large: boolean;\r\n};\r\n\r\nconst Boundary = styled.button<ButtonProps>`\r\n    border: none;\r\n    display: block;\r\n    height: 3rem;\r\n    width: 3rem;\r\n    padding: 1rem .5rem;\r\n    cursor: pointer;\r\n    background-color: rgba(0,0,0,0);\r\n    position: relative;\r\n    outline: none;\r\n\r\n    transition: border-color .2s ease-out;\r\n    border-left: 3px solid transparent;\r\n\r\n    &:focus, &:active {\r\n        border-left: 3px solid ${props => props.theme.colors.focus};\r\n    }\r\n\r\n    ${props => props.hoverBackground ? `&:hover {\r\n        background-color: ${props.theme.colors.background.light};\r\n    }` : ``}\r\n\r\n    ${props => props.large && `@media all and (min-width: ${props.theme.widths.sm}) {\r\n        height: 4rem;\r\n        width: 5rem;\r\n        padding: 1rem;\r\n    }`}\r\n`;\r\n\r\ntype IconProps = {\r\n    show: boolean;\r\n    large: boolean;\r\n};\r\n\r\nconst Icon = styled.div<IconProps>`\r\n    position: absolute;\r\n    top: 0;\r\n    left: 0;\r\n    height: 3rem;\r\n    width: 2rem;\r\n    padding: 1rem .5rem;\r\n    animation: ${props => props.show ? clipIn : clipOut} .3s ease-out forwards;\r\n    margin-left: .5rem;\r\n\r\n    path {\r\n        fill: #fff;\r\n        animation: ${props => props.show ? colorIn : colorOut} .3s ease-out forwards;\r\n    }\r\n\r\n    opacity: .9;\r\n    &:hover {\r\n        opacity: 1;\r\n    }\r\n\r\n    ${props => props.large && `@media all and (min-width: ${props.theme.widths.sm}) {\r\n        height: 4rem;\r\n        width: 4rem;\r\n        padding: 1rem;\r\n    }`}\r\n`;\r\n\r\ntype Props = {\r\n    state: string;\r\n    paths: {[key: string]: string[]};\r\n    onClick?: (state: string) => any;\r\n    loaded?: boolean;\r\n    hoverBackground?: boolean;\r\n    large?: boolean;\r\n};\r\n\r\n// eslint-disable-next-line react/display-name\r\nexport const IconToggle: React.FunctionComponent<Props> = React.memo((props: Props): React.ReactElement => {\r\n    const {state, paths, onClick, loaded = true, hoverBackground = false, large = false} = props;\r\n\r\n    return <Boundary onClick={() => onClick && onClick(state)} hoverBackground={hoverBackground} large={large}>\r\n        {Object.keys(paths).map((pathState: string) => {\r\n            return <Icon key={pathState} show={loaded && state === pathState} large={large}>\r\n                <svg viewBox=\"0 0 12 12\">\r\n                    {paths[pathState].map((d, index) => <path key={index} d={d} />)}\r\n                </svg>\r\n            </Icon>;\r\n        })}\r\n    </Boundary>;\r\n});\r\n\r\n","import styled from 'styled-components';\r\nimport {space, textStyle, typography, color as colorSystem} from 'styled-system';\r\n\r\nexport const Text = styled.span`\r\n    ${textStyle}\r\n    ${typography}\r\n    ${space}\r\n    ${colorSystem}\r\n`;\r\n","import React from 'react';\r\nimport styled from 'styled-components';\r\nimport {Text} from '../component/Text';\r\nimport {textStyle, typography} from 'styled-system';\r\n\r\ntype Props = {\r\n    value: string;\r\n    onChange: (e: React.ChangeEvent<HTMLTextAreaElement>) => void;\r\n    charElements: React.ReactNode;\r\n    freeze: boolean;\r\n};\r\n\r\nexport const Codearea = (props: Props): React.ReactElement => {\r\n    const {value, onChange, charElements, freeze} = props;\r\n\r\n    const content = value === ''\r\n        ? <Text color=\"text.placeholder\" style={{fontStyle: \"italic\"}}>\r\n            Type your tune here\r\n            <br /><br />\r\n        </Text>\r\n        : <>{charElements}<br /><br /></>;\r\n\r\n    return <Outer fontSize={[\"1.1rem\", \"1.4rem\"]} disabled={freeze}>\r\n        <Inner>\r\n            <Textarea\r\n                value={value}\r\n                onChange={onChange}\r\n                autoCapitalize=\"off\"\r\n                autoComplete=\"off\"\r\n                autoCorrect=\"off\"\r\n                spellCheck=\"false\"\r\n                disabled={freeze}\r\n            />\r\n            <Highlight aria-hidden=\"true\" freeze={freeze}>{content}</Highlight>\r\n        </Inner>\r\n    </Outer>;\r\n};\r\n\r\ntype OuterProps = {\r\n    fontSize: unknown;\r\n    disabled: boolean;\r\n};\r\n\r\nconst Outer = styled.div<OuterProps>`\r\n    height: 100%;\r\n    overflow: auto;\r\n    ${textStyle}\r\n    ${typography}\r\n    line-height: 1.4em;\r\n    position: relative;\r\n\r\n    &:before {\r\n        content: \"\";\r\n        display: block;\r\n        width: 3px;\r\n        height: 4rem;\r\n        background-color: transparent;\r\n        transition: background-color .2s ease-out;\r\n        position: absolute;\r\n        top: 12px;\r\n    }\r\n\r\n    &:focus-within {\r\n        &:before {\r\n            background-color: ${props => props.theme.colors.focus};\r\n        }\r\n    }\r\n\r\n    ${props => props.disabled ? `\r\n        cursor: default;\r\n        user-select: none;\r\n        pointer-events: none;\r\n    ` : ''}\r\n`;\r\n\r\nconst Inner = styled.div`\r\n    position: relative;\r\n    text-align: left;\r\n    box-sizing: border-box;\r\n    padding: 0px;\r\n    overflow: hidden;\r\n    font-variant-ligatures: common-ligatures;\r\n    min-height: 100%;\r\n`;\r\n\r\nconst Textarea = styled.textarea`\r\n    margin: 0;\r\n    border: 0;\r\n    background: none;\r\n    box-sizing: inherit;\r\n    display: inherit;\r\n    font-family: inherit;\r\n    font-size: inherit;\r\n    font-style: inherit;\r\n    font-variant-ligatures: inherit;\r\n    font-weight: inherit;\r\n    letter-spacing: inherit;\r\n    line-height: inherit;\r\n    tab-size: inherit;\r\n    text-indent: inherit;\r\n    text-rendering: inherit;\r\n    text-transform: inherit;\r\n    white-space: pre-wrap;\r\n    word-break: keep-all;\r\n    overflow-wrap: break-word;\r\n    position: absolute;\r\n    top: 0;\r\n    left: 0;\r\n    height: 100%;\r\n    width: 100%;\r\n    resize: none;\r\n    color: inherit;\r\n    overflow: hidden;\r\n    -webkit-text-fill-color: transparent;\r\n    -webkit-font-smoothing: antialiased;\r\n    padding: 1rem 1rem 1rem 2rem;\r\n    outline: 0;\r\n\r\n    &::selection {\r\n        background: #22cece;\r\n    }\r\n\r\n    &:disabled {\r\n        user-select: none;\r\n        opacity: 0;\r\n    }\r\n`;\r\n\r\ntype HighlightProps = {\r\n    freeze: boolean;\r\n};\r\n\r\nconst Highlight = styled.pre<HighlightProps>`\r\n    margin: 0px;\r\n    border: 0px;\r\n    background: none;\r\n    box-sizing: inherit;\r\n    display: inherit;\r\n    font-family: inherit;\r\n    font-size: inherit;\r\n    font-style: inherit;\r\n    font-variant-ligatures: inherit;\r\n    font-weight: inherit;\r\n    letter-spacing: inherit;\r\n    line-height: inherit;\r\n    tab-size: inherit;\r\n    text-indent: inherit;\r\n    text-rendering: inherit;\r\n    text-transform: inherit;\r\n    white-space: pre-wrap;\r\n    word-break: keep-all;\r\n    overflow-wrap: break-word;\r\n    position: relative;\r\n    pointer-events: ${props => props.freeze ? 'auto' : 'none'};\r\n    padding: 1rem 1rem 1rem 2rem;\r\n    user-select: none;\r\n`;\r\n","import styled, {keyframes} from 'styled-components';\r\n\r\nconst fadeIn = keyframes`\r\n  0% {\r\n    opacity: 0;\r\n    top: 1rem;\r\n  }\r\n\r\n  85% {\r\n    opacity: 0;\r\n    top: 1rem;\r\n  }\r\n\r\n  100% {\r\n    opacity: 1;\r\n    top: 0rem;\r\n  }\r\n`;\r\n\r\nexport const ErrorMessage = styled.div`\r\n    position: relative;\r\n    top: 0;\r\n    padding-left: 1rem;\r\n    animation: ${fadeIn} .7s ease-out forwards;\r\n`;\r\n","import type React from 'react';\r\nimport styled, {css, keyframes} from 'styled-components';\r\n\r\nconst fadeIn = keyframes`\r\n  from {\r\n    opacity: 0;\r\n  }\r\n\r\n  to {\r\n    opacity: 1;\r\n  }\r\n`;\r\n\r\ninterface Props {\r\n    readonly loaded: boolean;\r\n    readonly height: string;\r\n    readonly children: React.ReactNode;\r\n}\r\n\r\nexport const LoaderPane = styled.div<Props>`\r\n    height: ${props => props.height};\r\n    opacity: 0;\r\n    ${props => props.loaded ? css`animation: ${fadeIn} .1s ease-out forwards;` : ``}\r\n`;\r\n","import React, {useState} from 'react';\r\nimport styled from 'styled-components';\r\nimport type {HighlightColor, CharData} from '../data/grammar-to-chars';\r\nimport {useAnimationFrame} from '../hooks/useAnimationFrame';\r\nimport type {SoundEngine} from '@xenpaper/mosc';\r\n\r\ntype CharProps = {\r\n    ch: string;\r\n    charData?: CharData;\r\n    soundEngine: SoundEngine;\r\n};\r\n\r\nexport const Char = React.memo(function Char(props: CharProps): React.ReactElement {\r\n    const {ch, charData, soundEngine} = props;\r\n\r\n    const [active, setActive] = useState<boolean>(false);\r\n\r\n    useAnimationFrame(() => {\r\n        const time = soundEngine.playing() ? soundEngine.position() : -1;\r\n        const [start, end] = charData?.playTime ?? [];\r\n\r\n        const active = time !== -1\r\n            && start !== undefined\r\n            && end !== undefined\r\n            && start <= time\r\n            && end > time;\r\n\r\n        setActive(active);\r\n    }, [ch, charData]);\r\n\r\n    return <CharSpan className={active ? 'active' : ''} color={charData?.color}>{ch}</CharSpan>;\r\n});\r\n\r\ntype CharSpanProps = {\r\n    readonly color?: HighlightColor;\r\n    readonly children: React.ReactNode;\r\n};\r\n\r\nconst CharSpan = styled.span<CharSpanProps>`\r\n    color: ${props => props.theme.colors.highlights[props.color || 'unknown']};\r\n    transition: color 0.2s ${props => props.color === 'error' ? '0.5s' : '0s'} ease-out;\r\n\r\n    &.active {\r\n        transition: color 0s 0s linear;\r\n        color: #fff;\r\n    }\r\n`;\r\n","import {useEffect, useRef} from \"react\";\r\n\r\ntype Callback = (time: number, delta: number) => any;\r\n\r\nexport const useAnimationFrame = (cb: Callback, deps: any[]): void => {\r\n    const frame = useRef<number>(0);\r\n    const last = useRef<number>(performance.now());\r\n    const init = useRef<number>(performance.now());\r\n\r\n    const animate = () => {\r\n        const now = performance.now();\r\n        const time = (now - init.current) / 1000;\r\n        const delta = (now - last.current) / 1000;\r\n        cb(time, delta);\r\n        last.current = now;\r\n        frame.current = requestAnimationFrame(animate);\r\n    };\r\n\r\n    useEffect(() => {\r\n        frame.current = requestAnimationFrame(animate);\r\n        return () => cancelAnimationFrame(frame.current);\r\n    }, deps);\r\n};\r\n","import styled from 'styled-components';\r\n\r\nimport {\r\n    space,\r\n    color,\r\n    layout,\r\n    flexbox,\r\n    grid,\r\n    background,\r\n    border,\r\n    position,\r\n    compose\r\n} from 'styled-system';\r\n\r\nconst styledProps = compose(\r\n    space,\r\n    color,\r\n    layout,\r\n    flexbox,\r\n    grid,\r\n    background,\r\n    border,\r\n    position\r\n);\r\n\r\nexport const Box = styled.div<any>`\r\n    ${styledProps}\r\n`;\r\n\r\nexport const Flex = styled.div<any>`\r\n    display: flex;\r\n    ${styledProps}\r\n`;\r\n","export default __webpack_public_path__ + \"static/media/xenpaper-logo-512x512.19f23cff.png\";","import React, { useState } from \"react\";\r\nimport { IconToggle } from \"./component/IconToggle\";\r\nimport { Text } from \"./component/Text\";\r\nimport { Box, Flex } from \"./layout/Layout\";\r\nimport styled from \"styled-components\";\r\nimport { textStyle, typography } from \"styled-system\";\r\n// eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n// @ts-ignore\r\nimport logo from \"./assets/xenpaper-logo-512x512.png\";\r\n\r\nimport type { SidebarState } from \"./Xenpaper\";\r\nimport { CopyToClipboard } from \"react-copy-to-clipboard\";\r\nimport { octaveDivisionToRatio } from '../../mosc/src/mosc';\r\n\r\nconst Flink = styled.a`\r\n    color: ${(props) => props.theme.colors.highlights.unknown};\r\n    text-decoration: none;\r\n    font-style: normal;\r\n\r\n    &:hover,\r\n    &:focus {\r\n        color: #fff;\r\n        text-decoration: underline;\r\n    }\r\n\r\n    &:active {\r\n        color: #fff;\r\n    }\r\n`;\r\n\r\nexport const Footer = styled((props) => {\r\n    return (\r\n        <Box px={3} py={2} {...props}>\r\n            <Text as=\"div\" color=\"text.placeholder\">\r\n                <Flink href=\"#\">Xenpaper</Flink>{\" \"}\r\n                <Flink\r\n                    target=\"_blank\"\r\n                    href=\"https://github.com/dxinteractive/xenpaper/releases\"\r\n                >\r\n                    (v1.7.1)\r\n                </Flink>{\" \"}\r\n                is made by{\" \"}\r\n                <Flink target=\"_blank\" href=\"https://damienclarke.me\">\r\n                    Damien Clarke\r\n                </Flink>{\" \"}\r\n                using{\" \"}\r\n                <Flink target=\"_blank\" href=\"https://www.typescriptlang.org/\">\r\n                    typescript\r\n                </Flink>\r\n                ,{\" \"}\r\n                <Flink target=\"_blank\" href=\"https://reactjs.org/\">\r\n                    react\r\n                </Flink>\r\n                ,{\" \"}\r\n                <Flink target=\"_blank\" href=\"https://tonejs.github.io/\">\r\n                    tonejs\r\n                </Flink>\r\n                ,{\" \"}\r\n                <Flink\r\n                    target=\"_blank\"\r\n                    href=\"https://github.com/dmaevsky/rd-parse\"\r\n                >\r\n                    rd-parse\r\n                </Flink>\r\n                ,{\" \"}\r\n                <Flink target=\"_blank\" href=\"https://styled-components.com/\">\r\n                    styled-components\r\n                </Flink>{\" \"}\r\n                and{\" \"}\r\n                <Flink target=\"_blank\" href=\"https://dendriform.xyz\">\r\n                    dendriform\r\n                </Flink>\r\n                .\r\n            </Text>\r\n        </Box>\r\n    );\r\n})`\r\n    font-size: 0.9rem;\r\n    font-family: ${(props) => props.theme.fonts.copy};\r\n`;\r\n\r\ntype SidebarInfoProps = {\r\n    onSetTune: (tune: string) => void;\r\n    setSidebar: (open: SidebarState) => void;\r\n};\r\n\r\nexport const SidebarInfo = (props: SidebarInfoProps): React.ReactElement => {\r\n    const { onSetTune, setSidebar } = props;\r\n    return (\r\n        <Sidebar setSidebar={setSidebar} pad>\r\n            <H>How it works</H>\r\n            <B>\r\n                Create tunes by typing in the text area. Press play to hear what\r\n                you{\"'\"}ve written.{/*, or press <C>Ctrl / Cmd + Enter</C>.*/}\r\n            </B>\r\n            <Box pt={4}>\r\n                <H>Notes</H>\r\n            </Box>\r\n            <B>\r\n                Typing a number will create a note. Notes can be separated by\r\n                spaces or commas.\r\n                <Ex tune=\"0 4 7 12\" color=\"pitch\" onSetTune={onSetTune} />\r\n            </B>\r\n            <B>\r\n                Notes can be held for longer with hyphens <C>---</C>, and rests\r\n                can be added with dots <C>...</C>.\r\n                <Ex\r\n                    tune=\"0.2.3...3-2-0--.\"\r\n                    color=\"pitch\"\r\n                    onSetTune={onSetTune}\r\n                />\r\n            </B>\r\n            <B>\r\n                Spaces, new lines and bars <C>|</C> can be placed anywhere\r\n                between notes. Bars can also be placed during a note.\r\n                <Ex\r\n                    tune=\"0 8 7-|0 8 7-|-5 4--\"\r\n                    color=\"pitch\"\r\n                    onSetTune={onSetTune}\r\n                />\r\n            </B>\r\n            <B>\r\n                Notes can be written in many ways.\r\n                <br />- as scale degrees starting from zero <C>0,2,4</C>,\r\n                <br />- as ratios <C>3/2,5/4,1/1</C>,\r\n                <br />- as cents <C>702c</C>,\r\n                <br />- as divisions of an octave <C>11{\"\\\\\"}19</C>,\r\n                <br />- as divisions of an octave with a specific size (e.g. 3){\" \"}\r\n                <C>5{\"\\\\\"}13o3</C>\r\n                <br />- as cycles per second <C>432Hz</C>\r\n                <Ex\r\n                    tune={\"0 7 1/1 3/2 0c 702c\\n0\\\\19 11\\\\19 220Hz 330Hz\"}\r\n                    color=\"pitch\"\r\n                    onSetTune={onSetTune}\r\n                />\r\n            </B>\r\n            <B>\r\n                Notes can be shifted up or down octaves. <C>{\"'\"}</C> shifts the\r\n                following note up 1 octave, <C>\"</C> shifts the following note\r\n                up 2 octaves, and <C>`</C> shifts the following note down an\r\n                octave.\r\n                <Ex\r\n                    tune={\"0-3-'0-'3-\\\"0-'\\\"0-`0-``0-\"}\r\n                    color=\"pitch\"\r\n                    onSetTune={onSetTune}\r\n                />\r\n            </B>\r\n            <B>\r\n                Chords can be played by using <C>[</C> and <C>]</C> around a\r\n                comma-separated pitches.\r\n                <Ex\r\n                    tune=\"[3,7]-[5,8]-[0,3,7]--.[1/1,6/5,3/2]--.\"\r\n                    color=\"pitch\"\r\n                    onSetTune={onSetTune}\r\n                />\r\n            </B>\r\n            <B>\r\n                Chords can also be played using colon-notated ratios{\" \"}\r\n                <C>4:5:6</C>\r\n                <Ex tune=\"10:12:15---\" color=\"pitch\" onSetTune={onSetTune} />\r\n            </B>\r\n            <Box pt={4}>\r\n                <H>Comments</H>\r\n            </Box>\r\n            <B>\r\n                Comments can be added using <C>#</C> at the start of a line\r\n                <Ex\r\n                    tune={\r\n                        \"# a 7th chord\\n[0,4,7,10]--..\\n\\n# a harmonic 7th chord\\n4:5:6:7--..\"\r\n                    }\r\n                    color=\"pitch\"\r\n                    onSetTune={onSetTune}\r\n                />\r\n            </B>\r\n            <Box pt={4}>\r\n                <H>Scales</H>\r\n            </Box>\r\n            <B>\r\n                The scale can be changed at any time. A scale is denoted by{\" \"}\r\n                <C>{\"{\"}</C> and <C>{\"}\"}</C>. These dictate what pitches any\r\n                subsequent scale degrees correspond to. The default is 12 equal\r\n                divisons of the octave <C>12edo</C>.\r\n                <Ex\r\n                    tune=\"[0,4,7]--- {31edo}[0,10,18]---\"\r\n                    color=\"pitch\"\r\n                    onSetTune={onSetTune}\r\n                />\r\n            </B>\r\n            <B>\r\n                Equal division equave size can be changed by replacing the{\" \"}\r\n                {'\"o\"'} with a number or fraction <C>13ed3</C>.\r\n                <Ex\r\n                    tune=\"{13ed3}0 1 2 3 4\"\r\n                    color=\"pitch\"\r\n                    onSetTune={onSetTune}\r\n                />\r\n            </B>\r\n            <B>\r\n                Scales can be comprised of individual pitches.\r\n                <Ex\r\n                    tune={\"{1/1 9/8 5/4 4/3 3/2 5/3 15/8}\\n0 1 2 3 4 5 6 7-\"}\r\n                    color=\"pitch\"\r\n                    onSetTune={onSetTune}\r\n                />\r\n            </B>\r\n            <B>\r\n                Scales comprised of individual pitches can also set their equave\r\n                size using <C>{\"'\"}</C> after the last pitch. Defaults to{\" \"}\r\n                <C>2/1</C>\r\n                <Ex\r\n                    tune={\"{1/1 5/4 4/3 3/2'}\\n0 1 2 3 4 5 6 7 8-\"}\r\n                    color=\"pitch\"\r\n                    onSetTune={onSetTune}\r\n                />\r\n            </B>\r\n            <B>\r\n                Scales can use colon-notated ratios\r\n                <Ex\r\n                    tune={\"{12:14:16:18:21}\\n0 1 2 3 4 5 6 7-\"}\r\n                    color=\"pitch\"\r\n                    onSetTune={onSetTune}\r\n                />\r\n            </B>\r\n            <B>\r\n                Harmonic series segments can be specified by using the{\" \"}\r\n                <C>{\"::\"}</C> symbol inside a colon-notated ratio scale.{\" \"}\r\n                <C>4::7</C> is the same as <C>4:5:6:7</C>.\r\n                <Ex\r\n                    tune={\"{4::7}\\n0 1 2 3 4-\"}\r\n                    color=\"pitch\"\r\n                    onSetTune={onSetTune}\r\n                />\r\n            </B>\r\n            <B>\r\n                Scales can also reference the scale degrees at the moment they\r\n                are encountered. This can be useful for creating a subset of a\r\n                scale.\r\n                <Ex\r\n                    tune={\"{19edo}{0 3 6 8 11 14 17}\\n0 1 2 3 4 5 6 7-\"}\r\n                    color=\"pitch\"\r\n                    onSetTune={onSetTune}\r\n                />\r\n            </B>\r\n            <B>\r\n                Modes can be set using <C>{\"{m\"}</C> and <C>{\"}\"}</C>.\r\n                <Ex\r\n                    tune={\"{12edo}{m2 1 2 2 1 2 2}\\n0 1 2 3 4 5 6 7-\"}\r\n                    color=\"pitch\"\r\n                    onSetTune={onSetTune}\r\n                />\r\n            </B>\r\n            <B>\r\n                All pitch values other than cycles-per-second are relative to a\r\n                root note. This can be changed with <C>{\"{r...}\"}</C>. It can be\r\n                given any pitch value to use as the new root. It defaults to{\" \"}\r\n                <C>{\"{r440Hz}\"}</C>\r\n                <Ex\r\n                    tune={\"0 2 4-{r432Hz}0 2 4-\"}\r\n                    color=\"pitch\"\r\n                    onSetTune={onSetTune}\r\n                />\r\n            </B>\r\n            <B>\r\n                As each change to the root pitch is relative to the current\r\n                root, multiple roots can be chained after each other\r\n                <Ex\r\n                    tune={\"4 0-{r2}4 0-{r2}4 0-\"}\r\n                    color=\"pitch\"\r\n                    onSetTune={onSetTune}\r\n                />\r\n            </B>\r\n            <B>\r\n                This can also be used to switch octaves for a time.\r\n                <Ex\r\n                    tune={\"4 0-{r'0}4 0-{r`0}4 0-\"}\r\n                    color=\"pitch\"\r\n                    onSetTune={onSetTune}\r\n                />\r\n            </B>\r\n            <Box pt={4}>\r\n                <H>Setters</H>\r\n            </Box>\r\n            <B>\r\n                Setters are a type of statement that are used to set various\r\n                parameters as a tune progresses, such as <C>(bpm:100)</C> or{\" \"}\r\n                <C>(osc:sine)</C>. A setter is denoted by <C>(</C> and <C>)</C>,\r\n                and can be placed anywhere between notes or on new lines.\r\n                Multiple setters can be combined into a single statement using a\r\n                semicolon <C>(bpm:100; osc:sine)</C>\r\n            </B>\r\n\r\n            <Box pt={4}>\r\n                <H>Timing</H>\r\n            </Box>\r\n            <B>\r\n                Tempo can be changed using the tempo setter <C>(bpm:...)</C>.\r\n                Defaults to <C>(bpm:120)</C>\r\n                <Ex\r\n                    tune=\"(bpm:200)7 5 4 2 0...\"\r\n                    color=\"pitch\"\r\n                    onSetTune={onSetTune}\r\n                />\r\n            </B>\r\n            <B>\r\n                Tempo can also be set using milliseconds per beat{\" \"}\r\n                <C>(bms:...)</C>.\r\n                <Ex\r\n                    tune=\"(bms:1000)3 2 0\"\r\n                    color=\"pitch\"\r\n                    onSetTune={onSetTune}\r\n                />\r\n            </B>\r\n            <B>\r\n                Divisions of the beat can be set using the division setter{\" \"}\r\n                <C>(div:...)</C>. These can also be shortened to <C>(...)</C>,\r\n                like <C>(4)</C> or <C>(1/4)</C>. Defaults to 2 divisions per\r\n                beat (eighth notes) <C>(div:2)</C>\r\n                <Ex\r\n                    tune=\"0 2 3 7(3)0 2 3 7(4)0 2 3 7(1/2)0 2 3 7\"\r\n                    color=\"pitch\"\r\n                    onSetTune={onSetTune}\r\n                />\r\n            </B>\r\n            <Box pt={4}>\r\n                <H>Sound</H>\r\n            </Box>\r\n            <B>\r\n                The oscillator can be changed using the oscillator setter{\" \"}\r\n                <C>(osc:...)</C>. Defaults to <C>(osc:triangle)</C>\r\n                <Ex\r\n                    tune={\r\n                        \"(osc:sine)0 4 7.\\n(osc:sawtooth)0 4 7.\\n(osc:square)0 4 7.\"\r\n                    }\r\n                    color=\"pitch\"\r\n                    onSetTune={onSetTune}\r\n                />\r\n            </B>\r\n            <B>\r\n                Valid values are <C>sine</C>, <C>sawtooth</C>, <C>square</C> and{\" \"}\r\n                <C>triangle</C>. Any of these can be optionally prefixed with{\" \"}\r\n                <C>fm</C>, <C>am</C>or <C>fat</C>. Any of these can be suffixed\r\n                with an integer from <C>1</C> to <C>32</C> to indicate the\r\n                number of partials to use.\r\n                <Ex\r\n                    tune={\r\n                        \"(osc:fmsine)0 4 7.\\n(osc:fatsquare)0 4 7.\\n(osc:sawtooth5)0 4 7.\"\r\n                    }\r\n                    color=\"pitch\"\r\n                    onSetTune={onSetTune}\r\n                />\r\n            </B>\r\n            <B>\r\n                The envelope can be changed using the envelope setter{\" \"}\r\n                <C>(env:...)</C>. This accepts 4 digits corresponding to attack,\r\n                decay, sustain and release, where <C>0</C> is fast / small, and{\" \"}\r\n                <C>9</C> is slow / big. Defaults to <C>(env:2856)</C>\r\n                <Ex\r\n                    tune={\"(env:0158)0-.....\\n(env:6860)0---...\"}\r\n                    color=\"pitch\"\r\n                    onSetTune={onSetTune}\r\n                />\r\n            </B>\r\n            <B>\r\n                All oscillator and envelope options are made possible by{\" \"}\r\n                <Flink target=\"_blank\" href=\"https://tonejs.github.io/\">\r\n                    tonejs\r\n                </Flink>\r\n                .\r\n            </B>\r\n\r\n            <Box pt={4}>\r\n                <H>Retune primes</H>\r\n            </Box>\r\n            <B>\r\n                You can retune how notes/chords like <C>5/4</C> and <C>4:5:7</C> are tuned with\r\n                <C>(primes: a b c d...)</C>\r\n                where <C>a</C> represents the tuning of prime 2,\r\n                <C>b</C> represents the tuning of the prime 3,\r\n                <C>c</C> represents the tuning of the prime 5, and so on. Any pitch representation can be used.\r\n            </B>\r\n            <B>\r\n                This example simply configures the default tuning of just intonation ratios,\r\n                so nothing is changed:\r\n\r\n                <Ex\r\n                    tune={\"(primes: 2/1 3/1 5/1 7/1) 1/1 9/8 5/4 4/3 3/2\"}\r\n                    color=\"pitch\"\r\n                    onSetTune={onSetTune}\r\n                />\r\n            </B>\r\n            <B>\r\n                Tuning by primes involves representing a 'just' ratio as a{\"\"}\r\n                <Flink target=\"_blank\" href=\"https://tonejs.github.io/\">\r\n                    Monzo\r\n                </Flink> (i.e. decomposed into prime factors), and substituting the\r\n                custom prime tunings in place of the normal <C>2/1 3/1 5/1 7/1 ...</C>\r\n                intervals.\r\n            </B>\r\n            <B>\r\n                This example sets the <C>2/1</C> prime to 4 steps of 12 edo, so now octave\r\n                ratios now sound as though they were tempered major thirds. Undefined primes\r\n                will default to being justly-tuned:\r\n                <Ex\r\n                    tune={\"(primes: 4\\\\12) 1/1 2/1 4/1 8/1 16/1 3/1 3/2 3/4\"}\r\n                    color=\"pitch\"\r\n                    onSetTune={onSetTune}\r\n                />\r\n            </B>\r\n            <B>\r\n                This feature is useful for changing the temperaments/tuning of the\r\n                entire piece without\r\n                having to rewrite all the notes:\r\n\r\n                <Ex\r\n                    tune={\"(1/4)\\n4:5:6:7 # Just\\n(primes: 12 19 28 34)4:5:6:7 # 12edo\\n(primes: 22\\\\22 35\\\\22 51\\\\22 62\\\\22)4:5:6:7 # 22edo\"}\r\n                    color=\"pitch\"\r\n                    onSetTune={onSetTune}\r\n                />\r\n            </B>\r\n            <B>\r\n                For more info, check out <Flink target=\"_blank\" href=\"https://en.xen.wiki/w/Vals_and_tuning_space#Vals_and_monzos\">\r\n                    Vals and Monzos\r\n                </Flink> on the xen wiki.\r\n            </B>\r\n\r\n            <Box pt={4}>\r\n                <H>Ruler</H>\r\n            </Box>\r\n            <B>\r\n                The Ruler button displays a pitch ruler. Played notes will\r\n                appear on it. Click and drag to pan, use the mouse wheel to\r\n                zoom. Touch devices are not yet supported.\r\n            </B>\r\n            <B>\r\n                The current scale can be plotted by calling <C>(plot)</C>.\r\n                Calling it multiple times will render multiple scales. To see\r\n                this demo, you must click Ruler after you click Demo.\r\n                <Ex\r\n                    tune={\"(plot){19edo}(plot)\"}\r\n                    color=\"pitch\"\r\n                    onSetTune={onSetTune}\r\n                />\r\n            </B>\r\n            <Box pt={4}>\r\n                <H>Bugs and future features</H>\r\n            </Box>\r\n            <B>\r\n                Find anything broken, or have some ideas you want to share?\r\n                Visit the{\" \"}\r\n                <Flink\r\n                    target=\"_blank\"\r\n                    href=\"https://github.com/dxinteractive/xenpaper/issues\"\r\n                >\r\n                    issue tracker on github\r\n                </Flink>{\" \"}\r\n                to file bugs or discuss future features.\r\n            </B>\r\n            <Box display={[\"block\", \"block\", \"none\"]} pt={4}>\r\n                <Footer />\r\n            </Box>\r\n        </Sidebar>\r\n    );\r\n};\r\n\r\ntype SidebarShareProps = {\r\n    setSidebar: (open: SidebarState) => void;\r\n    url: string;\r\n    urlEmbed: string;\r\n};\r\n\r\nexport const SidebarShare = (props: SidebarShareProps): React.ReactElement => {\r\n    const { setSidebar, url, urlEmbed } = props;\r\n\r\n    const iframeCode = `<iframe width=\"560\" height=\"315\" src=\"${urlEmbed}\" title=\"Xenpaper\" frameborder=\"0\"></iframe>`;\r\n\r\n    const [copiedLink, setCopiedLink] = useState<boolean>(false);\r\n    const [copiedIframe, setCopiedIframe] = useState<boolean>(false);\r\n\r\n    return (\r\n        <Sidebar setSidebar={setSidebar} pad>\r\n            <Box>\r\n                <H>Share link</H>\r\n                <Flex>\r\n                    <ShareInput value={url} />\r\n                    <Box flexShrink=\"0\" ml={3}>\r\n                        <CopyToClipboard\r\n                            text={url}\r\n                            onCopy={() => setCopiedLink(true)}\r\n                        >\r\n                            <TryButton>\r\n                                {copiedLink ? \"Copied\" : \"Copy\"}\r\n                            </TryButton>\r\n                        </CopyToClipboard>\r\n                    </Box>\r\n                </Flex>\r\n            </Box>\r\n            <Box pt={4}>\r\n                <H>Embed</H>\r\n                <Flex>\r\n                    <ShareInput value={iframeCode} />\r\n                    <Box flexShrink=\"0\" ml={3}>\r\n                        <CopyToClipboard\r\n                            text={url}\r\n                            onCopy={() => setCopiedIframe(true)}\r\n                        >\r\n                            <TryButton>\r\n                                {copiedIframe ? \"Copied\" : \"Copy\"}\r\n                            </TryButton>\r\n                        </CopyToClipboard>\r\n                    </Box>\r\n                </Flex>\r\n                <Box pt={3}>\r\n                    <EmbedIframe\r\n                        key={urlEmbed}\r\n                        src={urlEmbed}\r\n                        frameBorder=\"0\"\r\n                    />\r\n                </Box>\r\n            </Box>\r\n        </Sidebar>\r\n    );\r\n};\r\n\r\nconst EmbedIframe = styled.iframe`\r\n    width: 100%;\r\n`;\r\n\r\nconst ShareInput = styled.input.attrs(() => ({ readOnly: true }))`\r\n    width: 100%;\r\n    background-color: ${(props) => props.theme.colors.background.normal};\r\n    font-family: ${(props) => props.theme.fonts.mono};\r\n    color: #ffffff;\r\n    padding: 0.25rem;\r\n    border: ${(props) =>\r\n            props.theme.colors.highlights[props.color || \"unknown\"]}\r\n        1px solid;\r\n`;\r\n\r\ntype SidebarProps = {\r\n    setSidebar: (open: SidebarState) => void;\r\n    children: React.ReactNode;\r\n    title?: string;\r\n    desc?: string;\r\n    pad?: boolean;\r\n    wide?: boolean;\r\n};\r\n\r\nexport const Sidebar = (props: SidebarProps): React.ReactElement => {\r\n    const { setSidebar, children, title, desc, pad, wide } = props;\r\n    return (\r\n        <TextPanel\r\n            width={[\"auto\", \"20rem\", \"30rem\", wide ? \"55%\" : \"40%\"]}\r\n            flexDirection=\"column\"\r\n            flexShrink=\"0\"\r\n            minHeight=\"0\"\r\n            height={[\"66vh\", \"auto\"]}\r\n        >\r\n            <Box\r\n                position={[\"absolute\", \"fixed\"]}\r\n                top={0}\r\n                right={0}\r\n                pt={3}\r\n                pr={3}\r\n            >\r\n                <IconToggle\r\n                    state=\"cross\"\r\n                    paths={{\r\n                        cross: [\r\n                            \"M 1 0 L 12 11 L 11 12 L 0 1 Z\",\r\n                            \"M 1 12 L 12 1 L 11 0 L 0 11 Z\",\r\n                        ],\r\n                        none: [],\r\n                    }}\r\n                    onClick={() => setSidebar(\"none\")}\r\n                    loaded\r\n                />\r\n            </Box>\r\n            <LogoArea>\r\n                {title && <Hsize>{title}</Hsize>}\r\n                {desc && (\r\n                    <Text\r\n                        as=\"div\"\r\n                        color=\"text.placeholder\"\r\n                        style={{ fontStyle: \"italic\", lineHeight: \"1.3rem\" }}\r\n                    >\r\n                        {desc}\r\n                    </Text>\r\n                )}\r\n                {!title && (\r\n                    <Flex alignItems=\"center\">\r\n                        <Box mr={4} width=\"5rem\" pt={2}>\r\n                            <img alt=\"Xenpaper logo\" src={logo} width=\"100%\" />\r\n                        </Box>\r\n                        <Box>\r\n                            <Logo>xenpaper</Logo>\r\n                            <Text\r\n                                as=\"div\"\r\n                                color=\"text.placeholder\"\r\n                                style={{\r\n                                    fontStyle: \"italic\",\r\n                                    lineHeight: \"1.3rem\",\r\n                                }}\r\n                            >\r\n                                Text-based microtonal sequencer.\r\n                            </Text>\r\n                            <Text\r\n                                as=\"div\"\r\n                                color=\"text.placeholder\"\r\n                                style={{\r\n                                    fontStyle: \"italic\",\r\n                                    lineHeight: \"1.3rem\",\r\n                                }}\r\n                            >\r\n                                Write down musical ideas and share the link\r\n                                around.\r\n                            </Text>\r\n                        </Box>\r\n                    </Flex>\r\n                )}\r\n            </LogoArea>\r\n            <Box p={pad ? 4 : 0} flexGrow=\"1\">\r\n                {children}\r\n            </Box>\r\n        </TextPanel>\r\n    );\r\n};\r\n\r\nconst TextPanel = styled(Flex)`\r\n    background-color: ${(props) => props.theme.colors.background.light};\r\n    font-family: ${(props) => props.theme.fonts.copy};\r\n    position: relative;\r\n    animation: 0.3s ease-out onShow;\r\n    position: relative;\r\n    overflow: auto;\r\n\r\n    opacity: 1;\r\n    top: 0;\r\n\r\n    @keyframes onShow {\r\n        0% {\r\n            opacity: 0;\r\n            top: 0.25rem;\r\n        }\r\n        100% {\r\n            opacity: 1;\r\n            top: 0;\r\n        }\r\n    }\r\n`;\r\n\r\nconst LogoArea = styled(Box)`\r\n    background-color: ${(props) => props.theme.colors.background.normal};\r\n    padding: 2rem 2rem 1.5rem;\r\n`;\r\n\r\nconst Logo = styled(Box)`\r\n    font-size: 2.5rem;\r\n    line-height: 2rem;\r\n    margin-bottom: 0.5rem;\r\n`;\r\n\r\nconst B = styled.div`\r\n    margin-bottom: 2rem;\r\n`;\r\n\r\nconst H = styled.h2`\r\n    font-size: 1.5rem;\r\n    margin-bottom: 1rem;\r\n`;\r\n\r\nconst Hsize = styled.h2`\r\n    font-size: 1.5rem;\r\n    margin-bottom: 0.25rem;\r\n`;\r\n\r\nconst C = styled.span`\r\n    font-family: ${(props) => props.theme.fonts.mono};\r\n    background-color: ${(props) => props.theme.colors.background.normal};\r\n    padding: 0.1rem;\r\n`;\r\n\r\ntype ExProps = {\r\n    tune: string;\r\n    onSetTune: (tune: string) => void;\r\n    color: string;\r\n    className?: string;\r\n};\r\n\r\nconst Ex = styled((props: ExProps): React.ReactElement => {\r\n    // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n    // @ts-ignore\r\n    return (\r\n        <Flex className={props.className}>\r\n            <Eg>e.g. </Eg>\r\n            <E fontSize={[\"1.1rem\", \"1.4rem\"]} color={props.color}>\r\n                {props.tune}\r\n            </E>\r\n            <Box flexShrink=\"0\">\r\n                <TryButton onClick={() => props.onSetTune(props.tune)}>\r\n                    Demo\r\n                </TryButton>\r\n            </Box>\r\n        </Flex>\r\n    );\r\n})`\r\n    font-family: ${(props) => props.theme.fonts.mono};\r\n    padding: 0.5rem;\r\n    margin-top: 1rem;\r\n    background-color: ${(props) => props.theme.colors.background.normal};\r\n    line-height: 2em;\r\n`;\r\n\r\nconst TryButton = styled.button`\r\n    border: none;\r\n    display: block;\r\n    padding: 0.5rem;\r\n    cursor: pointer;\r\n    background-color: ${(props) => props.theme.colors.highlights.scale};\r\n    color: ${(props) => props.theme.colors.background.normal};\r\n    position: relative;\r\n    outline: none;\r\n    opacity: 0.7;\r\n\r\n    transition: opacity 0.2s ease-out;\r\n\r\n    &:hover,\r\n    &:focus,\r\n    &:active {\r\n        opacity: 1;\r\n    }\r\n`;\r\n\r\nconst Eg = styled.div`\r\n    font-style: italic;\r\n    color: ${(props) => props.theme.colors.text.placeholder};\r\n    padding-left: 0.6rem;\r\n    padding-right: 1rem;\r\n    flex-shrink: 0;\r\n`;\r\n\r\ntype EProps = {\r\n    fontSize: unknown;\r\n};\r\n\r\nconst E = styled.pre<EProps>`\r\n    flex-grow: 1;\r\n    ${textStyle}\r\n    ${typography}\r\n    line-height: 1.4em;\r\n    font-style: normal;\r\n    color: ${(props) =>\r\n        props.theme.colors.highlights[props.color || \"unknown\"]};\r\n    word-wrap: break-word;\r\n    white-space: pre-wrap;\r\n    flex-shrink: 1;\r\n    width: 0;\r\n    padding-right: 0.5rem;\r\n`;\r\n","//\r\n// types\r\n//\r\n\r\nexport type MoscNote = {\r\n    type: 'NOTE_TIME';\r\n    time: number;\r\n    timeEnd: number;\r\n    hz: number;\r\n    label: string;\r\n};\r\n\r\nexport type MoscNoteMs = {\r\n    type: 'NOTE_MS';\r\n    ms: number;\r\n    msEnd: number;\r\n    hz: number;\r\n    label: string;\r\n};\r\n\r\nexport type MoscParam = {\r\n    type: 'PARAM_TIME';\r\n    time: number;\r\n    value: any;\r\n};\r\n\r\nexport type MoscParamMs = {\r\n    type: 'PARAM_MS';\r\n    ms: number;\r\n    value: any;\r\n};\r\n\r\nexport type MoscTempo = {\r\n    type: 'TEMPO';\r\n    time: number;\r\n    bpm: number;\r\n    lerp: boolean;\r\n};\r\n\r\nexport type MoscEnd = {\r\n    type: 'END_TIME';\r\n    time: number;\r\n};\r\n\r\nexport type MoscEndMs = {\r\n    type: 'END_MS';\r\n    ms: number;\r\n};\r\n\r\nexport type MoscItem = MoscNote|MoscTempo|MoscParam|MoscEnd;\r\n\r\nexport type MoscScore = {\r\n    sequence: MoscItem[];\r\n    lengthTime: number;\r\n};\r\n\r\nexport type MoscItemMs = MoscNoteMs|MoscParamMs|MoscEndMs;\r\n\r\nexport type MoscScoreMs = {\r\n    sequence: MoscItemMs[];\r\n    lengthMs: number;\r\n};\r\n\r\n//\r\n// utils\r\n//\r\n\r\nexport const centsToRatio = (cents: number, octave: number = 0): number => {\r\n    return octaveDivisionToRatio(cents, 1200, 2, octave);\r\n};\r\n\r\nexport const octaveDivisionToRatio = (steps: number, stepsInOctave: number, octaveSize: number, octave: number = 0): number => {\r\n    return Math.pow(octaveSize, (steps + (octave * stepsInOctave)) / stepsInOctave);\r\n};\r\n\r\nexport const ratioToCents = (ratio: number, octave: number = 0): number => {\r\n    return ratioToOctaveDivision(ratio, 1200, 2, octave);\r\n};\r\n\r\nexport const ratioToOctaveDivision = (ratio: number, stepsInOctave: number, octaveSize: number, octave: number = 0): number => {\r\n    return (Math.log(ratio) / Math.log(octaveSize) * stepsInOctave) - (octave * stepsInOctave);\r\n};\r\n\r\nexport const sortByTime = <T extends {time: number}>(items: T[]): T[] => {\r\n    return items.slice().sort((a, b) => {\r\n        if(a.time < b.time) return -1;\r\n        if(a.time > b.time) return 1;\r\n        return 0;\r\n    });\r\n};\r\n\r\nexport const sortByMs = (items: Array<MoscNoteMs>): Array<MoscNoteMs> => {\r\n    return items.slice().sort((a, b) => {\r\n        if(a.ms < b.ms) return -1;\r\n        if(a.ms > b.ms) return 1;\r\n        return 0;\r\n    });\r\n};\r\n\r\n//\r\n// time-based to ms-based conversion\r\n//\r\n\r\nconst tempoTimeToMs = (bpm1: number, bpm2: number, duration: number): number => {\r\n    let u = bpm1 / 60;\r\n    let v = bpm2 / 60;\r\n    let s = duration;\r\n    if(u === v) return s / v * 1000;\r\n    return 2 * s * (v - u) / (v * v - u * u) * 1000;\r\n};\r\n\r\ntype TempoChange = {\r\n    bpm: number;\r\n    bpmEnd: number;\r\n    time: number;\r\n    ms: number;\r\n};\r\n\r\nconst findTempoRangeForTime = (tempoChanges: TempoChange[], time: number): TempoChange => {\r\n    for(let i = tempoChanges.length - 1; i >= 0; i--) {\r\n        if(time >= tempoChanges[i].time) {\r\n            return tempoChanges[i];\r\n        }\r\n    }\r\n    return tempoChanges[0];\r\n};\r\n\r\nexport const timeToMs = (items: MoscItem[]): ((time: number) => number) => {\r\n\r\n    const tempoChanges: TempoChange[] = [];\r\n    tempoChanges.push({\r\n        bpm: 60,\r\n        bpmEnd: 60,\r\n        time: 0,\r\n        ms: 0\r\n    });\r\n\r\n    const tempoItems: MoscTempo[] = items.filter((item: MoscItem): item is MoscTempo => item.type === 'TEMPO');\r\n\r\n    sortByTime(tempoItems).forEach((tempo: MoscTempo, index: number, all: MoscTempo[]) => {\r\n        const lastChange = tempoChanges[tempoChanges.length - 1] as TempoChange;\r\n        const nextTempo: MoscTempo|undefined = all[index + 1];\r\n\r\n        const ms = tempoTimeToMs(lastChange.bpm, lastChange.bpmEnd, tempo.time - lastChange.time) + lastChange.ms;\r\n        const bpmEnd = (nextTempo && nextTempo.lerp) ? nextTempo.bpm : tempo.bpm;\r\n\r\n        tempoChanges.push({\r\n            bpm: tempo.bpm,\r\n            bpmEnd,\r\n            time: tempo.time,\r\n            ms\r\n        });\r\n    });\r\n\r\n    return (time: number): number => {\r\n        const tempoChange: TempoChange = findTempoRangeForTime(tempoChanges, time);\r\n        return tempoTimeToMs(tempoChange.bpm, tempoChange.bpmEnd, time - tempoChange.time) + tempoChange.ms;\r\n    };\r\n};\r\n\r\nexport const scoreToMs = (score: MoscScore): MoscScoreMs => {\r\n    const thisTimeToMs = timeToMs(score.sequence);\r\n\r\n    const sequence: MoscItemMs[] = sortByTime(score.sequence)\r\n        .map((item: MoscItem): MoscItemMs|undefined => {\r\n            if(item.type === 'NOTE_TIME') {\r\n                const note = item as MoscNote;\r\n                return {\r\n                    type: 'NOTE_MS',\r\n                    hz: note.hz,\r\n                    label: note.label,\r\n                    ms: thisTimeToMs(note.time),\r\n                    msEnd: thisTimeToMs(note.timeEnd)\r\n                };\r\n            }\r\n            if(item.type === 'PARAM_TIME') {\r\n                const param = item as MoscParam;\r\n                return {\r\n                    type: 'PARAM_MS',\r\n                    value: param.value,\r\n                    ms: thisTimeToMs(param.time)\r\n                };\r\n            }\r\n            if(item.type === 'END_TIME') {\r\n                const end = item as MoscEnd;\r\n                return {\r\n                    type: 'END_MS',\r\n                    ms: thisTimeToMs(end.time)\r\n                };\r\n            }\r\n            return undefined;\r\n        })\r\n        .filter((item): item is MoscItemMs => !!item);\r\n\r\n    return {\r\n        sequence,\r\n        lengthMs: thisTimeToMs(score.lengthTime)\r\n    };\r\n};\r\n\r\n//\r\n// soud engine base class\r\n//\r\n\r\ntype SoundEngineEndEventCallback = () => void;\r\ntype SoundEngineNoteEventCallback = (noteMs: MoscNoteMs, on: boolean) => void;\r\ntype SoundEngineEventCallbackCancel = () => void;\r\n\r\nexport class SoundEngine {\r\n\r\n    scoreMs?: MoscScoreMs;\r\n\r\n    playing(): boolean {\r\n        return false;\r\n    }\r\n\r\n    looping(): boolean {\r\n        return false;\r\n    }\r\n\r\n    position(): number {\r\n        return 0;\r\n    }\r\n\r\n    endPosition(): number {\r\n        return 0;\r\n    }\r\n\r\n    async play(): Promise<void> {}\r\n\r\n    async pause(): Promise<void> {}\r\n\r\n    async gotoMs(ms: number): Promise<void> {}\r\n\r\n    setLoop(loop: boolean, startMs: number = 0, endMs: number = 0): void {}\r\n    setLoopActive(loop: boolean): void {}\r\n    setLoopStart(ms: number = 0): void {}\r\n    setLoopEnd(ms: number = 0): void {}\r\n\r\n    async setScore(scoreMs: MoscScoreMs): Promise<void> {}\r\n\r\n    // events\r\n\r\n    events = {\r\n        end: new Set<SoundEngineEndEventCallback>(),\r\n        note: new Set<SoundEngineNoteEventCallback>()\r\n    };\r\n\r\n    _triggerEvent(type: string, ...params: any) {\r\n        // @ts-ignore\r\n        this.events[type].forEach(cb => cb(...params));\r\n    }\r\n\r\n    onEnd(callback: SoundEngineEndEventCallback): SoundEngineEventCallbackCancel {\r\n        this.events.end.add(callback);\r\n        return () => {\r\n            this.events.end.delete(callback);\r\n        };\r\n    }\r\n\r\n    onNote(callback: SoundEngineNoteEventCallback): SoundEngineEventCallbackCancel {\r\n        this.events.note.add(callback);\r\n        return () => {\r\n            this.events.note.delete(callback);\r\n        };\r\n    }\r\n}\r\n","import React, {useCallback, useEffect, useRef, useState} from 'react';\r\nimport useDimensions from 'react-use-dimensions';\r\nimport * as ReactKonva from 'react-konva';\r\nimport {useStrictMode} from 'react-konva';\r\nimport {useDendriform, useCheckbox, useInput} from 'dendriform';\r\nimport type {Dendriform} from 'dendriform';\r\nimport type {MoscNoteMs} from '@xenpaper/mosc';\r\nimport {Box, Flex} from './layout/Layout';\r\nimport styled from 'styled-components';\r\nimport hsl from 'hsl-to-hex';\r\n\r\nimport {centsToRatio} from '@xenpaper/mosc';\r\n\r\nuseStrictMode(true);\r\nconst {Stage, Layer, Rect, Group, Text, Line} = ReactKonva as any;\r\n\r\nexport type RulerState = {\r\n    notes: Map<string,MoscNoteMs>;\r\n    notesActive: Map<string,MoscNoteMs>;\r\n    collect: boolean;\r\n    viewPan: number;\r\n    viewZoom: number;\r\n    colourMode: string;\r\n    colourModeThreshold: number;\r\n    colourModeSoft: boolean;\r\n    rootHz?: number;\r\n    octaveSize?: number;\r\n    plots?: MoscNoteMs[][];\r\n};\r\n\r\nconst LOW_HZ_LIMIT = 20;\r\nconst ZOOM_SPEED = 1.1;\r\n\r\nconst hzToPan = (hz: number): number => Math.log2(hz / LOW_HZ_LIMIT);\r\n\r\nconst panToHz = (pan: number): number => Math.pow(2, pan) * LOW_HZ_LIMIT;\r\n\r\nconst panToCents = (pan: number): number => pan * 1200;\r\n\r\nconst panToPx = (pan: number, viewPan: number, viewZoom: number, height: number): number => {\r\n    return height * 0.5 - ((pan - viewPan) * height / viewZoom);\r\n};\r\n\r\nconst pxToPan = (px: number, viewPan: number, viewZoom: number, height: number): number => {\r\n    return viewPan - ((px - (height * 0.5)) / height * viewZoom);\r\n};\r\n\r\nconst hzInRange = (hz: number, [lowHz, highHz]: [number,number]) => {\r\n    return hz >= lowHz && hz <= highHz;\r\n};\r\n\r\n// this is so completely stupid\r\n// and doesnt even work with non 2x octave sizes\r\n// but i'm done with this\r\nconst getGradientColorFromNote = (note: MoscNoteMs): string => {\r\n    const matched = note.label.match(/([\\d.]+)c/);\r\n    if(!matched) {\r\n        return hsl(0, 100, 66);\r\n    }\r\n    const hue = Math.floor(Number(matched[1]) / 1200 * 360 + 180);\r\n    return hsl(hue, 100, 66);\r\n};\r\n\r\nconst getColorFromNoteProximity = (note: MoscNoteMs, proxNotes: MoscNoteMs[], threshold: number, hard: boolean): string => {\r\n    const noteCents = panToCents(hzToPan(note.hz));\r\n    let distance = Math.min(\r\n        ...proxNotes\r\n            .map(note => panToCents(hzToPan(note.hz)))\r\n            .map(cents => Math.abs(noteCents - cents))\r\n    ) / threshold;\r\n\r\n    if(hard) {\r\n        distance = distance > 1 ? 1000 : distance;\r\n    }\r\n\r\n    return hsl(Math.round(360 - (Math.min(distance, 2) * 80)), 100, Math.round(Math.max(1 - distance * 0.5, 0) * 50 + 10));\r\n};\r\n\r\nexport type InitialRulerState = {\r\n    lowHz?: number;\r\n    highHz?: number;\r\n    rootHz?: number;\r\n    octaveSize?: number;\r\n    plots?: MoscNoteMs[][];\r\n};\r\n\r\nexport function useRulerState({lowHz, highHz, ...rest}: InitialRulerState = {}) {\r\n    return useDendriform<RulerState>(() => {\r\n\r\n        let viewPan = hzToPan(220 * 1.5);\r\n        let viewZoom = 1.5;\r\n\r\n        if(lowHz && highHz) {\r\n            const lowPan = hzToPan(lowHz);\r\n            const highPan = hzToPan(highHz);\r\n            viewPan = (lowPan + highPan) * 0.5;\r\n            viewZoom = highPan - lowPan;\r\n        }\r\n\r\n        return {\r\n            notes: new Map(),\r\n            notesActive: new Map(),\r\n            collect: true,\r\n            viewPan,\r\n            viewZoom,\r\n            colourMode: 'gradient',\r\n            colourModeThreshold: 15,\r\n            colourModeSoft: true,\r\n            ...rest\r\n        };\r\n    });\r\n};\r\n\r\ntype Props = {\r\n    rulerState: Dendriform<RulerState,any>;\r\n};\r\n\r\nexport function PitchRuler(props: Props): React.ReactElement|null {\r\n    const {rulerState} = props;\r\n\r\n    const onClear = useCallback(() => {\r\n        rulerState.set(draft => {\r\n            draft.notes.clear();\r\n        });\r\n    }, []);\r\n\r\n    return <Flex flexDirection=\"column\" style={{height: '100%'}}>\r\n        <Flex pt={2} px={2} flexWrap=\"wrap\">\r\n            <Flex flexShrink={0} pb={2}>\r\n                <Box mr={3}>\r\n                    {rulerState.render('collect', form => (\r\n                        <Label>\r\n                            <Box as=\"span\" mr={2}>collect</Box>\r\n                            <input type=\"checkbox\" {...useCheckbox(form)} />\r\n                        </Label>\r\n                    ))}\r\n                </Box>\r\n                <Box mr={3}>\r\n                    <Button onClick={onClear}>clear</Button>\r\n                </Box>\r\n            </Flex>\r\n            <Flex flexShrink={0} pb={2}>\r\n                {rulerState.render('colourMode', form => <>\r\n                    <Box mr={3}>\r\n                        <Label>\r\n                            <Box as=\"span\" mr={2}>colour</Box>\r\n                            <select {...useInput(form)}>\r\n                                <option value=\"gradient\">Gradient</option>\r\n                                <option value=\"proxnotes\">Proximity to notes</option>\r\n                                {rulerState.render('plots', plots => <>\r\n                                    {(plots.useValue() ?? []).map((plot, i) => (\r\n                                        <option key={i} value={`proxplot${i}`}>Proximity to plot {i+1}</option>\r\n                                    ))}\r\n                                </>)}\r\n                            </select>\r\n                        </Label>\r\n                    </Box>\r\n                    {form.useValue() !== 'gradient' && <>\r\n                        <Box mr={3}>\r\n                            {rulerState.render('colourModeThreshold', form => (\r\n                                <Label>\r\n                                    <Box as=\"span\" mr={2}>threshold</Box>\r\n                                    <input\r\n                                        type=\"number\"\r\n                                        value={`${form.useValue()}`}\r\n                                        onChange={(e) => form.set(Number(e.target.value))}\r\n                                        min=\"1\"\r\n                                        max=\"100\"\r\n                                        step=\"1\"\r\n                                    />\r\n                                </Label>\r\n                            ))}\r\n                        </Box>\r\n                        <Box mr={3}>\r\n                            {rulerState.render('colourModeSoft', form => (\r\n                                <Label>\r\n                                    <Box as=\"span\" mr={2}>soft</Box>\r\n                                    <input type=\"checkbox\" {...useCheckbox(form)} />\r\n                                </Label>\r\n                            ))}\r\n                        </Box>\r\n                    </>}\r\n                </>)}\r\n            </Flex>\r\n        </Flex>\r\n        <PitchRulerCanvas {...props} />\r\n    </Flex>;\r\n}\r\n\r\ntype DragStartState = {\r\n    startPan: number;\r\n    startZoom: number;\r\n    startDrag: number;\r\n};\r\n\r\nfunction PitchRulerCanvas(props: Props): React.ReactElement|null {\r\n    const [dimensionsRef, {width = 0, height = 0}] = useDimensions();\r\n\r\n    const rulerState = props.rulerState.useValue();\r\n    const {\r\n        viewPan,\r\n        viewZoom,\r\n        rootHz,\r\n        octaveSize,\r\n        plots = [],\r\n        notes,\r\n        notesActive,\r\n        colourMode,\r\n        colourModeThreshold,\r\n        colourModeSoft\r\n    } = rulerState;\r\n\r\n    const visibleRange: [number,number] = [\r\n        panToHz(pxToPan(height, viewPan, viewZoom, height)),\r\n        panToHz(pxToPan(0, viewPan, viewZoom, height))\r\n    ];\r\n\r\n    const total = plots.length + 1;\r\n    const noteSetWidth = (width - 60) / total;\r\n\r\n    //\r\n    // getters\r\n    //\r\n\r\n    const getY = useCallback((hz: number): number => {\r\n        return panToPx(hzToPan(hz), viewPan, viewZoom, height);\r\n    }, [viewPan, viewZoom, height]);\r\n\r\n    const getColor = useCallback((note: MoscNoteMs): string => {\r\n        if(colourMode === 'gradient') {\r\n            return getGradientColorFromNote(note);\r\n        }\r\n\r\n        let compare: MoscNoteMs[] = [];\r\n        if(colourMode === 'proxnotes') {\r\n            compare = Array.from(notes.values());\r\n        } else if(colourMode.startsWith('proxplot')) {\r\n            const index = Number(colourMode.replace('proxplot',''));\r\n            compare = plots[index] ?? [];\r\n        }\r\n\r\n        return getColorFromNoteProximity(\r\n            note,\r\n            compare,\r\n            colourModeThreshold,\r\n            !colourModeSoft\r\n        );\r\n    }, [colourMode, colourModeThreshold, colourModeSoft, notes, plots]);\r\n\r\n    //\r\n    // interactions\r\n    //\r\n\r\n    const dragStartState = useRef<DragStartState|null>(null);\r\n    const [dragging, setDragging] = useState<boolean>(false);\r\n\r\n    const handleMouseDown = useCallback(({evt}) => {\r\n        evt.preventDefault();\r\n        dragStartState.current = {\r\n            startPan: viewPan,\r\n            startZoom: viewZoom,\r\n            startDrag: pxToPan(evt.clientY, viewPan, viewZoom, height)\r\n        };\r\n        setDragging(true);\r\n    }, [viewPan, viewZoom, height]);\r\n\r\n    const handleMouseMove = useCallback(({evt}) => {\r\n        evt.preventDefault();\r\n        const dragState = dragStartState.current;\r\n        if(dragState) {\r\n            const nowDrag = pxToPan(evt.clientY, dragState.startPan, dragState.startZoom, height);\r\n\r\n            props.rulerState.set(draft => {\r\n                draft.viewPan = dragState.startPan - nowDrag + dragState.startDrag;\r\n            });\r\n        }\r\n    }, [height]);\r\n\r\n    useEffect(() => {\r\n        const onMouseUp = () => {\r\n            dragStartState.current = null;\r\n            setDragging(false);\r\n        };\r\n\r\n        window.addEventListener('mouseup', onMouseUp);\r\n        return () => window.removeEventListener('mouseup', onMouseUp);\r\n    }, []);\r\n\r\n    const handleWheel = useCallback(({evt}) => {\r\n        evt.preventDefault();\r\n        props.rulerState.set(draft => {\r\n            draft.viewZoom *= evt.deltaY > 0 ? ZOOM_SPEED : evt.deltaY < 0 ? 1/ZOOM_SPEED : 1\r\n        });\r\n    }, []);\r\n\r\n    const handleTouchStart = useCallback(({evt}) => {\r\n        evt.preventDefault();\r\n        // console.log('handleTouchStart', {evt});\r\n    }, []);\r\n\r\n    const handleTouchMove = useCallback(({evt}) => {\r\n        evt.preventDefault();\r\n        // console.log('handleTouchMove', {evt});\r\n    }, []);\r\n\r\n    const handleTouchEnd = useCallback(({evt}) => {\r\n        evt.preventDefault();\r\n        // console.log('handleTouchEnd', {evt});\r\n    }, []);\r\n\r\n    // TODO zoom toward cursor position\r\n    // TODO zoom on touch devices\r\n\r\n    //\r\n    // render\r\n    //\r\n\r\n    const style = {\r\n        height: '100%',\r\n        width: '100%',\r\n        backgroundColor: '#080b0e',\r\n        cursor: dragging ? 'grabbing' : 'grab'\r\n    };\r\n\r\n    return <div ref={dimensionsRef} style={style}>\r\n        <Stage\r\n            width={width}\r\n            height={height}\r\n            onMouseDown={handleMouseDown}\r\n            onMouseMove={handleMouseMove}\r\n            onWheel={handleWheel}\r\n            onTouchStart={handleTouchStart}\r\n            onTouchMove={handleTouchMove}\r\n        >\r\n            <Layer>\r\n                {rootHz && octaveSize &&\r\n                    <CentsGrid\r\n                        rootHz={rootHz}\r\n                        octaveSize={octaveSize}\r\n                        getY={getY}\r\n                        width={width}\r\n                        visibleRange={visibleRange}\r\n                    />\r\n                }\r\n                {rootHz && octaveSize &&\r\n                    <RootGrid\r\n                        rootHz={rootHz}\r\n                        octaveSize={octaveSize}\r\n                        getY={getY}\r\n                        width={width}\r\n                        visibleRange={visibleRange}\r\n                    />\r\n                }\r\n                {rulerState.collect &&\r\n                    <NoteSet\r\n                        notes={Array.from(notes.values())}\r\n                        getY={getY}\r\n                        width={noteSetWidth}\r\n                        x={0}\r\n                        visibleRange={visibleRange}\r\n                        getColor={getColor}\r\n                    />\r\n                }\r\n                {(plots || []).map((plot, index) => {\r\n                    return <NoteSet\r\n                        key={index}\r\n                        notes={plot}\r\n                        getY={getY}\r\n                        width={noteSetWidth}\r\n                        x={noteSetWidth * (index + 1)}\r\n                        visibleRange={visibleRange}\r\n                        getColor={getColor}\r\n                    />\r\n                })}\r\n                <NoteSet\r\n                    notes={Array.from(notesActive.values())}\r\n                    getY={getY}\r\n                    color=\"#FFFFFF\"\r\n                    width={noteSetWidth}\r\n                    x={0}\r\n                    visibleRange={visibleRange}\r\n                />\r\n            </Layer>\r\n        </Stage>\r\n    </div>;\r\n}\r\n\r\n\r\n\r\ntype NoteSetProps = {\r\n    notes: MoscNoteMs[];\r\n    getY: (hz: number) => number;\r\n    getColor?: (note: MoscNoteMs) => string;\r\n    color?: string;\r\n    width: number;\r\n    x: number;\r\n    visibleRange: [number,number];\r\n};\r\n\r\nconst NoteSet = React.memo(function NoteSet(props: NoteSetProps): React.ReactElement {\r\n    const {\r\n        width,\r\n        notes,\r\n        getColor = getGradientColorFromNote,\r\n        getY,\r\n        x,\r\n        visibleRange\r\n    } = props;\r\n\r\n    const visibleNotes = notes.filter(note => hzInRange(note.hz, visibleRange));\r\n\r\n    return <>\r\n        {visibleNotes.map((note, index) => {\r\n            const color = props.color ?? getColor(note);\r\n            return <Group key={index} x={x} y={getY(note.hz)}>\r\n                <Line\r\n                    stroke={color}\r\n                    strokeWidth={1}\r\n                    points={[0, 0, width, 0]}\r\n                />\r\n                <Text\r\n                    text={note.label}\r\n                    fill={color}\r\n                    align=\"center\"\r\n                    width={width}\r\n                    y={-13}\r\n                />\r\n            </Group>;\r\n        })}\r\n    </>;\r\n});\r\n\r\nconst Label = styled.label`\r\n    user-select: none;\r\n`;\r\n\r\nconst Button = styled.button`\r\n    border: none;\r\n    display: block;\r\n    padding: .25rem .5rem;\r\n    cursor: pointer;\r\n    background-color: ${props => props.theme.colors.highlights.unknown};\r\n    color: ${props => props.theme.colors.background.normal};\r\n    position: relative;\r\n    outline: none;\r\n    opacity: 0.7;\r\n\r\n    transition: opacity .2s ease-out;\r\n\r\n    &:hover, &:focus, &:active {\r\n        opacity: 1;\r\n    }\r\n`;\r\n\r\ntype RootGridProps = {\r\n    octaveSize: number;\r\n    rootHz: number;\r\n    width: number;\r\n    getY: (hz: number) => number;\r\n    visibleRange: [number,number];\r\n};\r\n\r\nconst ROOT_GRID_POSITIONS = [7,6,5,4,3,2,1,0,-1,-2,-3];\r\n\r\nconst RootGrid = React.memo(function RootGrid(props: RootGridProps): React.ReactElement {\r\n    const {getY, rootHz, octaveSize, width, visibleRange} = props;\r\n\r\n    const lines = ROOT_GRID_POSITIONS\r\n        .map(i => [i, rootHz * Math.pow(octaveSize,i)])\r\n        .filter(([,hz]) => hzInRange(hz, visibleRange));\r\n\r\n    return <>\r\n        {lines.map(([i, hz]) => {\r\n            const y = getY(hz);\r\n            return <Group key={i} y={y}>\r\n                <Line\r\n                    stroke={hsl(208, 32, (8 - Math.abs(i)) * 12)}\r\n                    strokeWidth={1}\r\n                    points={[0, 0, width - 60, 0]}\r\n                    dash={[4,4]}\r\n                />\r\n                <Text\r\n                    text={`${hz}Hz`}\r\n                    fill={hsl(208, 32, (8 - Math.abs(i)) * 24)}\r\n                    align=\"left\"\r\n                    width={55}\r\n                    x={width - 55}\r\n                    y={-5}\r\n                />\r\n            </Group>;\r\n        })}\r\n    </>;\r\n});\r\n\r\nconst CENT_GRID_POSITIONS = [1,0,-1];\r\n\r\ntype CentsGridProps = {\r\n    octaveSize: number;\r\n    rootHz: number;\r\n    width: number;\r\n    getY: (hz: number) => number;\r\n    visibleRange: [number,number];\r\n};\r\n\r\nconst CentsGrid = React.memo(function CentsGrid(props: CentsGridProps): React.ReactElement {\r\n    const {getY, rootHz, octaveSize, width, visibleRange} = props;\r\n\r\n    const lines: [number,number,number][] = [];\r\n\r\n    CENT_GRID_POSITIONS.forEach(octave => {\r\n        for(let i = 100; i < octaveSize * 600; i+=100) {\r\n            const hz = rootHz * centsToRatio(i, octave);\r\n            if(hzInRange(hz, visibleRange)) {\r\n                lines.push([i, hz, octave]);\r\n            }\r\n        }\r\n    });\r\n\r\n    return <>\r\n        {lines.map(([cents, hz, octave]) => {\r\n            const y = getY(hz);\r\n            return <Group key={hz} y={y}>\r\n                <Line\r\n                    stroke={hsl(208, 32, (2 - Math.abs(octave)) * 12)}\r\n                    strokeWidth={1}\r\n                    points={[0, 0, width - 60, 0]}\r\n                />\r\n                <Text\r\n                    text={`${cents}c`}\r\n                    fill={hsl(208, 32, (2 - Math.abs(octave)) * 24)}\r\n                    align=\"left\"\r\n                    width={55}\r\n                    x={width - 55}\r\n                    y={-5}\r\n                />\r\n            </Group>;\r\n        })}\r\n    </>;\r\n});\r\n","import Parser, {All, Any, Optional, Star, Node} from 'rd-parse';\r\n\r\nexport type NodeType = {\r\n    type: string;\r\n    delimiter: boolean;\r\n    pos: number;\r\n    len: number;\r\n    time?: [number, number];\r\n};\r\n\r\nexport type Meta = {\r\n    pos: number;\r\n};\r\n\r\nexport type NodeCreator = (args: any) => {[key: string]: any};\r\n\r\nfunction node/*<T extends NodeType>*/(type: string, match: RegExp|string, fn: NodeCreator) {\r\n    return Node(match, (value: unknown, meta: Meta) => {\r\n        return {\r\n            type,\r\n            delimiter: false,\r\n            ...fn(value),\r\n            pos: meta.pos\r\n        };\r\n    });\r\n}\r\n\r\nconst sumLen = (nodes: NodeType[]): number => nodes.reduce((len: number, node: NodeType) => len + node.len, 0);\r\n\r\n//\r\n// delimiters and whitespace\r\n//\r\n\r\nconst delimiter = ([text]: [string]) => ({\r\n    delimiter: true,\r\n    len: text.length\r\n});\r\n\r\nexport type DelimiterType = NodeType & {\r\n    delimiter: true;\r\n};\r\n\r\nexport const Semicolon = node/*<DelimiterType>*/(\r\n    'Semicolon',\r\n    /(^[;]\\s*)/,\r\n    delimiter\r\n);\r\n\r\nexport const Colon = node/*<DelimiterType>*/(\r\n    'Colon',\r\n    /(^[:]\\s*)/,\r\n    delimiter\r\n);\r\n\r\nexport const BarLine = node/*<DelimiterType>*/(\r\n    'BarLine',\r\n    '|',\r\n    () => ({\r\n        len: 1,\r\n        delimiter: true\r\n    })\r\n);\r\n\r\n/**\r\n * One or more /\\s/ or comma\r\n */\r\nexport const Whitespace = node/*<DelimiterType>*/(\r\n    'Whitespace',\r\n    /(^[,\\s]+)/,\r\n    ([whitespace]) => ({\r\n        len: whitespace.length,\r\n        delimiter: true\r\n    })\r\n);\r\n\r\n//\r\n// pitches\r\n//\r\n\r\ntype OctaveModifierType = NodeType & {\r\n    octave: number;\r\n};\r\n\r\nexport const OctaveModifier = node/*<OctaveModifierType>*/(\r\n    'OctaveModifier',\r\n    /^(['\"]+|`+)/,\r\n    ([chars]) => ({\r\n        octave: (chars.split(\"'\").length - 1) + ((chars.split('\"').length - 1) * 2) - (chars.split('`').length - 1),\r\n        len: chars.length\r\n    })\r\n);\r\n\r\nexport type PitchCentsType = NodeType & {\r\n    cents: number;\r\n};\r\n\r\nexport const PitchCents = node/*<PitchCentsType>*/(\r\n    'PitchCents',\r\n    /^(\\d+|\\d+\\.(\\d+)?)c/,\r\n    ([cents]) => ({\r\n        cents: Number(cents),\r\n        len: cents.length + 1\r\n    })\r\n);\r\n\r\nexport type PitchOctaveDivisionType = NodeType & {\r\n    numerator: number;\r\n    denominator: number;\r\n    octaveSize: number;\r\n};\r\n\r\nexport const PitchOctaveDivision = node/*<PitchOctaveDivisionType>*/(\r\n    'PitchOctaveDivision',\r\n    /^([\\d]+)[\\\\/]([\\d]+)o(\\d)?(\\/(\\d))?/,\r\n    ([numerator, denominator, octaveSize = '', slash = '', octaveDenom = '']) => ({\r\n        numerator: Number(numerator),\r\n        denominator: Number(denominator),\r\n        octaveSize: Number(octaveSize || 2) / Number(octaveDenom || 1),\r\n        len: numerator.length + denominator.length + octaveSize.length + 2 + slash.length\r\n    })\r\n);\r\n\r\nexport const PitchOctaveDivision2 = node/*<PitchOctaveDivisionType>*/(\r\n    'PitchOctaveDivision',\r\n    /^([\\d]+)[\\\\]([\\d]+)/,\r\n    ([numerator, denominator]) => ({\r\n        numerator: Number(numerator),\r\n        denominator: Number(denominator),\r\n        octaveSize: 2,\r\n        len: numerator.length + denominator.length + 1\r\n    })\r\n);\r\n\r\nexport type PitchRatioType = NodeType & {\r\n    numerator: number;\r\n    denominator: number;\r\n};\r\n\r\nexport const PitchRatio = node/*<PitchRatioType>*/(\r\n    'PitchRatio',\r\n    /^([\\d]+)\\/([\\d]+)/,\r\n    ([numerator, denominator]) => ({\r\n        numerator: Number(numerator),\r\n        denominator: Number(denominator),\r\n        len: numerator.length + denominator.length + 1\r\n    })\r\n);\r\n\r\nexport type PitchDegreeType = NodeType & {\r\n    degree: number;\r\n};\r\n\r\nexport const PitchDegree = node/*<PitchDegreeType>*/(\r\n    'PitchDegree',\r\n    /^([\\d]+)/,\r\n    ([degree]) => ({\r\n        degree: Number(degree),\r\n        len: degree.length\r\n    })\r\n);\r\n\r\nexport type PitchHzType = NodeType & {\r\n    hz: number;\r\n};\r\n\r\nexport const PitchHz = node/*<PitchHzType>*/(\r\n    'PitchHz',\r\n    /^(\\d+|\\d+\\.(\\d+)?)hz/i,\r\n    ([hz]: [string]) => ({\r\n        hz: Number(hz),\r\n        len: hz.length + 2\r\n    })\r\n);\r\n\r\nexport type PitchType = NodeType & {\r\n    value: PitchCentsType|PitchOctaveDivisionType|PitchRatioType|PitchDegreeType|PitchHzType;\r\n    octave?: OctaveModifierType;\r\n};\r\n\r\nexport const Pitch = node/*<PitchType>*/(\r\n    'Pitch',\r\n    All(Optional(OctaveModifier), Any(PitchCents, PitchHz, PitchOctaveDivision, PitchOctaveDivision2, PitchRatio, PitchDegree)),\r\n    (args) => {\r\n        if(args.length === 1) {\r\n            const [value] = args;\r\n            return {\r\n                value,\r\n                len: value.len\r\n            };\r\n        }\r\n        const [octave, value] = args;\r\n        return {\r\n            value,\r\n            octave,\r\n            len: octave.len + value.len\r\n        };\r\n    }\r\n);\r\n\r\nexport type PitchGroupType = Array<PitchType|DelimiterType>;\r\n\r\n// Note: this appears as an array of Pitch objects\r\nexport const PitchGroup = Node(\r\n    All(Pitch, Star(All(Whitespace, Pitch))),\r\n    (elements: unknown) => elements\r\n);\r\n\r\n//\r\n// note\r\n//\r\n\r\nexport type HoldType = NodeType & {\r\n    length: number;\r\n};\r\n\r\nexport const Hold = node/*<HoldType>*/(\r\n    'Hold',\r\n    /^(([|]?-)+)/,\r\n    ([value]) => ({\r\n        length: value.replace(/[|]+/g, '').length,\r\n        len: value.length\r\n    })\r\n);\r\n\r\nexport type TailType = HoldType;\r\n\r\nexport const Tail = Any(Hold);\r\n\r\nexport type RestType = NodeType & {\r\n    length: number;\r\n};\r\n\r\nexport const Rest = node/*<RestType>*/(\r\n    'Rest',\r\n    All(/^(\\.)/),\r\n    ([value]: [unknown[]]) => ({\r\n        length: value.length,\r\n        len: value.length\r\n    })\r\n);\r\n\r\nexport type NoteType = NodeType & {\r\n    pitch: PitchType;\r\n    tail?: TailType;\r\n};\r\n\r\nexport const Note = node/*<NoteType>*/(\r\n    'Note',\r\n    All(Pitch, Optional(Tail)),\r\n    ([pitch, tail]: [PitchType, TailType?]) => ({\r\n        pitch,\r\n        tail,\r\n        len: pitch.len + (tail ? tail.len : 0)\r\n    })\r\n);\r\n\r\n//\r\n// chords\r\n//\r\n\r\nexport type RatioChordPitchType = NodeType & {\r\n    pitch: number;\r\n};\r\n\r\nexport const RatioChordPitch = node/*<RatioChordPitchType>*/(\r\n    'RatioChordPitch',\r\n    /^([\\d]+)/,\r\n    ([pitch]: [string]) => ({\r\n        pitch: Number(pitch),\r\n        len: pitch.length\r\n    })\r\n);\r\n\r\nexport type RatioChordPitchGroupType = Array<RatioChordPitchType|DelimiterType>;\r\n\r\nexport const RatioChordPitchGroup = Node(\r\n    All(RatioChordPitch, Colon, Optional(Colon), RatioChordPitch, Star(All(Colon, Optional(Colon),  RatioChordPitch))),\r\n    (elements: RatioChordPitchGroupType) => elements\r\n);\r\n\r\nexport type ChordType = NodeType & {\r\n    pitches: Array<RatioChordPitchType|PitchType|DelimiterType>;\r\n    tail?: TailType;\r\n};\r\n\r\nexport const Chord = node/*<ChordType>*/(\r\n    'Chord',\r\n    All('[', Any(RatioChordPitchGroup, PitchGroup), ']', Optional(Tail)),\r\n    ([pitches, tail]) => ({\r\n        pitches,\r\n        tail,\r\n        len: sumLen(pitches) + (tail ? tail.len : 0) + 2\r\n    })\r\n);\r\n\r\nexport type RatioChordType = NodeType & {\r\n    pitches: Array<RatioChordPitchType>;\r\n    tail?: TailType;\r\n};\r\n\r\nexport const RatioChord = node/*<RatioChordType>*/(\r\n    'RatioChord',\r\n    All(RatioChordPitchGroup, Optional(Tail)),\r\n    ([pitches, tail]) => ({\r\n        pitches,\r\n        tail,\r\n        len: sumLen(pitches) + (tail ? tail.len : 0)\r\n    })\r\n);\r\n\r\n//\r\n// scales\r\n//\r\n\r\nexport type EdoScaleType = NodeType & {\r\n    divisions: number;\r\n    octaveSize: number;\r\n};\r\n\r\nexport const EdoScale = node/*<EdoScaleType>*/(\r\n    'EdoScale',\r\n    /^(\\d+)ed([o\\d])(\\/(\\d))?/i,\r\n    ([divisions, octaveSize, slash = '', denominator = '']: [string, string, string, string]) => ({\r\n        divisions: Number(divisions),\r\n        // TODO this math should not be in the grammar\r\n        octaveSize: octaveSize === 'o' ? 2 : Number(octaveSize) / Number(denominator || 1),\r\n        len: divisions.length + octaveSize.length + 2 + slash.length\r\n    })\r\n);\r\n\r\nexport type ScaleOctaveMarkerType = NodeType;\r\n\r\nexport const ScaleOctaveMarker = node/*<ScaleOctaveMarkerType>*/(\r\n    'ScaleOctaveMarker',\r\n    \"'\",\r\n    () => ({\r\n        len: 1\r\n    })\r\n);\r\n\r\nexport type PitchGroupScalePrefixType = NodeType & {\r\n    prefix: string;\r\n};\r\n\r\nexport const PitchGroupScalePrefix = node/*<EdoScaleType>*/(\r\n    'PitchGroupScalePrefix',\r\n    /(^[m])(\\s*)/,\r\n    ([prefix, space]: [string, string?]) => ({\r\n        prefix,\r\n        len: prefix.length + (space ? space.length : 0)\r\n    })\r\n);\r\n\r\nexport type PitchGroupScaleType = NodeType & {\r\n    pitchGroupScalePrefix?: PitchGroupScalePrefixType;\r\n    pitches: PitchGroupType;\r\n    scaleOctaveMarker?: ScaleOctaveMarkerType;\r\n};\r\n\r\nexport const PitchGroupScale = node/*<PitchGroupScaleType>*/(\r\n    'PitchGroupScale',\r\n    All(Optional(PitchGroupScalePrefix), PitchGroup, Optional(ScaleOctaveMarker)),\r\n    (elements: any[]) => {\r\n\r\n        const [pitchGroupScalePrefix, pitches, scaleOctaveMarker] = Array.isArray(elements[0])\r\n            ? [undefined, ...elements]\r\n            : elements;\r\n\r\n        return {\r\n            pitchGroupScalePrefix,\r\n            pitches,\r\n            scaleOctaveMarker,\r\n            len: (pitchGroupScalePrefix ? pitchGroupScalePrefix.len : 0) + sumLen(pitches) + (scaleOctaveMarker ? scaleOctaveMarker.len : 0)\r\n        };\r\n    }\r\n);\r\n\r\nexport type RatioChordScaleType = NodeType & {\r\n    pitches: Array<RatioChordPitchType|DelimiterType>;\r\n    scaleOctaveMarker?: ScaleOctaveMarkerType;\r\n};\r\n\r\nexport const RatioChordScale = node/*<RatioChordScaleType>*/(\r\n    'RatioChordScale',\r\n    All(RatioChordPitchGroup, Optional(ScaleOctaveMarker)),\r\n    ([pitches, scaleOctaveMarker]: [RatioChordPitchGroupType, ScaleOctaveMarkerType?]) => ({\r\n        pitches,\r\n        scaleOctaveMarker,\r\n        len: sumLen(pitches) + (scaleOctaveMarker ? scaleOctaveMarker.len : 0)\r\n    })\r\n);\r\n\r\n//\r\n// scale setters\r\n//\r\n\r\nexport const Scale = Any(EdoScale, RatioChordScale, PitchGroupScale);\r\n\r\nexport type SetScaleType = NodeType & {\r\n    scale: EdoScaleType|RatioChordScaleType|PitchGroupScaleType;\r\n};\r\n\r\nexport const SetScale = node/*<SetScaleType>*/(\r\n    'SetScale',\r\n    All('{', Scale, '}'),\r\n    ([scale]) => ({\r\n        scale,\r\n        len: scale.len + 2\r\n    })\r\n);\r\n\r\nexport type SetRootType = NodeType & {\r\n    pitch: PitchType\r\n};\r\n\r\nexport const SetRoot = node/*<SetRootType>*/(\r\n    'SetRoot',\r\n    All('{r', Pitch, '}'),\r\n    ([pitch]) => ({\r\n        pitch,\r\n        len: pitch.len + 3\r\n    })\r\n);\r\n\r\n//\r\n// setters\r\n//\r\n\r\n// bpm\r\n\r\nexport type SetBpmValue = NodeType & {\r\n    bpm: number;\r\n};\r\n\r\nexport const SetBpmValue = node/*<SetBpmValueType>*/(\r\n    'SetBpmValue',\r\n    /^(\\d+(\\.\\d+)?)/,\r\n    ([bpm]: [string]) => ({\r\n        bpm: Number(bpm),\r\n        len: bpm.length\r\n    })\r\n);\r\n\r\nexport type SetBpmType = NodeType & {\r\n    bpm: number;\r\n};\r\n\r\nexport type SetBpmValueType = NodeType & {\r\n    bpm: number;\r\n};\r\n\r\nexport const SetBpm = node/*<SetBpmType>*/(\r\n    'SetBpm',\r\n    All(/^(bpm:\\s*)/, SetBpmValue),\r\n    ([prefix, value]: [string, SetBpmValueType]) => ({\r\n        bpm: value.bpm,\r\n        len: prefix.length + value.len\r\n    })\r\n);\r\n\r\n// bms (beat milliseconds)\r\n\r\nexport type SetBmsValue = NodeType & {\r\n    bms: number;\r\n};\r\n\r\nexport const SetBmsValue = node/*<SetBmsValueType>*/(\r\n    'SetBmsValue',\r\n    /^(\\d+(\\.\\d+)?)/,\r\n    ([bms]: [string]) => ({\r\n        bms: Number(bms),\r\n        len: bms.length\r\n    })\r\n);\r\n\r\nexport type SetBmsType = NodeType & {\r\n    bms: number;\r\n};\r\n\r\nexport type SetBmsValueType = NodeType & {\r\n    bms: number;\r\n};\r\n\r\nexport const SetBms = node/*<SetBmsType>*/(\r\n    'SetBms',\r\n    All(/^(bms:\\s*)/, SetBmsValue),\r\n    ([prefix, value]: [string, SetBmsValueType]) => ({\r\n        bms: value.bms,\r\n        len: prefix.length + value.len\r\n    })\r\n);\r\n\r\n\r\n// subdivision\r\n\r\nexport type SetSubdivisionValueType = NodeType & {\r\n    subdivision: number;\r\n    denominator: number;\r\n};\r\n\r\n// TODO - could be a generic number matcher\r\nexport const SetSubdivisionValue = node/*<SetSubdivisionValueType>*/(\r\n    'SetSubdivisionValue',\r\n    /^([\\d]+)(\\/(\\d))?/,\r\n    ([subdivision, slash = '', denominator = '']: [string, string, string]) => ({\r\n        subdivision: Number(subdivision),\r\n        denominator: denominator ? Number(denominator) : undefined,\r\n        len: subdivision.length + slash.length\r\n    })\r\n);\r\n\r\nexport type SetSubdivisionType = NodeType & {\r\n    subdivision: number;\r\n    denominator: number;\r\n};\r\n\r\nexport const SetSubdivision = node/*<SetSubdivisionType>*/(\r\n    'SetSubdivision',\r\n    All(/^((div:)?\\s*)/, SetSubdivisionValue),\r\n    ([prefix,, value]: [string, string, SetSubdivisionValueType]) => ({\r\n        subdivision: value.subdivision,\r\n        denominator: value.denominator,\r\n        len: prefix.length + value.len\r\n    })\r\n);\r\n\r\n// osc\r\n\r\nexport type SetOscValueType = NodeType & {\r\n    osc: string;\r\n};\r\n\r\nexport const SetOscValue = node/*<SetOscValueType>*/(\r\n    'SetOscValue',\r\n    /^([a-z0-9]*)/,\r\n    ([osc]: [string]) => ({\r\n        osc,\r\n        len: osc.length\r\n    })\r\n);\r\n\r\nexport type SetOscType = NodeType & {\r\n    osc: string;\r\n};\r\n\r\nexport const SetOsc = node/*<SetOscType>*/(\r\n    'SetOsc',\r\n    All(/^(osc:\\s*)/, SetOscValue),\r\n    ([prefix, value]: [string, SetOscValueType]) => ({\r\n        osc: value.osc,\r\n        len: prefix.length + value.len\r\n    })\r\n);\r\n\r\n// env\r\n\r\nexport type SetEnvValueType = NodeType & {\r\n    a: number;\r\n    d: number;\r\n    s: number;\r\n    r: number;\r\n};\r\n\r\nexport const SetEnvValue = node/*<SetEnvValueType>*/(\r\n    'SetEnvValue',\r\n    /^(([0-9])([0-9])([0-9])([0-9]))/,\r\n    ([all, a, d, s, r]: [string, string, string, string, string]) => ({\r\n        a: Number(a),\r\n        d: Number(d),\r\n        s: Number(s),\r\n        r: Number(r),\r\n        len: all.length\r\n    })\r\n);\r\n\r\nexport type SetEnvType = NodeType & {\r\n    a: number;\r\n    d: number;\r\n    s: number;\r\n    r: number;\r\n};\r\n\r\nexport const SetEnv = node/*<SetEnvType>*/(\r\n    'SetEnv',\r\n    All(/^(env:\\s*)/, SetEnvValue),\r\n    ([prefix, value]: [string, SetEnvValueType]) => ({\r\n        a: value.a,\r\n        d: value.d,\r\n        s: value.s,\r\n        r: value.r,\r\n        len: prefix.length + value.len\r\n    })\r\n);\r\n\r\n// ruler\r\n\r\nexport type SetRulerRangeType = NodeType & {\r\n    low: PitchType;\r\n    high: PitchType;\r\n};\r\n\r\nexport const SetRulerRange = node/*<SetRulerRangeType>*/(\r\n    'SetRulerRange',\r\n    All(/^(rl:)/, Pitch, ',', Pitch),\r\n    ([prefix, low, high]: [string, PitchType, PitchType]) => ({\r\n        low,\r\n        high,\r\n        len: prefix.length + 1 + low.len + high.len\r\n    })\r\n);\r\n\r\nexport type SetRulerPlotType = NodeType;\r\n\r\nexport const SetRulerPlot = node/*<SetRulerPlotType>*/(\r\n    'SetRulerPlot',\r\n    'plot',\r\n    () => ({\r\n        len: 4\r\n    })\r\n);\r\n\r\nexport type SetRulerType = SetRulerRangeType|SetRulerPlotType;\r\n\r\nexport const SetRuler = Any(SetRulerRange, SetRulerPlot);\r\n\r\n// Tuning of primes\r\n// Affects calculation of ratio frequencies\r\n\r\nexport type SetPrimesType = NodeType & {\r\n    primesPitches: PitchGroupType\r\n};\r\n\r\nexport const SetPrimes = node/*<SetPrimesType>*/(\r\n    'SetPrimes',\r\n    All(/^(primes:\\s*)/, PitchGroup),\r\n    ([prefix, primesPitches]: [string, PitchGroupType]) => ({\r\n        primesPitches,\r\n        len: prefix.length + sumLen(primesPitches)\r\n    })\r\n);\r\n\r\n\r\n// setters\r\n\r\nexport type SetterType = SetBpmType|SetBmsType|SetSubdivisionType|SetOscType|SetEnvType|SetRulerType|SetPrimesType;\r\n\r\nexport const Setter = Any(SetBpm, SetBms, SetSubdivision, SetOsc, SetEnv, SetRuler, SetPrimes);\r\n\r\nexport type SetterGroupType = NodeType & {\r\n    setters: SetterType[];\r\n};\r\n\r\nexport const SetterGroup = node/*<SetterGroupType>*/(\r\n    'SetterGroup',\r\n    All('(', Setter, Star(All(Semicolon, Setter)), ')'),\r\n    (setters: SetterType[]) => ({\r\n        setters,\r\n        len: sumLen(setters) + 2\r\n    })\r\n);\r\n\r\n//\r\n// comments\r\n//\r\n\r\nexport type CommentType = NodeType & {\r\n    comment: string;\r\n};\r\n\r\nexport const Comment = node/*<CommentType>*/(\r\n    'Comment',\r\n    /^#([^\\n]*)/,\r\n    ([comment]) => ({\r\n        comment,\r\n        len: comment.length + 1\r\n    })\r\n);\r\n\r\n//\r\n// sequence\r\n//\r\n\r\nexport type SequenceItemsType = RatioChordType|NoteType|ChordType|RestType|SetterGroupType|SetScaleType|SetRootType|SetPrimesType|CommentType;\r\n\r\nexport type SequenceType = NodeType & {\r\n    items: SequenceItemsType[];\r\n};\r\n\r\nexport const Sequence = node/*<SequenceType>*/(\r\n    'Sequence',\r\n    Star(Any(Comment, RatioChord, Note, Chord, Rest, SetterGroup, SetScale, SetRoot, BarLine, Whitespace)),\r\n    (items: SequenceItemsType[]) => ({\r\n        items,\r\n        len: sumLen(items)\r\n    })\r\n);\r\n\r\n//\r\n// params\r\n//\r\n\r\nexport type ParamEmbedType = NodeType;\r\n\r\nexport const ParamEmbed = node/*<ParamEmbedType>*/(\r\n    'ParamEmbed',\r\n    'embed',\r\n    () => ({\r\n        len: 5\r\n    })\r\n);\r\n\r\nexport type ParamType = ParamEmbedType;\r\n\r\nexport const Param = Any(ParamEmbed);\r\n\r\nexport type ParamGroupType = NodeType & {\r\n    params: ParamType[];\r\n};\r\n\r\nexport const ParamGroup = node/*<ParamGroupType>*/(\r\n    'ParamGroup',\r\n    All(Param, Star(All(Semicolon, Param)), ':'),\r\n    (params: ParamType[]) => ({\r\n        params,\r\n        len: sumLen(params) + 1\r\n    })\r\n);\r\nexport type XenpaperAST = NodeType & {\r\n    sequence?: SequenceType;\r\n    paramGroup?: ParamGroupType;\r\n};\r\n\r\nexport const XenpaperGrammar = node/*<XenpaperAST>*/(\r\n    'XenpaperGrammar',\r\n    All(Optional(ParamGroup), Optional(Sequence)),\r\n    (parts: Array<SequenceType>) => {\r\n        const paramGroup = parts.find(part => part.type === 'ParamGroup');\r\n        const sequence = parts.find(part => part.type === 'Sequence');\r\n        return {\r\n            sequence,\r\n            paramGroup,\r\n            len: sequence ? sequence.len : 0\r\n        };\r\n    }\r\n);\r\n\r\nconst parser = Parser(XenpaperGrammar);\r\n\r\nexport const XenpaperGrammarParser = (input: string): XenpaperAST => {\r\n    try {\r\n        return parser(input);\r\n    } catch(e: any) {\r\n        // eslint-disable-next-line no-console\r\n        console.error('e', e);\r\n        throw new Error(e.message.replace(/Remainder:.*/s, ''));\r\n    }\r\n};\r\n","import type {XenpaperAST} from './grammar';\r\n\r\nexport type HighlightColor = 'delimiter'\r\n    |'pitch'\r\n    |'chord'\r\n    |'scaleGroup'\r\n    |'scale'\r\n    |'setterGroup'\r\n    |'setter'\r\n    |'comment'\r\n    |'commentStart'\r\n    |'unknown'\r\n    |'error'\r\n    |'errorMessage';\r\n\r\nexport type CharData = {\r\n    color: HighlightColor;\r\n    playTime?: [number, number];\r\n};\r\n\r\nconst colorMap = new Map<string,HighlightColor>([\r\n    ['Semicolon','delimiter'],\r\n    ['Colon','delimiter'],\r\n    // ['PitchCents','pitch'],\r\n    // ['PitchOctaveDivision','pitch'],\r\n    // ['PitchRatio','pitch'],\r\n    // ['PitchDegree','pitch'],\r\n    // ['PitchHz','pitch'],\r\n    // ['OctaveModifier','pitch'],\r\n    ['Pitch','pitch'],\r\n    ['RatioChordPitch','pitch'],\r\n    ['Chord','chord'],\r\n    ['Chord.Whitespace','pitch'],\r\n    // ['RatioChord'],\r\n    ['Hold','pitch'],\r\n    ['Rest','delimiter'],\r\n    ['BarLine','delimiter'],\r\n    ['Whitespace','delimiter'],\r\n    ['EdoScale','scale'],\r\n    ['PitchGroupScale','scale'],\r\n    ['PitchGroupScale.Pitch','scale'],\r\n    ['PitchGroupScale.Whitespace','scale'],\r\n    ['RatioChordScale','scale'],\r\n    ['RatioChordScale.RatioChordPitch','scale'],\r\n    ['RatioChordScale.Colon','scale'],\r\n    ['ScaleOctaveMarker','scale'],\r\n    ['SetScale','scaleGroup'],\r\n    ['SetRoot','scaleGroup'],\r\n    ['SetRoot.Pitch','scale'],\r\n    ['SetBpm','setter'],\r\n    ['SetBms','setter'],\r\n    ['SetSubdivision','setter'],\r\n    ['SetOsc','setter'],\r\n    ['SetEnv','setter'],\r\n    ['SetRulerPlot','setter'],\r\n    ['SetRulerRange','setter'],\r\n    ['SetRulerRange.Pitch','setter'],\r\n    ['SetterGroup','setterGroup'],\r\n    ['SetterGroup.Semicolon','setterGroup'],\r\n    ['Comment','comment']\r\n]);\r\n\r\n// need to pass playhead time in\r\nconst extract = (chars: CharData[], data: any, parent: string, withinTime?: number): void => {\r\n    if(Array.isArray(data)) {\r\n        data.forEach(value => extract(chars, value, parent, withinTime));\r\n        return;\r\n    }\r\n    if(data instanceof Object) {\r\n        const color = colorMap.get(`${parent}.${data.type}`) || colorMap.get(data.type);\r\n        const time = withinTime ?? data.time;\r\n\r\n        if(typeof data.pos === 'number' && typeof data.len === 'number' && color) {\r\n            for(let i = 0; i < data.len; i++) {\r\n                chars[data.pos + i] = {\r\n                    color: (color === 'comment' && i === 0) ? 'commentStart' : color,\r\n                    playTime: time\r\n                };\r\n            }\r\n        }\r\n        Object.keys(data).forEach(key => {\r\n            extract(chars, data[key], data.type, time);\r\n        });\r\n        return;\r\n    }\r\n};\r\n\r\nexport const grammarToChars = ({sequence}: XenpaperAST): CharData[] => {\r\n    if(!sequence) return [];\r\n    const {items} = sequence;\r\n    const chars: CharData[] = [];\r\n    extract(chars, items, '');\r\n    return chars;\r\n};\r\n","import type {\r\n    XenpaperAST,\r\n    SetScaleType,\r\n    NoteType,\r\n    ChordType,\r\n    RatioChordType,\r\n    TailType,\r\n    PitchType,\r\n    PitchRatioType,\r\n    PitchCentsType,\r\n    PitchHzType,\r\n    PitchOctaveDivisionType,\r\n    PitchDegreeType,\r\n    PitchGroupScaleType,\r\n    EdoScaleType,\r\n    RatioChordScaleType,\r\n    RatioChordPitchType,\r\n    HoldType,\r\n    RestType,\r\n    SetterGroupType,\r\n    SetterType,\r\n    SetSubdivisionType,\r\n    SetBpmType,\r\n    SetBmsType,\r\n    SetRootType,\r\n    SetOscType,\r\n    SetEnvType,\r\n    SetPrimesType,\r\n    SetRulerRangeType,\r\n    DelimiterType,\r\n} from \"./grammar\";\r\n\r\nimport type {\r\n    MoscScore,\r\n    MoscItem,\r\n    MoscNote,\r\n    MoscNoteMs,\r\n    MoscTempo,\r\n    MoscParam,\r\n    MoscEnd,\r\n} from \"@xenpaper/mosc\";\r\n\r\nimport {\r\n    centsToRatio,\r\n    octaveDivisionToRatio,\r\n    timeToMs,\r\n    ratioToCents,\r\n} from \"@xenpaper/mosc\";\r\n\r\n//\r\n// utils\r\n//\r\n\r\nconst limit = (name: string, value: number, min: number, max: number): void => {\r\n    if (value < min || value > max) {\r\n        throw new Error(\r\n            `${name} must be between ${min} and ${max}, got ${value}`\r\n        );\r\n    }\r\n};\r\n\r\n/**\r\n * An arbitrarily long list of primes so that prime decomposition of ratios can happen more efficiently.\r\n * Hope that no one uses anything more than 6691-limit just intonation.\r\n */\r\nconst LIST_OF_PRIMES: number[] = [\r\n    2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31, 37, 41, 43, 47, 53, 59, 61, 67, 71, 73, 79, 83, 89,\r\n    97, 101, 103, 107, 109, 113, 127, 131, 137, 139, 149, 151, 157, 163, 167, 173, 179, 181, 191,\r\n    193, 197, 199, 211, 223, 227, 229, 233, 239, 241, 251, 257, 263, 269, 271, 277, 281, 283, 293,\r\n    307, 311, 313, 317, 331, 337, 347, 349, 353, 359, 367, 373, 379, 383, 389, 397, 401, 409, 419,\r\n    421, 431, 433, 439, 443, 449, 457, 461, 463, 467, 479, 487, 491, 499, 503, 509, 521, 523, 541,\r\n    547, 557, 563, 569, 571, 577, 587, 593, 599, 601, 607, 613, 617, 619, 631, 641, 643, 647, 653,\r\n    659, 661, 673, 677, 683, 691, 701, 709, 719, 727, 733, 739, 743, 751, 757, 761, 769, 773, 787,\r\n    797, 809, 811, 821, 823, 827, 829, 839, 853, 857, 859, 863, 877, 881, 883, 887, 907, 911, 919,\r\n    929, 937, 941, 947, 953, 967, 971, 977, 983, 991, 997, 1009, 1013, 1019, 1021, 1031, 1033, 1039, 1049,\r\n    1051, 1061, 1063, 1069, 1087, 1091, 1093, 1097, 1103, 1109, 1117, 1123, 1129, 1151, 1153, 1163, 1171, 1181, 1187, 1193,\r\n    1201, 1213, 1217, 1223, 1229, 1231, 1237, 1249, 1259, 1277, 1279, 1283, 1289, 1291, 1297, 1301, 1303, 1307, 1319, 1321,\r\n    1327, 1361, 1367, 1373, 1381, 1399, 1409, 1423, 1427, 1429, 1433, 1439, 1447, 1451, 1453, 1459, 1471, 1481, 1483, 1487,\r\n    1489, 1493, 1499, 1511, 1523, 1531, 1543, 1549, 1553, 1559, 1567, 1571, 1579, 1583, 1597, 1601, 1607, 1609, 1613, 1619,\r\n    1621, 1627, 1637, 1657, 1663, 1667, 1669, 1693, 1697, 1699, 1709, 1721, 1723, 1733, 1741, 1747, 1753, 1759, 1777, 1783,\r\n    1787, 1789, 1801, 1811, 1823, 1831, 1847, 1861, 1867, 1871, 1873, 1877, 1879, 1889, 1901, 1907, 1913, 1931, 1933, 1949,\r\n    1951, 1973, 1979, 1987, 1993, 1997, 1999, 2003, 2011, 2017, 2027, 2029, 2039, 2053, 2063, 2069, 2081, 2083, 2087, 2089,\r\n    2099, 2111, 2113, 2129, 2131, 2137, 2141, 2143, 2153, 2161, 2179, 2203, 2207, 2213, 2221, 2237, 2239, 2243, 2251, 2267,\r\n    2269, 2273, 2281, 2287, 2293, 2297, 2309, 2311, 2333, 2339, 2341, 2347, 2351, 2357, 2371, 2377, 2381, 2383, 2389, 2393,\r\n    2399, 2411, 2417, 2423, 2437, 2441, 2447, 2459, 2467, 2473, 2477, 2503, 2521, 2531, 2539, 2543, 2549, 2551, 2557, 2579,\r\n    2591, 2593, 2609, 2617, 2621, 2633, 2647, 2657, 2659, 2663, 2671, 2677, 2683, 2687, 2689, 2693, 2699, 2707, 2711, 2713,\r\n    2719, 2729, 2731, 2741, 2749, 2753, 2767, 2777, 2789, 2791, 2797, 2801, 2803, 2819, 2833, 2837, 2843, 2851, 2857, 2861,\r\n    2879, 2887, 2897, 2903, 2909, 2917, 2927, 2939, 2953, 2957, 2963, 2969, 2971, 2999, 3001, 3011, 3019, 3023, 3037, 3041,\r\n    3049, 3061, 3067, 3079, 3083, 3089, 3109, 3119, 3121, 3137, 3163, 3167, 3169, 3181, 3187, 3191, 3203, 3209, 3217, 3221,\r\n    3229, 3251, 3253, 3257, 3259, 3271, 3299, 3301, 3307, 3313, 3319, 3323, 3329, 3331, 3343, 3347, 3359, 3361, 3371, 3373,\r\n    3389, 3391, 3407, 3413, 3433, 3449, 3457, 3461, 3463, 3467, 3469, 3491, 3499, 3511, 3517, 3527, 3529, 3533, 3539, 3541,\r\n    3547, 3557, 3559, 3571, 3581, 3583, 3593, 3607, 3613, 3617, 3623, 3631, 3637, 3643, 3659, 3671, 3673, 3677, 3691, 3697,\r\n    3701, 3709, 3719, 3727, 3733, 3739, 3761, 3767, 3769, 3779, 3793, 3797, 3803, 3821, 3823, 3833, 3847, 3851, 3853, 3863,\r\n    3877, 3881, 3889, 3907, 3911, 3917, 3919, 3923, 3929, 3931, 3943, 3947, 3967, 3989, 4001, 4003, 4007, 4013, 4019, 4021,\r\n    4027, 4049, 4051, 4057, 4073, 4079, 4091, 4093, 4099, 4111, 4127, 4129, 4133, 4139, 4153, 4157, 4159, 4177, 4201, 4211,\r\n    4217, 4219, 4229, 4231, 4241, 4243, 4253, 4259, 4261, 4271, 4273, 4283, 4289, 4297, 4327, 4337, 4339, 4349, 4357, 4363,\r\n    4373, 4391, 4397, 4409, 4421, 4423, 4441, 4447, 4451, 4457, 4463, 4481, 4483, 4493, 4507, 4513, 4517, 4519, 4523, 4547,\r\n    4549, 4561, 4567, 4583, 4591, 4597, 4603, 4621, 4637, 4639, 4643, 4649, 4651, 4657, 4663, 4673, 4679, 4691, 4703, 4721,\r\n    4723, 4729, 4733, 4751, 4759, 4783, 4787, 4789, 4793, 4799, 4801, 4813, 4817, 4831, 4861, 4871, 4877, 4889, 4903, 4909,\r\n    4919, 4931, 4933, 4937, 4943, 4951, 4957, 4967, 4969, 4973, 4987, 4993, 4999, 5003, 5009, 5011, 5021, 5023, 5039, 5051,\r\n    5059, 5077, 5081, 5087, 5099, 5101, 5107, 5113, 5119, 5147, 5153, 5167, 5171, 5179, 5189, 5197, 5209, 5227, 5231, 5233,\r\n    5237, 5261, 5273, 5279, 5281, 5297, 5303, 5309, 5323, 5333, 5347, 5351, 5381, 5387, 5393, 5399, 5407, 5413, 5417, 5419,\r\n    5431, 5437, 5441, 5443, 5449, 5471, 5477, 5479, 5483, 5501, 5503, 5507, 5519, 5521, 5527, 5531, 5557, 5563, 5569, 5573,\r\n    5581, 5591, 5623, 5639, 5641, 5647, 5651, 5653, 5657, 5659, 5669, 5683, 5689, 5693, 5701, 5711, 5717, 5737, 5741, 5743,\r\n    5749, 5779, 5783, 5791, 5801, 5807, 5813, 5821, 5827, 5839, 5843, 5849, 5851, 5857, 5861, 5867, 5869, 5879, 5881, 5897,\r\n    5903, 5923, 5927, 5939, 5953, 5981, 5987, 6007, 6011, 6029, 6037, 6043, 6047, 6053, 6067, 6073, 6079, 6089, 6091, 6101,\r\n    6113, 6121, 6131, 6133, 6143, 6151, 6163, 6173, 6197, 6199, 6203, 6211, 6217, 6221, 6229, 6247, 6257, 6263, 6269, 6271,\r\n    6277, 6287, 6299, 6301, 6311, 6317, 6323, 6329, 6337, 6343, 6353, 6359, 6361, 6367, 6373, 6379, 6389, 6397, 6421, 6427,\r\n    6449, 6451, 6469, 6473, 6481, 6491, 6521, 6529, 6547, 6551, 6553, 6563, 6569, 6571, 6577, 6581, 6599, 6607, 6619, 6637,\r\n    6653, 6659, 6661, 6673, 6679, 6689, 6691\r\n];\r\n\r\n/**\r\n * Prime factorizes `n` to positive/zero integer powers of consecutive primes.\r\n * @param n The number to factorize\r\n * @returns [a, b, c, ...] where 2^a * 3^b * 5^c * ... is the factorization of `n`,\r\n *          or null if the number contains primes that are too large.\r\n */\r\nconst primeFactorize = (n: number): number[] | null => {\r\n    const factors: number[] = [];\r\n    // note: every = forEach, but breaks when false is returned.\r\n    LIST_OF_PRIMES.every(p => {\r\n        let power = 0;\r\n\r\n        while (n % p === 0) {\r\n            power++;\r\n            n /= p;\r\n        }\r\n        factors.push(power);\r\n        return n > 1; // break if n is 1\r\n    });\r\n    if (n > 1) {\r\n        // null return if number is above 6691 prime limit.\r\n        return null;\r\n    }\r\n    return factors;\r\n}\r\n\r\n/**\r\n * Converts a (numerator, denominator) tuple to an actual relative pitch ratio float,\r\n * taking into account the `context.primesTuning`.\r\n * @param num\r\n * @param denom\r\n * @param context\r\n */\r\nconst realizeRatio = (num: number, denom: number, context: Context): number => {\r\n    const num_factors = primeFactorize(num);\r\n    const denom_factors = primeFactorize(denom);\r\n\r\n    let ratio = 1.0;\r\n\r\n    if (num_factors == null || denom_factors == null) {\r\n        console.warn(`WARN xenpaper: ratio ${num}/${denom} is too high prime-limit to factorize, ignoring context.primesTuning`);\r\n        return num / denom;\r\n    }\r\n    num_factors.forEach((power, i) => {\r\n        if (context.primesTuning.length > i) {\r\n            ratio *= Math.pow(context.primesTuning[i], power);\r\n        } else {\r\n            ratio *= Math.pow(LIST_OF_PRIMES[i], power);\r\n        }\r\n    });\r\n    denom_factors.forEach((power, i) => {\r\n        if (context.primesTuning.length > i) {\r\n            ratio /= Math.pow(context.primesTuning[i], power);\r\n        } else {\r\n            ratio /= Math.pow(LIST_OF_PRIMES[i], power);\r\n        }\r\n    });\r\n    return ratio;\r\n}\r\n\r\n/**\r\n * Converts PitchType object to pitch ratio.\r\n *\r\n * If an absolute PitchHz is specified, it is taken to be a ratio with\r\n * respect to the current value of `context.rootHz`\r\n * @param pitch The PitchType to convert\r\n * @param context global context object\r\n * @returns `pitch` as a relative ratio (float)\r\n */\r\n\r\nexport const pitchToRatio = (pitch: PitchType, context: Context): number => {\r\n    const { scale, octaveSize } = context;\r\n    limit(\"Equave size\", octaveSize, -20, 20);\r\n\r\n    const { type } = pitch.value;\r\n    const octaveMulti = Math.pow(octaveSize, pitch?.octave?.octave || 0);\r\n\r\n    if (type === \"PitchRatio\") {\r\n        const { numerator, denominator } = pitch.value as PitchRatioType;\r\n        const ratio = realizeRatio(numerator, denominator, context);\r\n        limit(\"Pitch ratio\", ratio, 0, 100);\r\n        return ratio * octaveMulti;\r\n    }\r\n\r\n    if (type === \"PitchCents\") {\r\n        const { cents } = pitch.value as PitchCentsType;\r\n        limit(\"Cents\", cents, -12000, 12000);\r\n        return centsToRatio(cents) * octaveMulti;\r\n    }\r\n\r\n    if (type === \"PitchOctaveDivision\") {\r\n        const { numerator: steps, denominator: stepsInOctave, octaveSize } =\r\n            pitch.value as PitchOctaveDivisionType;\r\n        return (\r\n            octaveDivisionToRatio(steps, stepsInOctave, octaveSize) *\r\n            octaveMulti\r\n        );\r\n    }\r\n\r\n    if (type === \"PitchDegree\") {\r\n        const { degree } = pitch.value as PitchDegreeType;\r\n        return pitchDegreeToRatio(degree, scale, octaveSize) * octaveMulti;\r\n    }\r\n\r\n    if (type === \"PitchHz\") {\r\n        const { hz } = pitch.value as PitchHzType;\r\n        limit(\"Hz\", hz, 0, 20000);\r\n        return hz / context.rootHz * octaveMulti;\r\n    }\r\n\r\n    throw new Error(`Unknown pitch type \"${type}\"`);\r\n};\r\n\r\nconst edoToRatios = (edoSize: number, octaveSize: number): number[] => {\r\n    const ratios: number[] = [];\r\n    for (let i = 0; i < edoSize; i++) {\r\n        ratios.push(octaveDivisionToRatio(i, edoSize, octaveSize));\r\n    }\r\n    return ratios;\r\n};\r\n\r\nconst pitchDegreeWrap = (degree: number, scale: number[]): [number, number] => {\r\n    limit(\"Scale degree\", degree, -1000, 1000);\r\n\r\n    const steps = scale.length;\r\n    let octave = 0;\r\n\r\n    while (degree >= steps && octave > -20) {\r\n        degree -= steps;\r\n        octave++;\r\n    }\r\n    while (degree < 0 && octave < 20) {\r\n        degree += steps;\r\n        octave--;\r\n    }\r\n\r\n    return [degree, octave];\r\n};\r\n\r\nconst pitchDegreeToRatio = (\r\n    degree: number,\r\n    scale: number[],\r\n    octaveSize: number\r\n): number => {\r\n    limit(\"Equave size\", octaveSize, -20, 20);\r\n\r\n    if (scale.length === 0) {\r\n        return 1;\r\n    }\r\n\r\n    const [wrappedDegree, octave] = pitchDegreeWrap(degree, scale);\r\n    return scale[wrappedDegree] * Math.pow(octaveSize, octave);\r\n};\r\n\r\nconst pitchToHz = (pitch: PitchType, context: Context): number => {\r\n    if (pitch.value.type === \"PitchHz\") {\r\n        const octaveMulti = Math.pow(\r\n            context.octaveSize,\r\n            pitch?.octave?.octave || 0\r\n        );\r\n        const hz = (pitch.value as PitchHzType).hz * octaveMulti;\r\n        limit(\"Hz\", hz, 0, 20000);\r\n        return hz;\r\n    }\r\n    return pitchToRatio(pitch, context) * context.rootHz;\r\n};\r\n\r\nconst tailToTime = (\r\n    tail: TailType | undefined,\r\n    context: Context\r\n): { time: number; timeEnd: number } => {\r\n    const time = context.time;\r\n\r\n    const duration =\r\n        tail && tail.type === \"Hold\" ? (tail as HoldType).length + 1 : 1;\r\n\r\n    context.time += duration * context.subdivision;\r\n    const timeEnd = context.time;\r\n\r\n    return {\r\n        time,\r\n        timeEnd,\r\n    };\r\n};\r\n\r\n//\r\n// labels\r\n//\r\n\r\nconst ratioWrap = (ratio: number, octaveSize: number): number => {\r\n    while (ratio < 1) {\r\n        ratio *= octaveSize;\r\n    }\r\n    while (ratio > octaveSize) {\r\n        ratio /= octaveSize;\r\n    }\r\n    return ratio;\r\n};\r\n\r\nconst ratioToCentsLabel = (ratio: number, octaveSize: number): string => {\r\n    return `${ratioToCents(ratioWrap(ratio, octaveSize)).toFixed(1)}c`;\r\n};\r\n\r\nexport const pitchToLabel = (pitch: PitchType, context: Context): string => {\r\n    const { type } = pitch.value;\r\n\r\n    if (type === \"PitchHz\") {\r\n        const { hz } = pitch.value as PitchHzType;\r\n        return `${hz}Hz`;\r\n    }\r\n\r\n    if (type === \"PitchCents\") {\r\n        const { cents } = pitch.value as PitchCentsType;\r\n        return `${cents}c`;\r\n    }\r\n\r\n    const centsLabel = ratioToCentsLabel(\r\n        pitchToRatio(pitch, context),\r\n        context.octaveSize\r\n    );\r\n\r\n    if (type === \"PitchRatio\") {\r\n        const { numerator, denominator } = pitch.value as PitchRatioType;\r\n        return `${numerator}/${denominator}  ${centsLabel}`;\r\n    }\r\n\r\n    if (type === \"PitchOctaveDivision\") {\r\n        const { numerator, denominator } =\r\n            pitch.value as PitchOctaveDivisionType;\r\n        return `${numerator}\\\\${denominator}  ${centsLabel}`;\r\n    }\r\n\r\n    if (type === \"PitchDegree\") {\r\n        const { degree } = pitch.value as PitchDegreeType;\r\n        const [wrappedDegree] = pitchDegreeWrap(degree, context.scale);\r\n        return context.scaleLabels[wrappedDegree];\r\n    }\r\n\r\n    throw new Error(`Unknown pitch type \"${type}\"`);\r\n};\r\n\r\nconst edoToLabels = (\r\n    edoSize: number,\r\n    ratios: number[],\r\n    octaveSize: number\r\n): string[] => {\r\n    const labels: string[] = [];\r\n    for (let i = 0; i < edoSize; i++) {\r\n        const centsLabel = ratioToCentsLabel(ratios[i], octaveSize);\r\n        labels.push(`${i}\\\\${edoSize}  ${centsLabel}`);\r\n    }\r\n    return labels;\r\n};\r\n\r\n//\r\n// converters\r\n//\r\n\r\nconst ENV_VALUES = [0, 0.003, 0.006, 0.01, 0.033, 0.1, 0.33, 1, 3.3, 10];\r\n\r\ntype Context = {\r\n    rootHz: number;\r\n    time: number;\r\n    subdivision: number;\r\n    scale: number[];\r\n    scaleLabels: string[];\r\n    octaveSize: number;\r\n    /**\r\n     * The relative tuning of each prime as a ratio of the root 1/1\r\n     * Only used when calculating freq of PitchRatios.\r\n     *\r\n     * e.g. if primesTuning == [2, 3, 5, 7, 11],\r\n     * the PitchRatio 5/4 will be rendered as per normal.\r\n     *\r\n     * However, if primesTuning == [2, 2^(18/31), 2^(41/31)],\r\n     * the PitchRatio 5/4 will be tuned to that of 31 edo.\r\n     *\r\n     * If a prime used in a PitchRatio uses a prime that is above the highest\r\n     * defined prime in the prime tuning array, it would default to the original prime value.\r\n     *\r\n     * e.g.: if primesTuning = [2, 2^(7/12)],\r\n     * the PitchRatio 5/3 will be tuned like so:\r\n     * - Down a 12edo perfect fifth and an octave\r\n     * - Up a justly tuned 5th harmonic (since the prime 5 is not defined)\r\n     */\r\n    primesTuning: number[];\r\n};\r\n\r\nconst times: [number, number][] = [];\r\n\r\nconst noteToMosc = (note: NoteType, context: Context): MoscNote[] => {\r\n    const timeProps = tailToTime(note.tail, context);\r\n\r\n    // mutate ast node to add time\r\n    const arr: [number, number] = [timeProps.time, timeProps.timeEnd];\r\n    times.push(arr);\r\n    note.time = arr;\r\n\r\n    const hz = pitchToHz(note.pitch, context);\r\n    const label = pitchToLabel(note.pitch, context);\r\n\r\n    return [\r\n        {\r\n            type: \"NOTE_TIME\",\r\n            hz,\r\n            label,\r\n            ...timeProps,\r\n        },\r\n    ];\r\n};\r\n\r\nconst chordToMosc = (\r\n    chord: ChordType | RatioChordType,\r\n    context: Context\r\n): MoscNote[] => {\r\n    const { tail, pitches } = chord;\r\n    const timeProps = tailToTime(tail, context);\r\n\r\n    // mutate ast node to add time\r\n    const arr: [number, number] = [timeProps.time, timeProps.timeEnd];\r\n    times.push(arr);\r\n    chord.time = arr;\r\n\r\n    const pitchTypes: MoscNote[] = pitches\r\n        .filter((pitch): pitch is PitchType => pitch.type === \"Pitch\")\r\n        .map((pitch: any) => {\r\n            const hz = pitchToHz(pitch as PitchType, context);\r\n            const label = pitchToLabel(pitch as PitchType, context);\r\n\r\n            return {\r\n                type: \"NOTE_TIME\",\r\n                hz,\r\n                label,\r\n                ...timeProps,\r\n            };\r\n        });\r\n\r\n    const firstRatioPitch = pitches.find(\r\n        (pitch: PitchType | RatioChordPitchType | DelimiterType) => {\r\n            return pitch.type === \"RatioChordPitch\";\r\n        }\r\n    ) as RatioChordPitchType | undefined;\r\n\r\n    const firstDenominator = (firstRatioPitch as RatioChordPitchType)?.pitch;\r\n\r\n    if (firstDenominator <= 0) {\r\n        throw new Error(`Chords cannot contain a ratio of ${firstDenominator}`);\r\n    }\r\n\r\n    const ratioPitchTypes: MoscNote[] = [];\r\n    const addRatioPitchType = (numerator: number): void => {\r\n        ratioPitchTypes.push({\r\n            type: \"NOTE_TIME\",\r\n            hz: realizeRatio(numerator, firstDenominator, context) * context.rootHz,\r\n            label: `${numerator}/${firstDenominator}  ${ratioToCentsLabel(\r\n                numerator / firstDenominator,\r\n                context.octaveSize\r\n            )}`,\r\n            ...timeProps,\r\n        });\r\n    };\r\n\r\n    let colons = 0;\r\n    let lastNumerator = 1;\r\n    pitches.forEach((pitch: any) => {\r\n        if (pitch.type === \"RatioChordPitch\") {\r\n            const numerator = (pitch as RatioChordPitchType).pitch;\r\n            if (numerator <= 0) {\r\n                throw new Error(\r\n                    `Chords cannot contain a ratio of ${numerator}`\r\n                );\r\n            }\r\n\r\n            if (colons == 2) {\r\n                while (lastNumerator < numerator - 1) {\r\n                    lastNumerator++;\r\n                    addRatioPitchType(lastNumerator);\r\n                }\r\n            }\r\n\r\n            addRatioPitchType(numerator);\r\n            lastNumerator = numerator;\r\n            colons = 0;\r\n            return;\r\n        }\r\n        if (pitch.type === \"Colon\") {\r\n            colons++;\r\n        }\r\n    });\r\n\r\n    return pitchTypes.concat(ratioPitchTypes);\r\n};\r\n\r\nconst setScale = (setScale: SetScaleType, context: Context): void => {\r\n    const { scale } = setScale;\r\n    const { type } = scale;\r\n    if (type === \"PitchGroupScale\") {\r\n        const { pitches, scaleOctaveMarker, pitchGroupScalePrefix } =\r\n            scale as PitchGroupScaleType;\r\n\r\n        let filteredPitches: PitchType[] = pitches.filter(\r\n            (pitch): pitch is PitchType => !pitch.delimiter\r\n        ) as PitchType[];\r\n\r\n        if (pitchGroupScalePrefix && pitchGroupScalePrefix.prefix === \"m\") {\r\n            const degreePitches: PitchDegreeType[] = [\r\n                {\r\n                    type: \"PitchDegree\",\r\n                    degree: 0,\r\n                    delimiter: false,\r\n                    pos: pitchGroupScalePrefix.pos,\r\n                    len: 0,\r\n                },\r\n            ];\r\n\r\n            let degree = 0;\r\n            filteredPitches.forEach((pitch) => {\r\n                if (pitch.value.type !== \"PitchDegree\") {\r\n                    throw new Error(\r\n                        \"Mode scales {m} should only contain pitch degrees (0, 1, etc), not ratios, hz or any other kind of pitch\"\r\n                    );\r\n                }\r\n                degree += (pitch.value as PitchDegreeType).degree;\r\n\r\n                degreePitches.push({\r\n                    ...pitch.value,\r\n                    degree,\r\n                });\r\n            });\r\n\r\n            degreePitches.pop(); // ignore last degree which is assumed to complete the octave\r\n            filteredPitches = degreePitches.map((value) => ({\r\n                value,\r\n            })) as PitchType[];\r\n        }\r\n\r\n        context.scale = filteredPitches.map((pitch) =>\r\n            pitchToRatio(pitch, context)\r\n        );\r\n        context.scaleLabels = filteredPitches.map((pitch) =>\r\n            pitchToLabel(pitch, context)\r\n        );\r\n\r\n        if (scaleOctaveMarker) {\r\n            context.octaveSize = context.scale.pop() || 2;\r\n            context.scaleLabels.pop();\r\n        }\r\n\r\n        return;\r\n    }\r\n\r\n    if (type === \"EdoScale\") {\r\n        const { divisions, octaveSize } = scale as EdoScaleType;\r\n        context.scale = edoToRatios(divisions, octaveSize);\r\n        context.scaleLabels = edoToLabels(divisions, context.scale, octaveSize);\r\n        context.octaveSize = octaveSize;\r\n        return;\r\n    }\r\n\r\n    if (type === \"RatioChordScale\") {\r\n        const { pitches, scaleOctaveMarker } = scale as RatioChordScaleType;\r\n\r\n        context.scale = [];\r\n        context.scaleLabels = [];\r\n\r\n        let firstDenominator = -1;\r\n        let colons = 0;\r\n        let lastNumerator = 0;\r\n\r\n        const addRatio = (numerator: number): void => {\r\n            const ratio = realizeRatio(numerator, firstDenominator, context);\r\n            context.scale.push(ratio);\r\n            const centsLabel = ratioToCentsLabel(ratio, 2);\r\n            context.scaleLabels.push(\r\n                `${numerator}/${firstDenominator}  ${centsLabel}`\r\n            );\r\n        };\r\n\r\n        pitches.forEach((pitch) => {\r\n            if (pitch.delimiter) {\r\n                colons++;\r\n                return;\r\n            }\r\n\r\n            const numerator = pitch.pitch;\r\n            if (firstDenominator === -1) {\r\n                firstDenominator = numerator;\r\n            }\r\n\r\n            if (colons === 2) {\r\n                while (lastNumerator < numerator - 1) {\r\n                    lastNumerator++;\r\n                    addRatio(lastNumerator);\r\n                }\r\n            }\r\n\r\n            addRatio(numerator);\r\n            lastNumerator = numerator;\r\n            colons = 0;\r\n        });\r\n\r\n        if (scaleOctaveMarker) {\r\n            context.octaveSize = context.scale.pop() || 2;\r\n            context.scaleLabels.pop();\r\n        }\r\n\r\n        return;\r\n    }\r\n\r\n    throw new Error(`Unknown scale type \"${type}\"`);\r\n};\r\n\r\nconst setPrimes = (setPrimes: SetPrimesType, context: Context): void => {\r\n    const { primesPitches } = setPrimes;\r\n\r\n    console.debug(setPrimes);\r\n\r\n    let filteredPitches: PitchType[] = primesPitches.filter(\r\n        (pitch): pitch is PitchType => !pitch.delimiter\r\n    ) as PitchType[];\r\n\r\n    context.primesTuning = filteredPitches.map(pitch =>\r\n        pitchToRatio(pitch, context)\r\n    );\r\n}\r\n\r\nconst setterToMosc = (setter: SetterType, context: Context): MoscItem[] => {\r\n    const { type, delimiter } = setter;\r\n\r\n    if (delimiter) return [];\r\n\r\n    if (type === \"SetBpm\") {\r\n        const { bpm } = setter as SetBpmType;\r\n        return [\r\n            {\r\n                type: \"TEMPO\",\r\n                time: context.time,\r\n                bpm,\r\n                lerp: false,\r\n            },\r\n        ];\r\n    }\r\n\r\n    if (type === \"SetBms\") {\r\n        const { bms } = setter as SetBmsType;\r\n        return [\r\n            {\r\n                type: \"TEMPO\",\r\n                time: context.time,\r\n                bpm: 60000 / bms,\r\n                lerp: false,\r\n            },\r\n        ];\r\n    }\r\n\r\n    if (type === \"SetSubdivision\") {\r\n        const { subdivision, denominator } = setter as SetSubdivisionType;\r\n        context.subdivision = (denominator ?? 1) / subdivision;\r\n        return [];\r\n    }\r\n\r\n    if (type === \"SetOsc\") {\r\n        const { osc } = setter as SetOscType;\r\n        return [\r\n            {\r\n                type: \"PARAM_TIME\",\r\n                time: context.time,\r\n                value: {\r\n                    type: \"osc\",\r\n                    osc,\r\n                },\r\n            },\r\n        ];\r\n    }\r\n\r\n    if (type === \"SetEnv\") {\r\n        const { a, d, s, r } = setter as SetEnvType;\r\n        return [\r\n            {\r\n                type: \"PARAM_TIME\",\r\n                time: context.time,\r\n                value: {\r\n                    type: \"env\",\r\n                    a: ENV_VALUES[a] || 0,\r\n                    d: ENV_VALUES[d] || 0,\r\n                    s: s / 9,\r\n                    r: ENV_VALUES[r] || 0,\r\n                },\r\n            },\r\n        ];\r\n    }\r\n\r\n    return [];\r\n};\r\n\r\nconst rulerStateCaptureRootHz = (\r\n    initial: InitialRulerState,\r\n    context: Context\r\n): InitialRulerState => {\r\n    if (initial.rootHz) {\r\n        return initial;\r\n    }\r\n    return {\r\n        ...initial,\r\n        rootHz: context.rootHz,\r\n        octaveSize: context.octaveSize,\r\n    };\r\n};\r\n\r\nexport type InitialRulerState = {\r\n    lowHz?: number;\r\n    highHz?: number;\r\n    rootHz?: number;\r\n    octaveSize?: number;\r\n    plots: MoscNoteMs[][];\r\n};\r\n\r\nconst setterToRulerState = (\r\n    initial: InitialRulerState,\r\n    setter: SetterType,\r\n    context: Context\r\n): InitialRulerState => {\r\n    const { type, delimiter } = setter;\r\n\r\n    if (delimiter) return initial;\r\n\r\n    if (type === \"SetRulerPlot\") {\r\n        const newPlot = context.scale.map(\r\n            (ratio, i): MoscNoteMs => ({\r\n                type: \"NOTE_MS\",\r\n                ms: context.time,\r\n                msEnd: context.time,\r\n                hz: ratio * context.rootHz,\r\n                label: context.scaleLabels[i],\r\n            })\r\n        );\r\n\r\n        return {\r\n            ...initial,\r\n            plots: [...initial.plots, newPlot],\r\n        };\r\n    }\r\n\r\n    if (type === \"SetRulerRange\") {\r\n        if (initial.lowHz) {\r\n            return initial;\r\n        }\r\n\r\n        const { low, high } = setter as SetRulerRangeType;\r\n        return {\r\n            ...initial,\r\n            lowHz: pitchToHz(low, context),\r\n            highHz: pitchToHz(high, context),\r\n        };\r\n    }\r\n\r\n    return initial;\r\n};\r\n\r\nexport type Processed = {\r\n    score?: MoscScore;\r\n    initialRulerState?: InitialRulerState;\r\n};\r\n\r\nexport const processGrammar = (grammar: XenpaperAST): Processed => {\r\n    // console.log('grammar', JSON.stringify(grammar));\r\n\r\n    const grammarSequence = grammar.sequence;\r\n    if (!grammarSequence) {\r\n        return {};\r\n    }\r\n\r\n    const INITIAL_TEMPO: MoscTempo = {\r\n        type: \"TEMPO\",\r\n        time: 0,\r\n        bpm: 120,\r\n        lerp: false,\r\n    };\r\n\r\n    const INITIAL_OSC: MoscParam = {\r\n        type: \"PARAM_TIME\",\r\n        time: 0,\r\n        value: {\r\n            type: \"osc\",\r\n            osc: \"triangle\",\r\n        },\r\n    };\r\n\r\n    const INITIAL_ENV: MoscParam = {\r\n        type: \"PARAM_TIME\",\r\n        time: 0,\r\n        value: {\r\n            type: \"env\",\r\n            a: ENV_VALUES[2],\r\n            d: ENV_VALUES[8],\r\n            s: 0.5,\r\n            r: ENV_VALUES[6],\r\n        },\r\n    };\r\n\r\n    const scale = edoToRatios(12, 2);\r\n\r\n    const context: Context = {\r\n        rootHz: 220,\r\n        time: 0,\r\n        subdivision: 0.5,\r\n        scale,\r\n        scaleLabels: edoToLabels(12, scale, 2),\r\n        octaveSize: 2,\r\n        primesTuning: []\r\n    };\r\n\r\n    const moscItems: MoscItem[] = [];\r\n    let initialRulerState: InitialRulerState = {\r\n        plots: [],\r\n    };\r\n\r\n    grammarSequence.items.forEach((item): void => {\r\n        const { type } = item;\r\n        if (type === \"Comment\" || type === \"BarLine\" || type === \"Whitespace\") {\r\n            // do nothing\r\n            return;\r\n        }\r\n\r\n        if (type === \"SetScale\") {\r\n            setScale(item as SetScaleType, context);\r\n            return;\r\n        }\r\n\r\n        if (type === \"SetRoot\") {\r\n            const { pitch } = item as SetRootType;\r\n            context.rootHz = pitchToHz(pitch, context);\r\n            return;\r\n        }\r\n\r\n        if (type === \"Note\") {\r\n            moscItems.push(...noteToMosc(item as NoteType, context));\r\n            initialRulerState = rulerStateCaptureRootHz(\r\n                initialRulerState,\r\n                context\r\n            );\r\n            return;\r\n        }\r\n\r\n        if (type === \"Rest\") {\r\n            const { time } = context;\r\n            const rest = item as RestType;\r\n            context.time += rest.length * context.subdivision;\r\n            // mutate ast node to add time\r\n            const arr: [number, number] = [time, context.time];\r\n            times.push(arr);\r\n            rest.time = arr;\r\n            return;\r\n        }\r\n\r\n        if (type === \"Chord\") {\r\n            moscItems.push(...chordToMosc(item as ChordType, context));\r\n            return;\r\n        }\r\n\r\n        if (type === \"RatioChord\") {\r\n            moscItems.push(...chordToMosc(item as RatioChordType, context));\r\n            initialRulerState = rulerStateCaptureRootHz(\r\n                initialRulerState,\r\n                context\r\n            );\r\n            return;\r\n        }\r\n\r\n        if (type === \"SetterGroup\") {\r\n            (item as SetterGroupType).setters.forEach((setter) => {\r\n                moscItems.push(...setterToMosc(setter, context));\r\n                initialRulerState = setterToRulerState(\r\n                    initialRulerState,\r\n                    setter,\r\n                    context\r\n                );\r\n\r\n                // SetPrimes object is part of SetterGroup\r\n                if (setter.type === \"SetPrimes\") {\r\n                    setPrimes(setter as SetPrimesType, context);\r\n                    return;\r\n                }\r\n            });\r\n            return;\r\n        }\r\n\r\n        throw new Error(`Unknown sequence item \"${type}\"`);\r\n    });\r\n\r\n    initialRulerState = rulerStateCaptureRootHz(initialRulerState, context);\r\n\r\n    const sequence = [\r\n        INITIAL_TEMPO,\r\n        INITIAL_OSC,\r\n        INITIAL_ENV,\r\n        ...moscItems,\r\n        {\r\n            type: \"END_TIME\",\r\n            time: context.time,\r\n        } as MoscEnd,\r\n    ];\r\n\r\n    // translate times from steps to ms\r\n    const thisTimeToMs = timeToMs(sequence);\r\n\r\n    // omg are we really mutating many time items throughout the AST tree via mutations? golly!\r\n    times.forEach((time) => {\r\n        time[0] = thisTimeToMs(time[0]);\r\n        time[1] = thisTimeToMs(time[1]);\r\n    });\r\n\r\n    const score = {\r\n        sequence,\r\n        lengthTime: context.time,\r\n    };\r\n\r\n    return {\r\n        score,\r\n        initialRulerState,\r\n    };\r\n};\r\n","import {useState, useCallback, useEffect} from 'react';\r\n\r\nexport const hashify = (newHash: string): string => {\r\n    return encodeURIComponent(newHash)\r\n        .replace(/_/g, '%_')\r\n        .replace(/%20/g, '_');\r\n};\r\n\r\nconst reverseString = (str: string): string => {\r\n    return str\r\n        .split('')\r\n        .reverse()\r\n        .join('');\r\n};\r\n\r\nexport const unhashify = (hash: string): string => {\r\n    return decodeURIComponent(\r\n        // browser support for negaitve lookbehinds is patchy\r\n        // and we want to replace all _ that arent preceded by % with %20\r\n        // so reverse the string, replace with a negative lookahead (well supported) and reverse again\r\n        reverseString(\r\n            reverseString(hash).replace(/_(?!%)/g, reverseString('%20'))\r\n        ).replace(/%_/g, '_')\r\n    );\r\n};\r\n\r\ntype UseHashResult = readonly [string, (newHash: string) => void];\r\n\r\nexport const useHash = (): UseHashResult => {\r\n    const [hash, setHash] = useState(() => {\r\n        let initialHash = unhashify(window.location.hash.substr(1));\r\n        if(!initialHash && window.localStorage) {\r\n            initialHash = window.localStorage.getItem('lasttune') ?? '';\r\n        }\r\n        return initialHash;\r\n    });\r\n\r\n    const onHashChange = useCallback(() => {\r\n        setHash(window.location.hash);\r\n    }, []);\r\n\r\n    useEffect(() => {\r\n        window.addEventListener('hashchange', onHashChange);\r\n        return () => {\r\n            window.removeEventListener('hashchange', onHashChange);\r\n        };\r\n    }, [onHashChange]);\r\n\r\n    const _setHash = useCallback((newHash: string) => {\r\n        const newHashEncoded = hashify(newHash);\r\n        if (newHashEncoded !== hash) {\r\n            // eslint-disable-next-line @typescript-eslint/ban-ts-comment\r\n            // @ts-ignore\r\n            window.history.replaceState(undefined, undefined, '#' + newHashEncoded);\r\n            window.localStorage?.setItem('lasttune', newHash);\r\n        }\r\n    }, [hash]);\r\n\r\n    return [hash, _setHash] as const;\r\n};\r\n","import {useState, useEffect} from 'react';\r\n\r\nconst windowLoadPromise = new Promise(resolve => {\r\n    const handleLoad = () => {\r\n        window.removeEventListener('load', handleLoad);\r\n        resolve(null);\r\n    };\r\n    window.addEventListener('load', handleLoad);\r\n});\r\n\r\nexport const useWindowLoaded = (): boolean => {\r\n\r\n    const [loaded, setLoaded] = useState(false);\r\n\r\n    useEffect(() => {\r\n        (async () => {\r\n            await windowLoadPromise;\r\n            await (document as any).fonts.ready;\r\n            setLoaded(true);\r\n        })();\r\n    }, []);\r\n\r\n    return loaded;\r\n};\r\n","import type {MoscScoreMs, MoscNoteMs, MoscItemMs, MoscParamMs, MoscEndMs} from '@xenpaper/mosc';\r\nimport {SoundEngine, scoreToMs} from '@xenpaper/mosc';\r\nimport * as Tone from 'tone';\r\n\r\n//\r\n// utils\r\n//\r\n\r\nfunction flatMap<I,O>(arr: I[], mapper: (item: I) => O[]): O[] {\r\n    const out: O[] = [];\r\n    arr.forEach(item => out.push(...mapper(item)));\r\n    return out;\r\n}\r\n\r\n//\r\n// consts\r\n//\r\n\r\nconst OSC_VOLUME = -18;\r\n\r\nexport const OSC_BASE_TYPES = [\r\n    'sine',\r\n    'sawtooth',\r\n    'square',\r\n    'triangle'\r\n];\r\n\r\nexport let OSC_PARTIAL_SUFFIXES: string[] = [];\r\nfor(let i = 1; i < 33; i++) {\r\n    OSC_PARTIAL_SUFFIXES.push(`${i}`);\r\n}\r\n\r\nexport const OSC_TYPES_EXPANDED = flatMap(OSC_BASE_TYPES, base => [\r\n    base,\r\n    `fm${base}`,\r\n    `am${base}`,\r\n    `fat${base}`\r\n]);\r\n\r\nexport const OSC_TYPES = flatMap(OSC_TYPES_EXPANDED, type => [\r\n    type,\r\n    ...OSC_PARTIAL_SUFFIXES.map(suffix => `${type}${suffix}`)\r\n]);\r\n\r\nexport class SoundEngineTonejs extends SoundEngine {\r\n\r\n    _started = false;\r\n    _endMs = 0;\r\n    _loopEndMs = 0;\r\n    _activeNoteEvents = new Set<MoscItemMs>();\r\n\r\n    synth = new Tone.PolySynth(Tone.Synth, {\r\n        oscillator: {\r\n            type: 'sine',\r\n            volume: OSC_VOLUME\r\n        },\r\n        envelope: {\r\n            attack: 0.01,\r\n            sustain: 0.5,\r\n            decay: 0.25,\r\n            release: 0.5\r\n        }\r\n    }).chain(Tone.Destination);\r\n\r\n    playing(): boolean {\r\n        return Tone.Transport.state === 'started';\r\n    }\r\n\r\n    looping(): boolean {\r\n        return Tone.Transport.loop;\r\n    }\r\n\r\n    position(): number {\r\n        return Tone.Transport.seconds * 1000;\r\n    }\r\n\r\n    endPosition(): number {\r\n        return this._endMs;\r\n    }\r\n\r\n    async start(): Promise<void> {\r\n        if(!this._started) {\r\n            await Tone.start();\r\n            this._started = true;\r\n\r\n            const onEnd = () => {\r\n                this.synth.releaseAll();\r\n                this._activeNoteEvents.forEach(noteMs => {\r\n                    this._triggerEvent('note', noteMs, false);\r\n                });\r\n                this._activeNoteEvents.clear();\r\n            };\r\n\r\n            Tone.Transport.on('stop', onEnd);\r\n            Tone.Transport.on('loop', onEnd);\r\n        }\r\n    }\r\n\r\n    async play(): Promise<void> {\r\n        await this.start();\r\n        Tone.Transport.start();\r\n    }\r\n\r\n    async pause(): Promise<void> {\r\n        await this.start();\r\n        Tone.Transport.stop();\r\n    }\r\n\r\n    async gotoMs(ms: number): Promise<void> {\r\n        Tone.Transport.seconds = ms * 0.001;\r\n    }\r\n\r\n    setLoop(loop: boolean, startMs: number = 0, endMs: number = 0): void {\r\n        this.setLoopActive(loop);\r\n        this.setLoopStart(startMs);\r\n        this.setLoopEnd(endMs);\r\n    }\r\n\r\n    setLoopActive(loop: boolean = true): void {\r\n        Tone.Transport.loop = loop;\r\n    }\r\n\r\n    setLoopStart(ms: number = 0): void {\r\n        Tone.Transport.loopStart = ms * 0.001;\r\n    }\r\n\r\n    setLoopEnd(ms: number = 0): void {\r\n        this._loopEndMs = ms;\r\n        Tone.Transport.loopEnd = (ms === 0 ? this._endMs : ms) * 0.001;\r\n    }\r\n\r\n    async setScore(scoreMs: MoscScoreMs): Promise<void> {\r\n        this.scoreMs = scoreMs;\r\n\r\n        // clear all previous notes from tone transport\r\n        Tone.Transport.cancel();\r\n\r\n        // add all new notes to tone transport\r\n        this.scoreMs.sequence.forEach((item: MoscItemMs): void => {\r\n            if(item.type === 'NOTE_MS') {\r\n                const noteMs = item as MoscNoteMs;\r\n                Tone.Transport.schedule((time: number) => {\r\n                    this.synth.triggerAttackRelease(\r\n                        noteMs.hz,\r\n                        (noteMs.msEnd * 0.001) - (noteMs.ms * 0.001),\r\n                        time\r\n                    );\r\n                    this._activeNoteEvents.add(noteMs);\r\n                    this._triggerEvent('note', noteMs, true);\r\n                }, noteMs.ms * 0.001 + 0.1); // schedule in the future slightly to avoid double note playing at end\r\n\r\n                Tone.Transport.schedule((time: number) => {\r\n                    this._activeNoteEvents.delete(noteMs);\r\n                    this._triggerEvent('note', noteMs, false);\r\n                }, noteMs.msEnd * 0.001 + 0.1);\r\n\r\n                return;\r\n            }\r\n\r\n            if(item.type === 'PARAM_MS') {\r\n                const paramMs = item as MoscParamMs;\r\n                Tone.Transport.schedule(() => {\r\n                    // this is inaccurate\r\n                    // as tonejs calls these callbacks several ms ahead of schedule\r\n                    // and relies on scheduled events to pass the provided time\r\n                    // to schedule correctly, but param changes cannot accept\r\n                    // the time argument\r\n                    if(paramMs.value.type === 'osc' && OSC_TYPES.includes(paramMs.value.osc)) {\r\n                        this.synth.set({\r\n                            oscillator: {\r\n                                type: paramMs.value.osc,\r\n                                volume: OSC_VOLUME\r\n                            }\r\n                        });\r\n                    }\r\n                    if(paramMs.value.type === 'env') {\r\n                        this.synth.set({\r\n                            envelope: {\r\n                                attack: paramMs.value.a,\r\n                                decay: paramMs.value.d,\r\n                                sustain: paramMs.value.s,\r\n                                release: paramMs.value.r\r\n                            }\r\n                        });\r\n                    }\r\n\r\n                }, paramMs.ms * 0.001);\r\n\r\n                return;\r\n            }\r\n\r\n            if(item.type === 'END_MS') {\r\n                this._endMs = (item as MoscEndMs).ms;\r\n                if(this._loopEndMs === 0) {\r\n                    this.setLoopEnd(0);\r\n                }\r\n\r\n                Tone.Transport.schedule(async () => {\r\n                    if(Tone.Transport.loop) return;\r\n\r\n                    Tone.Transport.stop();\r\n                    this._triggerEvent('end', undefined);\r\n                }, this._endMs * 0.001);\r\n\r\n                return;\r\n            }\r\n\r\n            // @ts-ignore\r\n            throw new Error(`Unexpected item type ${item.type} encountered`);\r\n        });\r\n    }\r\n}\r\n","import React, { useState, useCallback, useEffect } from \"react\";\r\nimport { AppWrapper } from \"./AppWrapper\";\r\nimport { IconToggle } from \"./component/IconToggle\";\r\nimport { Codearea } from \"./component/Codearea\";\r\nimport { ErrorMessage } from \"./component/ErrorMessage\";\r\nimport { LoaderPane } from \"./component/LoaderPane\";\r\nimport { Char } from \"./component/Char\";\r\nimport { Box, Flex } from \"./layout/Layout\";\r\nimport { Sidebar, SidebarInfo, SidebarShare, Footer } from \"./Sidebars\";\r\nimport styled from \"styled-components\";\r\n\r\nimport { PitchRuler, useRulerState } from \"./PitchRuler\";\r\nimport type { RulerState } from \"./PitchRuler\";\r\n\r\nimport { XenpaperGrammarParser } from \"./data/grammar\";\r\nimport type { XenpaperAST, SetterGroupType } from \"./data/grammar\";\r\n\r\nimport { grammarToChars } from \"./data/grammar-to-chars\";\r\nimport { processGrammar } from \"./data/process-grammar\";\r\nimport type { InitialRulerState } from \"./data/process-grammar\";\r\nimport type { MoscScore } from \"@xenpaper/mosc\";\r\nimport type { HighlightColor, CharData } from \"./data/grammar-to-chars\";\r\n\r\nimport { useHash, hashify } from \"./hooks/useHash\";\r\nimport { useWindowLoaded } from \"./hooks/useWindowLoaded\";\r\n\r\nimport { useDendriform, useInput } from \"dendriform\";\r\nimport type { Dendriform } from \"dendriform\";\r\nimport { setAutoFreeze, enableMapSet } from \"immer\";\r\nsetAutoFreeze(false); // sadly I am relying on mutations within the xenpaper AST because who cares\r\nenableMapSet();\r\n\r\nimport { scoreToMs } from \"@xenpaper/mosc\";\r\nimport type { SoundEngine } from \"@xenpaper/mosc\";\r\nimport { SoundEngineTonejs } from \"@xenpaper/sound-engine-tonejs\";\r\n\r\nimport { Helmet } from \"react-helmet\";\r\n\r\n//\r\n// sound engine instance\r\n//\r\n\r\nconst soundEngine: SoundEngine = new SoundEngineTonejs();\r\n\r\n//\r\n// xenpaper ast parsing\r\n//\r\n\r\ntype Parsed = {\r\n    parsed?: XenpaperAST;\r\n    chars?: CharData[];\r\n    score?: MoscScore;\r\n    initialRulerState?: InitialRulerState;\r\n    error: string;\r\n};\r\n\r\nconst parse = (unparsed: string): Parsed => {\r\n    try {\r\n        const parsed = XenpaperGrammarParser(unparsed);\r\n        const { score, initialRulerState } = processGrammar(parsed);\r\n        const chars = grammarToChars(parsed);\r\n\r\n        if (score) {\r\n            const scoreMs = scoreToMs(score);\r\n            soundEngine.setScore(scoreMs);\r\n        }\r\n\r\n        return {\r\n            parsed,\r\n            chars,\r\n            score,\r\n            initialRulerState,\r\n            error: \"\",\r\n        };\r\n    } catch (e) {\r\n        console.log(\"!\", e);\r\n        const matched = e.message.match(/Unexpected token at (\\d+):(\\d+)/);\r\n\r\n        const lineNumber: number = matched ? Number(matched[1]) - 1 : -1;\r\n        const colNumber: number = matched ? Number(matched[2]) - 1 : -1;\r\n\r\n        const chars: CharData[] = [];\r\n        let lineCount = 0;\r\n        let colCount = 0;\r\n        let error;\r\n        let errorAt;\r\n\r\n        for (let i = 0; i < unparsed.length + 40; i++) {\r\n            if (lineCount === lineNumber && colCount === colNumber) {\r\n                errorAt = i;\r\n            }\r\n            if (unparsed[i] === \"\\n\") {\r\n                lineCount++;\r\n                colCount = 0;\r\n            } else {\r\n                colCount++;\r\n            }\r\n        }\r\n\r\n        if (typeof errorAt === \"number\") {\r\n            error =\r\n                unparsed[errorAt] !== undefined\r\n                    ? e.message.replace(\r\n                          \"Unexpected token \",\r\n                          `Unexpected token \"${unparsed[errorAt]}\" `\r\n                      )\r\n                    : e.message;\r\n\r\n            chars[errorAt] = {\r\n                color: \"error\",\r\n            };\r\n        } else {\r\n            error = e.message;\r\n        }\r\n\r\n        return {\r\n            parsed: undefined,\r\n            chars,\r\n            score: undefined,\r\n            initialRulerState: undefined,\r\n            error,\r\n        };\r\n    }\r\n};\r\n\r\nconst getMsAtLine = (\r\n    tune: string,\r\n    chars: CharData[] | undefined,\r\n    line: number\r\n): number => {\r\n    if (line === 0) {\r\n        return 0;\r\n    }\r\n    let ms = 0;\r\n    let counted = 0;\r\n    const tuneSplit = tune.split(\"\");\r\n    for (let i = 0; i < tuneSplit.length; i++) {\r\n        const chr = tuneSplit[i];\r\n        const ch = chars?.[i];\r\n        const [, end] = ch?.playTime ?? [];\r\n        if (end !== undefined) {\r\n            ms = end;\r\n        }\r\n        if (chr === \"\\n\") {\r\n            counted++;\r\n            if (counted === line) {\r\n                return ms;\r\n            }\r\n        }\r\n    }\r\n    return 0;\r\n};\r\n\r\n//\r\n// icons\r\n//\r\n\r\nconst PLAY_PATHS = {\r\n    paused: [\"M 0 0 L 12 6 L 0 12 Z\"],\r\n    playing: [\"M 0 0 L 4 0 L 4 12 L 0 12 Z\", \"M 8 0 L 12 0 L 12 12 L 8 12 Z\"],\r\n    // stopped: ['M 0 0 L 12 0 L 12 12 L 0 12 Z'],\r\n};\r\n\r\n//\r\n// application component with loader\r\n//\r\n\r\nexport function Xenpaper(): React.ReactElement {\r\n    const loaded = useWindowLoaded();\r\n\r\n    return (\r\n        <AppWrapper>\r\n            <LoaderPane height=\"100vh\" loaded={loaded}>\r\n                <XenpaperApp loaded={loaded} />\r\n            </LoaderPane>\r\n        </AppWrapper>\r\n    );\r\n}\r\n\r\n//\r\n// application component\r\n//\r\n\r\nexport type SidebarState = \"info\" | \"share\" | \"ruler\" | \"none\";\r\n\r\n// type RealtimeState = {\r\n//     on: boolean;\r\n//     activeNotes: number[];\r\n// };\r\n\r\nexport type TuneForm = {\r\n    tune: string;\r\n    embed: boolean;\r\n    hash: string;\r\n    url: string;\r\n    urlEmbed: string;\r\n};\r\n\r\ntype Props = {\r\n    loaded: boolean;\r\n};\r\n\r\nexport function XenpaperApp(props: Props): React.ReactElement {\r\n    const { loaded } = props;\r\n\r\n    //\r\n    // dendriforms with application state\r\n    //\r\n\r\n    const [hash, setHash] = useHash();\r\n\r\n    const tuneForm = useDendriform<TuneForm>(\r\n        () => {\r\n            let embed = false;\r\n            let tune = hash;\r\n            if (tune.startsWith(\"embed:\")) {\r\n                embed = true;\r\n                tune = tune.substr(6);\r\n            }\r\n            return {\r\n                tune,\r\n                embed,\r\n                hash: \"\",\r\n                url: \"\",\r\n                urlEmbed: \"\",\r\n            };\r\n        },\r\n        { history: 300 }\r\n    );\r\n\r\n    tuneForm.useDerive((newValue) => {\r\n        let hash = newValue.tune;\r\n        const hashified = hashify(hash);\r\n\r\n        if (newValue.embed) {\r\n            hash = `embed:${hash}`;\r\n        }\r\n\r\n        const url = `https://xenpaper.com/#${hashified}`;\r\n        const urlEmbed = `https://xenpaper.com/#embed:${hashified}`;\r\n\r\n        tuneForm.branch(\"hash\").set(hash);\r\n        tuneForm.branch(\"url\").set(url);\r\n        tuneForm.branch(\"urlEmbed\").set(urlEmbed);\r\n    });\r\n\r\n    tuneForm.branch(\"hash\").useChange((hash) => {\r\n        setHash(hash);\r\n    });\r\n\r\n    const parsedForm = useDendriform<Parsed>(() => parse(tuneForm.value.tune));\r\n\r\n    tuneForm.useDerive((value) => {\r\n        parsedForm.set(parse(value.tune));\r\n    });\r\n\r\n    //\r\n    // state syncing between sound engine and react\r\n    //\r\n\r\n    const playing = useDendriform<boolean>(false);\r\n    const selectedLine = useDendriform<number>(0);\r\n    selectedLine.useChange((line) => {\r\n        soundEngine.setLoopStart(\r\n            getMsAtLine(tuneForm.value.tune, parsedForm.value.chars, line)\r\n        );\r\n    });\r\n\r\n    useEffect(() => {\r\n        return soundEngine.onEnd(() => {\r\n            playing.set(false);\r\n        });\r\n    }, []);\r\n\r\n    const looping = useDendriform<boolean>(false);\r\n\r\n    //\r\n    // ruler state\r\n    //\r\n\r\n    const rulerState = useRulerState(parsedForm.value.initialRulerState);\r\n\r\n    useEffect(() => {\r\n        return soundEngine.onNote((note, on) => {\r\n            const id = `${note.ms}-${note.hz}`;\r\n            rulerState.set((draft) => {\r\n                if (on) {\r\n                    draft.notesActive.set(id, note);\r\n                    draft.notes.set(id, note);\r\n                } else {\r\n                    draft.notesActive.delete(id);\r\n                }\r\n            });\r\n        });\r\n    }, []);\r\n\r\n    parsedForm.branch(\"initialRulerState\").useChange((initialRulerState) => {\r\n        rulerState.set((draft) => {\r\n            draft.rootHz = initialRulerState?.rootHz;\r\n            draft.octaveSize = initialRulerState?.octaveSize;\r\n            draft.plots = initialRulerState?.plots;\r\n            if (draft.colourMode.startsWith(\"proxplot\")) {\r\n                const index = Number(draft.colourMode.replace(\"proxplot\", \"\"));\r\n                if (index >= (draft.plots ?? []).length) {\r\n                    draft.colourMode = \"gradient\";\r\n                }\r\n            }\r\n        });\r\n    });\r\n\r\n    //\r\n    // sound engine callbacks\r\n    //\r\n\r\n    const handleSetPlayback = useCallback((play: boolean) => {\r\n        if (parsedForm.value.error) return;\r\n\r\n        soundEngine.gotoMs(\r\n            getMsAtLine(\r\n                tuneForm.value.tune,\r\n                parsedForm.value.chars,\r\n                selectedLine.value\r\n            )\r\n        );\r\n\r\n        playing.set(play);\r\n\r\n        if (play) {\r\n            soundEngine.play();\r\n            rulerState.set((draft) => {\r\n                draft.notes.clear();\r\n            });\r\n        } else {\r\n            soundEngine.pause();\r\n        }\r\n    }, []);\r\n\r\n    const handleTogglePlayback = useCallback((state: string) => {\r\n        handleSetPlayback(state === \"paused\");\r\n    }, []);\r\n\r\n    const handleToggleLoop = useCallback(() => {\r\n        const newValue = !looping.value;\r\n        looping.set(newValue);\r\n        soundEngine.setLoopActive(newValue);\r\n    }, []);\r\n\r\n    //\r\n    // special key combos\r\n    //\r\n\r\n    useEffect(() => {\r\n        const callback = (event: KeyboardEvent) => {\r\n            if ((event.ctrlKey || event.metaKey) && event.keyCode === 13) {\r\n                handleSetPlayback(playing.value);\r\n            }\r\n            if ((event.ctrlKey || event.metaKey) && event.keyCode === 90) {\r\n                event.preventDefault();\r\n                if (event.shiftKey) {\r\n                    tuneForm.redo();\r\n                } else {\r\n                    tuneForm.undo();\r\n                }\r\n            }\r\n        };\r\n\r\n        document.addEventListener(\"keydown\", callback);\r\n        return () => document.removeEventListener(\"keydown\", callback);\r\n    }, []);\r\n\r\n    //\r\n    // sidebar state\r\n    //\r\n\r\n    const [sidebarState, setSidebar] = useState<SidebarState>(() => {\r\n        return parsedForm.value?.initialRulerState?.lowHz ? \"ruler\" : \"info\";\r\n    });\r\n\r\n    const toggleSidebarInfo = useCallback(() => {\r\n        setSidebar((s) => (s !== \"info\" ? \"info\" : \"none\"));\r\n    }, []);\r\n\r\n    const toggleSidebarShare = useCallback(() => {\r\n        setSidebar((s) => (s !== \"share\" ? \"share\" : \"none\"));\r\n    }, []);\r\n\r\n    const toggleSidebarRuler = useCallback(() => {\r\n        setSidebar((s) => (s !== \"ruler\" ? \"ruler\" : \"none\"));\r\n    }, []);\r\n\r\n    const onSetTune = useCallback(async (tune: string): Promise<void> => {\r\n        tuneForm.branch(\"tune\").set(tune);\r\n        await soundEngine.gotoMs(0);\r\n        handleSetPlayback(true);\r\n    }, []);\r\n\r\n    const codepaneContainerProps = {};\r\n\r\n    //\r\n    // elements\r\n    //\r\n\r\n    const playPause = playing.render(\r\n        (form) => {\r\n            return (\r\n                <IconToggle\r\n                    state={form.useValue() ? \"playing\" : \"paused\"}\r\n                    paths={PLAY_PATHS}\r\n                    onClick={handleTogglePlayback}\r\n                    loaded={loaded}\r\n                    hoverBackground\r\n                    large={!tuneForm.branch(\"embed\").useValue()}\r\n                />\r\n            );\r\n        },\r\n        [loaded]\r\n    );\r\n\r\n    const undoRedo = tuneForm.render((form) => {\r\n        const { canUndo, canRedo } = form.useHistory();\r\n        return (\r\n            <>\r\n                <SideButton onClick={form.undo} disabled={!canUndo}>\r\n                    Undo\r\n                </SideButton>\r\n                <SideButton onClick={form.redo} disabled={!canRedo}>\r\n                    Redo\r\n                </SideButton>\r\n            </>\r\n        );\r\n    });\r\n\r\n    const loop = looping.render((looping) => {\r\n        return (\r\n            <SideButton onClick={handleToggleLoop} active={looping.useValue()}>\r\n                Loop\r\n            </SideButton>\r\n        );\r\n    });\r\n\r\n    const sidebarToggles = (\r\n        <>\r\n            <SideButton onClick={toggleSidebarInfo}>Info</SideButton>\r\n            <SideButton onClick={toggleSidebarShare}>Share</SideButton>\r\n            <SideButton onClick={toggleSidebarRuler}>Ruler</SideButton>\r\n        </>\r\n    );\r\n\r\n    const sidebar = (\r\n        <>\r\n            {sidebarState === \"info\" && (\r\n                <SidebarInfo onSetTune={onSetTune} setSidebar={setSidebar} />\r\n            )}\r\n            {sidebarState === \"share\" &&\r\n                tuneForm.render((form) => {\r\n                    const url = form.branch(\"url\").useValue();\r\n                    const urlEmbed = form.branch(\"urlEmbed\").useValue();\r\n                    return (\r\n                        <SidebarShare\r\n                            setSidebar={setSidebar}\r\n                            url={url}\r\n                            urlEmbed={urlEmbed}\r\n                        />\r\n                    );\r\n                })}\r\n            {sidebarState === \"ruler\" && (\r\n                <Sidebar\r\n                    setSidebar={setSidebar}\r\n                    title=\"Pitch ruler\"\r\n                    desc=\"Click and drag to pan, use mousewheel to zoom.\"\r\n                    wide\r\n                >\r\n                    <PitchRuler rulerState={rulerState} />\r\n                </Sidebar>\r\n            )}\r\n        </>\r\n    );\r\n\r\n    const code = (\r\n        <CodePanel\r\n            tuneForm={tuneForm}\r\n            parsedForm={parsedForm}\r\n            selectedLine={selectedLine}\r\n        />\r\n    );\r\n\r\n    const htmlTitle = <SetHtmlTitle tuneForm={tuneForm} />;\r\n\r\n    const openOnXenpaper = tuneForm.render(\"url\", (form) => (\r\n        <EditOnXenpaperButton href={form.useValue()} target=\"_blank\">\r\n            Edit on Xenpaper\r\n        </EditOnXenpaperButton>\r\n    ));\r\n\r\n    const embedLayout = tuneForm.branch(\"embed\").useValue();\r\n\r\n    if (embedLayout) {\r\n        return (\r\n            <EmbedLayout\r\n                playPause={playPause}\r\n                loop={loop}\r\n                code={code}\r\n                openOnXenpaper={openOnXenpaper}\r\n                htmlTitle={htmlTitle}\r\n                codepaneContainerProps={codepaneContainerProps}\r\n            />\r\n        );\r\n    }\r\n\r\n    return (\r\n        <NormalLayout\r\n            playPause={playPause}\r\n            undoRedo={undoRedo}\r\n            loop={loop}\r\n            code={code}\r\n            htmlTitle={htmlTitle}\r\n            sidebarToggles={sidebarToggles}\r\n            sidebar={sidebar}\r\n            codepaneContainerProps={codepaneContainerProps}\r\n        />\r\n    );\r\n}\r\n\r\n//\r\n// layouts\r\n//\r\n\r\ntype NormalLayoutProps = {\r\n    playPause: React.ReactNode;\r\n    undoRedo: React.ReactNode;\r\n    loop: React.ReactNode;\r\n    code: React.ReactNode;\r\n    htmlTitle: React.ReactNode;\r\n    sidebarToggles: React.ReactNode;\r\n    sidebar: React.ReactNode;\r\n    codepaneContainerProps: { [prop: string]: unknown };\r\n};\r\n\r\nfunction NormalLayout(props: NormalLayoutProps): React.ReactElement {\r\n    const {\r\n        playPause,\r\n        undoRedo,\r\n        loop,\r\n        code,\r\n        htmlTitle,\r\n        sidebarToggles,\r\n        sidebar,\r\n        codepaneContainerProps,\r\n    } = props;\r\n\r\n    return (\r\n        <Flex height=\"100vh\" flexDirection=\"column\">\r\n            <Flex\r\n                display={[\"block\", \"flex\"]}\r\n                flexGrow=\"1\"\r\n                flexShrink=\"1\"\r\n                minHeight=\"0\"\r\n                position=\"relative\"\r\n            >\r\n                {/* toolbar on mobile */}\r\n                <Toolbar\r\n                    display={[\"flex\", \"none\"]}\r\n                    position=\"fixed\"\r\n                    top={0}\r\n                    width=\"100%\"\r\n                >\r\n                    {playPause}\r\n                    {undoRedo}\r\n                    {loop}\r\n                </Toolbar>\r\n                {/* toolbar on desktop */}\r\n                <Toolbar display={[\"none\", \"block\"]} mt={4} px={2} pt=\"12px\">\r\n                    <Box mb={3}>{playPause}</Box>\r\n                    {undoRedo}\r\n                    {loop}\r\n                    <Hr my={2} />\r\n                    {sidebarToggles}\r\n                </Toolbar>\r\n                {/* codepane */}\r\n                <Box\r\n                    flexGrow=\"1\"\r\n                    flexShrink=\"1\"\r\n                    pl={[0, 3]}\r\n                    overflow=\"auto\"\r\n                    mt={3}\r\n                    pt={[\"24px\", 3]}\r\n                    {...codepaneContainerProps}\r\n                >\r\n                    {code}\r\n                </Box>\r\n                {/* horizontal rule on mobile */}\r\n                <Hr display={[\"block\", \"none\"]} mt={4} />\r\n                {/* more tool buttons on mobile */}\r\n                <Box display={[\"flex\", \"none\"]}>{sidebarToggles}</Box>\r\n                {/* sidebars */}\r\n                {sidebar}\r\n            </Flex>\r\n            <Footer display={[\"none\", \"none\", \"block\"]} />\r\n            {htmlTitle}\r\n        </Flex>\r\n    );\r\n}\r\n\r\ntype EmbedLayoutProps = {\r\n    playPause: React.ReactNode;\r\n    loop: React.ReactNode;\r\n    code: React.ReactNode;\r\n    openOnXenpaper: React.ReactNode;\r\n    htmlTitle: React.ReactNode;\r\n    codepaneContainerProps: { [prop: string]: unknown };\r\n};\r\n\r\nfunction EmbedLayout(props: EmbedLayoutProps): React.ReactElement {\r\n    const {\r\n        playPause,\r\n        loop,\r\n        code,\r\n        htmlTitle,\r\n        openOnXenpaper,\r\n        codepaneContainerProps,\r\n    } = props;\r\n\r\n    return (\r\n        <Flex height=\"100vh\" flexDirection=\"column\">\r\n            <Flex flexGrow=\"1\" flexShrink=\"1\" minHeight=\"0\" position=\"relative\">\r\n                <Toolbar display=\"flex\" position=\"fixed\" top={0} width=\"100%\">\r\n                    {playPause}\r\n                    {loop}\r\n                    {openOnXenpaper}\r\n                </Toolbar>\r\n                <Box\r\n                    flexGrow=\"1\"\r\n                    flexShrink=\"1\"\r\n                    overflow=\"auto\"\r\n                    mt={3}\r\n                    pt=\"24px\"\r\n                    {...codepaneContainerProps}\r\n                >\r\n                    {code}\r\n                </Box>\r\n            </Flex>\r\n            {htmlTitle}\r\n        </Flex>\r\n    );\r\n}\r\n\r\n//\r\n// codepanel\r\n//\r\n\r\ntype CodePanelProps = {\r\n    tuneForm: Dendriform<TuneForm>;\r\n    parsedForm: Dendriform<Parsed>;\r\n    selectedLine: Dendriform<number>;\r\n};\r\n\r\nfunction CodePanel(props: CodePanelProps): React.ReactElement {\r\n    return props.tuneForm.render((form) => {\r\n        const embed = form.branch(\"embed\").useValue();\r\n\r\n        // get dendriform state values\r\n        const { chars, error } = props.parsedForm.useValue();\r\n\r\n        // use value with a 200ms debounce for perf reasons\r\n        // this debounce does cause the code value to progress forward\r\n        // without the calculated syntax highlighting\r\n        // so colours will be momentarily skew-whiff\r\n        // but thats better than parsing the xenpaper AST at every keystroke\r\n        const inputProps = useInput(form.branch(\"tune\"), 200);\r\n        const tuneChars: string[] = inputProps.value.split(\"\");\r\n        const charDataArray: (CharData | undefined)[] = tuneChars.map(\r\n            (chr, index) => chars?.[index]\r\n        );\r\n\r\n        const hasPlayStartButtons = tuneChars.some((ch) => ch === \"\\n\");\r\n        let playStartLine = 0;\r\n\r\n        const charElements: React.ReactNode[] = [];\r\n\r\n        const createPlayStart = () => {\r\n            charElements.push(\r\n                <PlayStart\r\n                    key={`playstart${playStartLine}`}\r\n                    line={playStartLine++}\r\n                    selectedLine={props.selectedLine}\r\n                />\r\n            );\r\n        };\r\n\r\n        if (hasPlayStartButtons) {\r\n            createPlayStart();\r\n        }\r\n        charDataArray.forEach((charData, index) => {\r\n            const ch = tuneChars[index];\r\n\r\n            charElements.push(\r\n                <Char\r\n                    key={index}\r\n                    ch={ch}\r\n                    charData={charData}\r\n                    soundEngine={soundEngine}\r\n                />\r\n            );\r\n\r\n            if (ch === \"\\n\") {\r\n                createPlayStart();\r\n            }\r\n        });\r\n\r\n        // stop event propagation here so we can detect clicks outside of this element in isolation\r\n        const stopPropagation = (e: Event) => e.stopPropagation();\r\n\r\n        return (\r\n            <Box onClick={stopPropagation}>\r\n                <Codearea\r\n                    {...inputProps}\r\n                    charElements={charElements}\r\n                    freeze={embed}\r\n                />\r\n                {error && (\r\n                    <Box>\r\n                        <ErrorMessage>Error: {error}</ErrorMessage>\r\n                    </Box>\r\n                )}\r\n            </Box>\r\n        );\r\n    });\r\n}\r\n\r\n//\r\n// html title\r\n//\r\n\r\ntype SetHtmlTitleProps = {\r\n    tuneForm: Dendriform<TuneForm>;\r\n};\r\n\r\nfunction SetHtmlTitle(props: SetHtmlTitleProps): React.ReactElement {\r\n    return props.tuneForm.render(\"tune\", (form) => {\r\n        const tune = form.useValue();\r\n        // set title based on code in text area\r\n        const titleLimit = 20;\r\n        const title =\r\n            tune.length === 0\r\n                ? \"Xenpaper\"\r\n                : tune.length > titleLimit\r\n                ? `Xenpaper: ${tune.slice(0, titleLimit)}...`\r\n                : `Xenpaper: ${tune}`;\r\n\r\n        return (\r\n            <Helmet>\r\n                <title>{title}</title>\r\n                <meta property=\"og:title\" content={title} />\r\n            </Helmet>\r\n        );\r\n    });\r\n}\r\n\r\n//\r\n//\r\n// styled components\r\n//\r\n\r\nconst Toolbar = styled(Box)`\r\n    background-color: ${(props) => props.theme.colors.background.normal};\r\n    z-index: 4;\r\n`;\r\n\r\nconst Hr = styled(Box)`\r\n    border-top: 1px ${(props) => props.theme.colors.background.light} solid;\r\n`;\r\n\r\ntype SideButtonProps = {\r\n    active?: boolean;\r\n    multiline?: boolean;\r\n};\r\n\r\nconst SideButton = styled.button<SideButtonProps>`\r\n    border: none;\r\n    display: block;\r\n    padding: ${(props) => (props.multiline ? \".5rem\" : \"1rem .5rem\")};\r\n    cursor: ${(props) => (props.disabled ? \"default\" : \"pointer\")};\r\n    background-color: ${(props) =>\r\n        props.active\r\n            ? props.theme.colors.text.placeholder\r\n            : props.theme.colors.background.normal};\r\n    color: ${(props) =>\r\n        props.disabled\r\n            ? props.theme.colors.highlights.unknown\r\n            : props.active\r\n            ? props.theme.colors.background.normal\r\n            : props.theme.colors.highlights.comment};\r\n    position: relative;\r\n    outline: none;\r\n    font-family: ${(props) => props.theme.fonts.mono};\r\n    font-size: ${(props) => (props.multiline ? \"0.8rem\" : \"0.9rem\")};\r\n    text-align: center;\r\n    width: auto;\r\n    text-transform: uppercase;\r\n    border-left: 3px solid transparent;\r\n    ${(props) => props.multiline && `line-height: 1em;`}\r\n\r\n    ${(props) =>\r\n        !props.active\r\n            ? `&:hover, &:focus, &:active {\r\n        background-color: ${props.theme.colors.background.light};\r\n    }`\r\n            : ``}\r\n\r\n    @media all and (min-width: ${(props) => props.theme.widths.sm}) {\r\n        padding: 0.5rem;\r\n        font-size: ${(props) => (props.multiline ? \"0.9rem\" : \"1.1rem\")};\r\n        width: 5rem;\r\n    }\r\n`;\r\n\r\ntype EditOnXenpaperButtonProps = {\r\n    multiline?: boolean;\r\n};\r\n\r\nconst EditOnXenpaperButton = styled.a<EditOnXenpaperButtonProps>`\r\n    border: none;\r\n    height: 3rem;\r\n    line-height: 1rem;\r\n    display: block;\r\n    padding: ${(props) => (props.multiline ? \".5rem\" : \"1rem .5rem\")};\r\n    cursor: pointer;\r\n    background-color: ${(props) => props.theme.colors.background.normal};\r\n    color: ${(props) => props.theme.colors.highlights.comment};\r\n    position: relative;\r\n    outline: none;\r\n    font-family: ${(props) => props.theme.fonts.mono};\r\n    font-size: ${(props) => (props.multiline ? \"0.8rem\" : \"0.9rem\")};\r\n    text-align: center;\r\n    width: auto;\r\n    text-transform: uppercase;\r\n    border-left: 3px solid transparent;\r\n    ${(props) => props.multiline && `line-height: 1em;`}\r\n    text-decoration: none;\r\n\r\n    &:hover,\r\n    &:focus,\r\n    &:active {\r\n        background-color: ${(props) => props.theme.colors.background.light};\r\n        text-decoration: none;\r\n    }\r\n\r\n    margin-left: auto;\r\n\r\n    @media all and (min-width: ${(props) => props.theme.widths.sm}) {\r\n        font-size: ${(props) => (props.multiline ? \"0.9rem\" : \"1.1rem\")};\r\n    }\r\n`;\r\n\r\ntype PlayStartProps = {\r\n    line: number;\r\n    selectedLine: Dendriform<number>;\r\n};\r\n\r\nconst PlayStart = styled(({ line, selectedLine, ...props }: PlayStartProps) => {\r\n    const onClick = () => selectedLine.set(line);\r\n    return (\r\n        <span {...props} onClick={onClick}>\r\n            {\">\"}\r\n        </span>\r\n    );\r\n})`\r\n    position: absolute;\r\n    left: 0.8rem;\r\n    border: none;\r\n    display: block;\r\n    cursor: pointer;\r\n    color: ${(props) => props.theme.colors.text.placeholder};\r\n    outline: none;\r\n    opacity: ${(props) =>\r\n        props.selectedLine.useValue() === props.line ? \"1\" : \".2\"};\r\n    pointer-events: auto;\r\n\r\n    transition: opacity 0.2s ease-out;\r\n\r\n    &:hover,\r\n    &:focus,\r\n    &:active {\r\n        opacity: 1;\r\n    }\r\n`;\r\n","import { ReportHandler } from 'web-vitals';\r\n\r\nconst reportWebVitals = (onPerfEntry?: ReportHandler) => {\r\n  if (onPerfEntry && onPerfEntry instanceof Function) {\r\n    import('web-vitals').then(({ getCLS, getFID, getFCP, getLCP, getTTFB }) => {\r\n      getCLS(onPerfEntry);\r\n      getFID(onPerfEntry);\r\n      getFCP(onPerfEntry);\r\n      getLCP(onPerfEntry);\r\n      getTTFB(onPerfEntry);\r\n    });\r\n  }\r\n};\r\n\r\nexport default reportWebVitals;\r\n","import React from 'react';\r\nimport ReactDOM from 'react-dom';\r\nimport {Xenpaper} from '@xenpaper/xenpaper-ui';\r\nimport reportWebVitals from './reportWebVitals';\r\n\r\nReactDOM.render(\r\n  <React.StrictMode>\r\n    <Xenpaper />\r\n  </React.StrictMode>,\r\n  document.getElementById('root')\r\n);\r\n\r\n// If you want to start measuring performance in your app, pass a function\r\n// to log results (for example: reportWebVitals(console.log))\r\n// or send to an analytics endpoint. Learn more: https://bit.ly/CRA-vitals\r\nreportWebVitals();\r\n"],"sourceRoot":""}